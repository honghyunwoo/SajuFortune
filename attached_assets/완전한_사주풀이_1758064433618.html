<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사주 분석 - 전문 사주 풀이</title>

    <!-- 브라우저 호환성 지원 -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!--[if lt IE 9]>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
        /* CSS 변수 정의 */
        :root {
            --primary-color: #1976D2;
            --secondary-color: #42A5F5;
            --light-gray: #F5F5F5;
            --medium-gray: #757575;
            --warning-color: #FF9800;
            --dark-gray: #424242;
            --success-color: #4CAF50;
            --error-color: #F44336;
        }

        /* 구형 브라우저를 위한 CSS 변수 대체 */
        .main-container {
            background-color: #F5F5F5; /* var(--light-gray) 대체 */
        }

        .calculate-btn, .gender-option.selected, .calendar-option.selected {
            background-color: #1976D2; /* var(--primary-color) 대체 */
            color: white;
        }

        .calculate-btn:hover {
            background-color: #1565C0; /* primary-color 어두운 버전 */
        }

        input, select, textarea {
            border: 1px solid #757575; /* var(--medium-gray) 대체 */
        }

        input:focus, select:focus, textarea:focus {
            border-color: #1976D2; /* var(--primary-color) 대체 */
        }

        .error {
            color: #F44336; /* var(--error-color) 대체 */
        }

        .success {
            color: #4CAF50; /* var(--success-color) 대체 */
        }

        .warning {
            color: #FF9800; /* var(--warning-color) 대체 */
        }

        /* 기본 레이아웃 스타일 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        /* 원본 스타일 보완 */
        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 0;
            min-height: 700px;
        }

        .input-section {
            background: var(--light-gray);
            padding: 30px;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            max-height: 800px;
        }

        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .time-precision-toggle {
            margin-top: 10px;
            padding: 8px 15px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .time-precision-toggle:hover {
            background: #29b6f6;
        }

        .seconds-input {
            display: none;
        }

        .seconds-input.active {
            display: block;
            margin-top: 10px;
        }

        .calendar-toggle {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .calendar-option {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            font-weight: 600;
        }

        .calendar-option:hover {
            border-color: var(--secondary-color);
        }

        .calendar-option.selected {
            background: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .gender-select {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .gender-option {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .gender-option:hover {
            border-color: var(--secondary-color);
        }

        .gender-option.selected {
            background: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .advanced-options {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid var(--light-gray);
        }

        .advanced-options h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .calculate-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--secondary-color), #ff8f00);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
            position: relative;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 111, 0, 0.3);
        }

        .calculate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .info-message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 12px;
            line-height: 1.6;
        }

        .info-message.info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #2196f3;
        }

        .info-message.warning {
            background: #fff3e0;
            color: #f57c00;
            border-left: 4px solid #ff9800;
        }

        .info-message.error {
            background: #ffebee;
            color: #d32f2f;
            border-left: 4px solid #f44336;
        }

        .result-section {
            padding: 30px;
            overflow-y: auto;
            max-height: 800px;
        }

        .result-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            color: var(--medium-gray);
        }

        /* 버튼 및 입력 필드 스타일 */
        .calculate-btn {
            background: linear-gradient(135deg, var(--secondary-color), #29b6f6);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(66, 165, 245, 0.3);
            width: 100%;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 165, 245, 0.4);
        }

        input, select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            width: 100%;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(66, 165, 245, 0.1);
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-gray);
        }

        /* 반응형 디자인 - 완전히 새로운 구현 */
        /* 태블릿 (1024px 이하) */
        @media (max-width: 1024px) {
            .container {
                max-width: 100%;
                padding: 15px;
            }

            .main-content {
                grid-template-columns: 350px 1fr;
                gap: 0;
            }

            .input-section {
                padding: 20px;
            }

            .header h1 {
                font-size: 2.2em;
            }
        }

        /* 태블릿 세로/모바일 가로 (768px 이하) */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                padding: 20px 0;
                margin-bottom: 20px;
            }

            .header h1 {
                font-size: 1.8em;
                margin-bottom: 8px;
            }

            .subtitle {
                font-size: 1em;
            }

            .main-content {
                grid-template-columns: 1fr;
                gap: 0;
                min-height: auto;
            }

            .input-section {
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
                max-height: none;
                padding: 20px;
            }

            .results-section {
                padding: 20px;
                min-height: 300px;
            }

            .time-inputs {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .calendar-toggle {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .gender-toggle {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .calculate-btn {
                padding: 15px 30px;
                font-size: 1.1em;
            }
        }

        /* 모바일 세로 (480px 이하) */
        @media (max-width: 480px) {
            .container {
                padding: 8px;
            }

            .header {
                padding: 15px 0;
                margin-bottom: 15px;
            }

            .header h1 {
                font-size: 1.5em;
                margin-bottom: 5px;
            }

            .subtitle {
                font-size: 0.9em;
            }

            .input-section {
                padding: 15px;
            }

            .results-section {
                padding: 15px;
            }

            .form-group label {
                font-size: 0.95em;
            }

            .form-group input,
            .form-group select {
                padding: 12px;
                font-size: 0.95em;
            }

            .time-inputs {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .calendar-toggle {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .calendar-option {
                padding: 10px;
                font-size: 0.9em;
            }

            .gender-toggle {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .gender-option {
                padding: 10px;
                font-size: 0.9em;
            }

            .calculate-btn {
                padding: 12px 25px;
                font-size: 1em;
                width: 100%;
            }

            .time-precision-toggle {
                width: 100%;
                padding: 10px;
                font-size: 0.9em;
            }

            /* 결과 섹션 모바일 최적화 */
            .result-section {
                margin-bottom: 20px;
                padding: 15px;
            }

            .result-section h3 {
                font-size: 1.1em;
                margin-bottom: 10px;
            }

            /* 사주 팔자 테이블 모바일 최적화 */
            .saju-table {
                font-size: 0.8em;
            }

            .saju-table th,
            .saju-table td {
                padding: 8px 4px;
            }

            /* 분석 결과 모바일 최적화 */
            .analysis-item {
                padding: 10px;
                margin-bottom: 10px;
            }
        }

        /* 매우 작은 화면 (320px 이하) */
        @media (max-width: 320px) {
            .container {
                padding: 5px;
            }

            .header h1 {
                font-size: 1.3em;
            }

            .input-section,
            .results-section {
                padding: 12px;
            }

            .form-group input,
            .form-group select {
                padding: 10px;
                font-size: 0.9em;
            }

            .calculate-btn {
                padding: 10px 20px;
                font-size: 0.95em;
            }

            .saju-table {
                font-size: 0.75em;
            }

            .saju-table th,
            .saju-table td {
                padding: 6px 2px;
            }
        }

        /* 가로 모드 최적화 */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                padding: 10px 0;
                margin-bottom: 10px;
            }

            .header h1 {
                font-size: 1.3em;
                margin-bottom: 3px;
            }

            .subtitle {
                font-size: 0.8em;
            }

            .input-section {
                padding: 15px;
                max-height: 400px;
                overflow-y: auto;
            }

            .results-section {
                padding: 15px;
                max-height: 400px;
                overflow-y: auto;
            }
        }

        /* 터치 디바이스 최적화 */
        @media (hover: none) and (pointer: coarse) {
            .calendar-option,
            .gender-option {
                padding: 15px;
                min-height: 44px;
            }

            .calculate-btn {
                min-height: 44px;
                touch-action: manipulation;
            }

            .time-precision-toggle {
                min-height: 44px;
                touch-action: manipulation;
            }

            /* 호버 효과를 탭 효과로 변경 */
            .calendar-option:active,
            .gender-option:active {
                background-color: var(--secondary-color);
                color: white;
                transform: scale(0.98);
            }

            .calculate-btn:active {
                transform: scale(0.98);
            }
        }

        /* 유틸리티 클래스 - 반응형 도우미 */
        .mobile-only {
            display: none !important;
        }

        .desktop-only {
            display: block;
        }

        @media (max-width: 768px) {
            .mobile-only {
                display: block !important;
            }

            .desktop-only {
                display: none !important;
            }
        }

        /* 프린트 스타일 - 결과 출력용 */
        @media print {
            .input-section {
                display: none;
            }

            .main-content {
                grid-template-columns: 1fr;
            }

            .header {
                background: none !important;
                color: #333 !important;
                box-shadow: none;
                border-bottom: 2px solid #333;
            }

            .results-section {
                max-height: none;
                overflow: visible;
            }

            .result-section {
                page-break-inside: avoid;
                margin-bottom: 20px;
            }

            .saju-table {
                border: 1px solid #333;
            }

            .saju-table th,
            .saju-table td {
                border: 1px solid #333;
            }
        }

        /* 접근성 개선 */
        @media (prefers-reduced-motion: reduce) {
            * {
                transition-duration: 0.01ms !important;
                animation-duration: 0.01ms !important;
            }
        }

        /* 고대비 모드 지원 */
        @media (prefers-contrast: high) {
            .calendar-option,
            .gender-option {
                border-width: 3px;
            }

            .calculate-btn {
                background: #000 !important;
                color: #fff !important;
            }

            .result-section {
                border: 2px solid #000;
            }
        }

        /* 로딩 상태 및 진행 표시 - 완전한 UX 구현 */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
        }

        /* 로딩 스피너 애니메이션 */
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e3f2fd;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 진행 바 */
        .progress-container {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg,
                transparent 25%,
                rgba(255,255,255,0.3) 25%,
                rgba(255,255,255,0.3) 50%,
                transparent 50%,
                transparent 75%,
                rgba(255,255,255,0.3) 75%);
            background-size: 20px 20px;
            animation: move 1s linear infinite;
        }

        @keyframes move {
            0% { transform: translateX(-20px); }
            100% { transform: translateX(20px); }
        }

        /* 진행 단계 텍스트 */
        .loading-text {
            font-size: 16px;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .loading-steps {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }

        .loading-step {
            padding: 5px 0;
            transition: all 0.3s ease;
        }

        .loading-step.active {
            color: var(--primary-color);
            font-weight: 600;
        }

        .loading-step.completed {
            color: var(--success-color);
        }

        .loading-step.completed::before {
            content: '✓ ';
            color: var(--success-color);
        }

        /* 로딩 펄스 효과 */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading-pulse {
            animation: pulse 2s infinite;
        }

        /* 계산 버튼 로딩 상태 */
        .calculate-btn.loading {
            position: relative;
            color: transparent;
            pointer-events: none;
        }

        .calculate-btn.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        /* 결과 섹션 페이드인 효과 */
        .results-section {
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .results-section.hidden {
            opacity: 0.3;
        }

        .result-item {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }

        .result-item.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* 토스트 알림 */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border-left: 4px solid var(--success-color);
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            border-left-color: var(--error-color);
        }

        .toast.warning {
            border-left-color: var(--warning-color);
        }

        @media (max-width: 480px) {
            .loading-content {
                margin: 20px;
                padding: 30px 20px;
                border-radius: 12px;
            }

            .loading-spinner {
                width: 50px;
                height: 50px;
            }

            .loading-text {
                font-size: 15px;
            }

            .loading-steps {
                font-size: 13px;
            }

            .toast {
                right: 10px;
                left: 10px;
                transform: translateY(-100px);
            }

            .toast.show {
                transform: translateY(0);
            }
        }

        /* 오행 차트 시각화 스타일 */
        .elements-chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .elements-chart-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            color: #333;
        }

        .elements-chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .element-item {
            text-align: center;
            padding: 15px 10px;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .element-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .element-item.wood {
            background: linear-gradient(135deg, #4caf50, #81c784);
            border-color: #4caf50;
            color: white;
        }

        .element-item.fire {
            background: linear-gradient(135deg, #f44336, #ef5350);
            border-color: #f44336;
            color: white;
        }

        .element-item.earth {
            background: linear-gradient(135deg, #795548, #a1887f);
            border-color: #795548;
            color: white;
        }

        .element-item.metal {
            background: linear-gradient(135deg, #9e9e9e, #bdbdbd);
            border-color: #9e9e9e;
            color: white;
        }

        .element-item.water {
            background: linear-gradient(135deg, #2196f3, #42a5f5);
            border-color: #2196f3;
            color: white;
        }

        .element-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .element-count {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .element-percentage {
            font-size: 12px;
            opacity: 0.9;
        }

        /* 오행 균형 바 차트 */
        .balance-chart {
            margin-top: 20px;
        }

        .balance-item {
            margin-bottom: 12px;
        }

        .balance-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            font-size: 13px;
            font-weight: 600;
        }

        .balance-bar-container {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .balance-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 1s ease;
            position: relative;
        }

        .balance-bar.wood {
            background: linear-gradient(90deg, #4caf50, #81c784);
        }

        .balance-bar.fire {
            background: linear-gradient(90deg, #f44336, #ef5350);
        }

        .balance-bar.earth {
            background: linear-gradient(90deg, #795548, #a1887f);
        }

        .balance-bar.metal {
            background: linear-gradient(90deg, #9e9e9e, #bdbdbd);
        }

        .balance-bar.water {
            background: linear-gradient(90deg, #2196f3, #42a5f5);
        }

        /* 오행 상생상극 관계도 */
        .elements-relation {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .relation-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .relation-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .relation-section {
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .relation-section.positive {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            border: 1px solid #4caf50;
        }

        .relation-section.negative {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            border: 1px solid #f44336;
        }

        .relation-section h4 {
            font-size: 14px;
            margin-bottom: 10px;
            text-align: center;
        }

        .relation-list {
            font-size: 12px;
            line-height: 1.5;
        }

        /* 모바일 최적화 */
        @media (max-width: 768px) {
            .elements-chart-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .elements-chart-container {
                padding: 20px 15px;
            }

            .element-item {
                padding: 12px 8px;
            }

            .element-count {
                font-size: 20px;
            }

            .relation-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .elements-chart-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .element-item {
                padding: 10px 6px;
            }

            .element-count {
                font-size: 18px;
            }

            .element-name {
                font-size: 12px;
            }
        }

        /* 대운 타임라인 스타일 */
        .daeun-timeline-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .daeun-timeline-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            color: #333;
        }

        .timeline-container {
            position: relative;
            margin: 30px 0;
        }

        /* 메인 타임라인 축 */
        .timeline-axis {
            position: relative;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 2px;
            margin: 40px 0;
        }

        /* 타임라인 포인트들 */
        .timeline-points {
            position: relative;
        }

        .timeline-point {
            position: absolute;
            top: -20px;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 4px solid var(--primary-color);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 2;
        }

        .timeline-point:hover {
            transform: translateX(-50%) scale(1.2);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        .timeline-point.current {
            border-color: var(--success-color);
            background: var(--success-color);
            animation: pulse 2s infinite;
        }

        .timeline-point.past {
            border-color: #bdbdbd;
            background: #f5f5f5;
        }

        .timeline-point.future {
            border-color: var(--warning-color);
            background: white;
        }

        /* 대운 정보 카드들 */
        .daeun-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .daeun-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .daeun-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .daeun-card.current {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            border-color: var(--success-color);
        }

        .daeun-card.past {
            background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
            border-color: #bdbdbd;
            opacity: 0.7;
        }

        .daeun-card.future {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border-color: var(--warning-color);
        }

        .daeun-period {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .daeun-ganji {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #333;
        }

        .daeun-age {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .daeun-description {
            font-size: 13px;
            line-height: 1.5;
            color: #555;
        }

        /* 대운 요약 정보 */
        .daeun-summary {
            background: #f0f8ff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary-color);
        }

        .daeun-summary h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .daeun-current-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .current-info-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .current-info-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .current-info-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* 모바일 최적화 */
        @media (max-width: 768px) {
            .daeun-timeline-container {
                padding: 20px 15px;
            }

            .daeun-cards {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .daeun-card {
                padding: 15px;
            }

            .timeline-axis {
                margin: 30px 0;
            }

            .daeun-current-info {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .daeun-card {
                padding: 12px;
            }

            .daeun-ganji {
                font-size: 20px;
            }

            .timeline-point {
                width: 16px;
                height: 16px;
                border-width: 3px;
            }
        }

        /* 입력 검증 및 도우미 기능 스타일 */
        .input-validation {
            position: relative;
        }

        .form-group {
            position: relative;
            margin-bottom: 20px;
        }

        .form-group.has-error input,
        .form-group.has-error select {
            border-color: var(--error-color);
            background-color: #ffebee;
        }

        .form-group.has-success input,
        .form-group.has-success select {
            border-color: var(--success-color);
            background-color: #e8f5e8;
        }

        .validation-message {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            padding: 8px 12px;
            font-size: 12px;
            border-radius: 0 0 6px 6px;
            margin-top: -1px;
            z-index: 10;
            display: none;
        }

        .validation-message.error {
            background: var(--error-color);
            color: white;
        }

        .validation-message.success {
            background: var(--success-color);
            color: white;
        }

        .validation-message.warning {
            background: var(--warning-color);
            color: white;
        }

        .validation-message.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 도움말 툴팁 */
        .help-tooltip {
            position: relative;
            display: inline-block;
            margin-left: 8px;
            cursor: help;
        }

        .help-icon {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--secondary-color);
            color: white;
            font-size: 12px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .help-icon:hover {
            background: var(--primary-color);
            transform: scale(1.1);
        }

        .tooltip-content {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.4;
            white-space: nowrap;
            max-width: 300px;
            white-space: normal;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            margin-bottom: 8px;
        }

        .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #333;
        }

        .help-tooltip:hover .tooltip-content {
            opacity: 1;
            visibility: visible;
        }

        /* 실시간 피드백 */
        .input-feedback {
            display: flex;
            align-items: center;
            margin-top: 8px;
            font-size: 12px;
            gap: 8px;
        }

        .feedback-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        .feedback-icon.success {
            background: var(--success-color);
            color: white;
        }

        .feedback-icon.error {
            background: var(--error-color);
            color: white;
        }

        .feedback-icon.warning {
            background: var(--warning-color);
            color: white;
        }

        /* 입력 힌트 */
        .input-hint {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
            font-style: italic;
        }

        /* 자동 완성 제안 */
        .auto-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .suggestion-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }

        .suggestion-item:hover,
        .suggestion-item.selected {
            background-color: #f0f8ff;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        /* 입력 진행 상태 */
        .input-progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .progress-step.completed {
            color: var(--success-color);
        }

        .progress-step.current {
            color: var(--primary-color);
            font-weight: 600;
        }

        .progress-step.pending {
            color: #999;
        }

        .step-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .step-icon.completed {
            background: var(--success-color);
            color: white;
        }

        .step-icon.current {
            background: var(--primary-color);
            color: white;
        }

        .step-icon.pending {
            background: #e0e0e0;
            color: #999;
        }

        /* 모바일 최적화 */
        @media (max-width: 768px) {
            .tooltip-content {
                position: fixed;
                bottom: auto;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                max-width: 280px;
                z-index: 1001;
            }

            .tooltip-content::after {
                display: none;
            }

            .input-progress {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- 로딩 오버레이 - 완전한 진행 표시 -->
    <div class="loading" id="loading">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loading-text">사주 분석을 시작합니다...</div>

            <!-- 진행 바 -->
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>

            <!-- 진행 단계 -->
            <div class="loading-steps" id="loading-steps">
                <div class="loading-step" id="step-validation">입력 정보 검증</div>
                <div class="loading-step" id="step-manseryeok">만세력 계산</div>
                <div class="loading-step" id="step-elements">오행 분석</div>
                <div class="loading-step" id="step-sipsin">십신 분석</div>
                <div class="loading-step" id="step-sinsaal">신살 분석</div>
                <div class="loading-step" id="step-gyeokguk">격국 분석</div>
                <div class="loading-step" id="step-daeun">대운 계산</div>
                <div class="loading-step" id="step-results">결과 정리</div>
            </div>
        </div>
    </div>

    <!-- 토스트 알림 컨테이너 -->
    <div class="toast-container" id="toast-container"></div>

    <div class="container">
        <!-- 헤더 -->
        <header class="header">
            <h1>사주 분석</h1>
            <p class="subtitle">정확한 사주팔자 계산과 전문적인 해석</p>
        </header>

        <!-- 메인 컨텐츠 -->
        <div class="main-content">
            <!-- 입력 섹션 -->
            <section class="input-section">
                <h2>사주 정보 입력</h2>

                <!-- 입력 진행 상태 -->
                <div class="input-progress" id="input-progress">
                    <div class="progress-step current" id="step-name">
                        <div class="step-icon current">1</div>
                        <span>이름</span>
                    </div>
                    <div class="progress-step pending" id="step-birth">
                        <div class="step-icon pending">2</div>
                        <span>생년월일</span>
                    </div>
                    <div class="progress-step pending" id="step-time">
                        <div class="step-icon pending">3</div>
                        <span>출생시간</span>
                    </div>
                    <div class="progress-step pending" id="step-gender">
                        <div class="step-icon pending">4</div>
                        <span>성별</span>
                    </div>
                </div>

                <form id="saju-form" novalidate>
                    <!-- 이름 입력 -->
                    <div class="form-group input-validation" id="name-group">
                        <label for="name">성명
                            <span class="help-tooltip">
                                <div class="help-icon">?</div>
                                <div class="tooltip-content">
                                    실명을 입력하시면 더 정확한 사주 분석이 가능합니다.
                                    한글 2-4자 또는 한자 이름을 입력해주세요.
                                </div>
                            </span>
                        </label>
                        <input type="text" id="name" name="name" placeholder="이름을 입력해주세요" required>
                        <div class="validation-message" id="name-validation"></div>
                        <div class="input-feedback" id="name-feedback"></div>
                        <div class="input-hint">예: 홍길동, 김영희</div>
                        <div class="auto-suggestions" id="name-suggestions"></div>
                    </div>

                    <!-- 생년월일 입력 -->
                    <div class="form-group input-validation" id="birthdate-group">
                        <label for="birthdate">생년월일
                            <span class="help-tooltip">
                                <div class="help-icon">?</div>
                                <div class="tooltip-content">
                                    정확한 생년월일을 입력해주세요. 사주팔자는 생년월일을 기준으로 계산됩니다.
                                    1900년 이후 출생자만 지원됩니다.
                                </div>
                            </span>
                        </label>
                        <input type="date" id="birthdate" name="birthdate" required min="1900-01-01" max="2024-12-31">
                        <div class="validation-message" id="birthdate-validation"></div>
                        <div class="input-feedback" id="birthdate-feedback"></div>
                        <div class="input-hint">양력 기준으로 입력해주세요</div>
                    </div>

                    <!-- 달력 구분 -->
                    <div class="form-group" id="calendar-group">
                        <label>달력 구분
                            <span class="help-tooltip">
                                <div class="help-icon">?</div>
                                <div class="tooltip-content">
                                    양력: 현재 사용하는 서양 달력 (정확도 높음)<br>
                                    음력: 전통 음력 달력 (한국 전통 사주에서 주로 사용)
                                </div>
                            </span>
                        </label>
                        <div class="calendar-toggle">
                            <div class="calendar-option selected" data-calendar="solar">양력</div>
                            <div class="calendar-option" data-calendar="lunar">음력</div>
                        </div>
                        <div class="input-hint">대부분의 경우 양력을 선택하시면 됩니다</div>
                        <div id="lunarInfo" style="display: none;">
                            <div class="info-message info">
                                <div id="lunarDisplay">음력 정보가 여기에 표시됩니다</div>
                            </div>
                        </div>
                    </div>

                    <!-- 시간 입력 -->
                    <div class="form-group input-validation" id="time-group">
                        <label>출생 시간
                            <span class="help-tooltip">
                                <div class="help-icon">?</div>
                                <div class="tooltip-content">
                                    정확한 출생 시간을 입력하시면 시주(時柱) 계산이 가능합니다.
                                    시간을 모르는 경우 "시간을 모름"을 선택하세요.
                                </div>
                            </span>
                        </label>
                        <div class="time-inputs">
                            <select id="birthHour">
                                <option value="">시 선택</option>
                                <option value="unknown">⏰ 시간을 모름</option>
                                <option value="0">00시 (자시)</option>
                                <option value="1">01시 (축시)</option>
                                <option value="2">02시 (축시)</option>
                                <option value="3">03시 (인시)</option>
                                <option value="4">04시 (인시)</option>
                                <option value="5">05시 (묘시)</option>
                                <option value="6">06시 (묘시)</option>
                                <option value="7">07시 (진시)</option>
                                <option value="8">08시 (진시)</option>
                                <option value="9">09시 (사시)</option>
                                <option value="10">10시 (사시)</option>
                                <option value="11">11시 (오시)</option>
                                <option value="12">12시 (오시)</option>
                                <option value="13">13시 (미시)</option>
                                <option value="14">14시 (미시)</option>
                                <option value="15">15시 (신시)</option>
                                <option value="16">16시 (신시)</option>
                                <option value="17">17시 (유시)</option>
                                <option value="18">18시 (유시)</option>
                                <option value="19">19시 (술시)</option>
                                <option value="20">20시 (술시)</option>
                                <option value="21">21시 (해시)</option>
                                <option value="22">22시 (해시)</option>
                                <option value="23">23시 (자시)</option>
                            </select>
                            <select id="birthMinute">
                                <!-- 옵션은 JavaScript로 동적 생성 -->
                            </select>
                        </div>

                        <!-- 정밀 시간 옵션 -->
                        <button type="button" class="time-precision-toggle" onclick="togglePrecision()">
                            🎯 초 단위 정밀 모드
                        </button>
                        <div class="seconds-input">
                            <label for="birthSecond">초</label>
                            <select id="birthSecond">
                                <option value="0">00초</option>
                                <option value="15">15초</option>
                                <option value="30">30초</option>
                                <option value="45">45초</option>
                            </select>
                        </div>

                        <div id="timeWarning" class="info-message info" style="display: none; margin-top: 10px;">
                            💡 출생 시간을 모르시는 경우 "시간을 모름"을 선택하시면 자시(00시)로 계산됩니다.
                        </div>

                        <div id="time-display" class="time-display">시간을 선택해주세요</div>
                        <div class="validation-message" id="time-validation"></div>
                        <div class="input-feedback" id="time-feedback"></div>
                        <div class="input-hint">정확한 시간을 모르시면 "시간을 모름"을 선택하세요</div>
                    </div>

                    <!-- 성별 선택 -->
                    <div class="form-group" id="gender-group">
                        <label>성별
                            <span class="help-tooltip">
                                <div class="help-icon">?</div>
                                <div class="tooltip-content">
                                    성별에 따라 대운의 시작 시기가 달라집니다.
                                    남성은 양순음역, 여성은 음순양역으로 계산됩니다.
                                </div>
                            </span>
                        </label>
                        <div class="gender-select">
                            <div class="gender-option selected" data-gender="male">남성 ♂</div>
                            <div class="gender-option" data-gender="female">여성 ♀</div>
                        </div>
                        <input type="hidden" id="gender" name="gender" value="male">
                        <div class="input-hint">성별은 대운 계산에 영향을 줍니다</div>
                        <div class="validation-message" id="gender-validation"></div>
                        <div class="input-feedback" id="gender-feedback"></div>
                    </div>

                    <!-- 고급 옵션 -->
                    <div class="advanced-options">
                        <h3>🔧 고급 옵션</h3>


                        <div class="input-group">
                            <label style="display: flex; align-items: center;">
                                <input type="checkbox" id="enableSinsal" checked>
                                <span style="margin-left: 8px;">신살 분석 포함</span>
                            </label>
                        </div>

                        <div class="input-group">
                            <label style="display: flex; align-items: center;">
                                <input type="checkbox" id="enableGykguk" checked>
                                <span style="margin-left: 8px;">격국 판별 포함</span>
                            </label>
                        </div>
                    </div>

                    <!-- 저장 설정 -->
                    <div class="form-group">
                        <label>저장 설정
                            <span class="help-tooltip">
                                <div class="help-icon">?</div>
                                <div class="tooltip-content">
                                    입력 정보와 계산 결과를 자동으로 저장하여 나중에 다시 볼 수 있습니다.
                                    모든 데이터는 브라우저 로컬 저장소에만 저장됩니다.
                                </div>
                            </span>
                        </label>
                        <div class="storage-preferences" style="margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 14px;">
                                <input type="checkbox" id="auto-save-checkbox" style="margin: 0;">
                                <span>입력과 결과 자동 저장</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 14px;">
                                <input type="checkbox" id="save-history-checkbox" style="margin: 0;">
                                <span>계산 이력 유지 (최대 10개)</span>
                            </label>
                            <div style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px; color: #666;">
                                <div>현재 저장 상태: <span id="current-storage-status">확인 중...</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- 계산 버튼 -->
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button type="submit" class="calculate-btn" id="calculate-btn">
                            🔮 사주 분석 시작
                        </button>

                        <button type="button" style="background: #6c757d; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;"
                                onclick="runSystemDiagnostic()">
                            🔧 시스템 진단 (오류 발생시 클릭)
                        </button>
                    </div>

                    <!-- 기능 설명 -->
                    <div class="info-message info">
                        <p><strong>🌟 주요 기능</strong></p>
                        <p>• 분/초 단위 정밀 시간 계산</p>
                        <p>• 24절기 천문학적 정확 적용</p>
                        <p>• 음양력 완벽 변환 지원</p>
                        <p>• 30여종 신살 완전 분석</p>
                        <p>• 정격 8종 + 특수격 판별</p>
                        <p>• 대운 흐름 상세 분석</p>
                    </div>
                </form>
            </section>

            <!-- 결과 섹션 -->
            <section class="result-section">
                <div id="result" class="result-placeholder">
                    <svg viewBox="0 0 24 24" style="width: 150px; height: 150px; opacity: 0.3;">
                        <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    <h3>사주 정보를 입력하고 분석을 시작하세요</h3>
                    <p>정확한 출생 시간 입력이 분석의 정확도를 높입니다</p>
                </div>
            </section>
        </div>
    </div>

    <!-- 사주 계산 핵심 엔진들 -->
    <!-- 브라우저 호환성 확인 및 폴리필 -->
    <script>
        // 브라우저 호환성 확인
        (function() {
            'use strict';

            // 브라우저 정보 수집
            const browserInfo = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                viewport: {
                    width: window.innerWidth || document.documentElement.clientWidth,
                    height: window.innerHeight || document.documentElement.clientHeight
                }
            };

            // 브라우저 식별
            function detectBrowser() {
                const ua = navigator.userAgent;
                let browser = {
                    name: 'Unknown',
                    version: 'Unknown',
                    mobile: /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua)
                };

                if (ua.indexOf('Chrome') > -1 && ua.indexOf('Edge') === -1) {
                    browser.name = 'Chrome';
                    browser.version = ua.match(/Chrome\/(\d+)/)?.[1] || 'Unknown';
                } else if (ua.indexOf('Firefox') > -1) {
                    browser.name = 'Firefox';
                    browser.version = ua.match(/Firefox\/(\d+)/)?.[1] || 'Unknown';
                } else if (ua.indexOf('Safari') > -1 && ua.indexOf('Chrome') === -1) {
                    browser.name = 'Safari';
                    browser.version = ua.match(/Version\/(\d+)/)?.[1] || 'Unknown';
                } else if (ua.indexOf('Edge') > -1) {
                    browser.name = 'Edge';
                    browser.version = ua.match(/Edge\/(\d+)/)?.[1] || 'Unknown';
                } else if (ua.indexOf('MSIE') > -1 || ua.indexOf('Trident') > -1) {
                    browser.name = 'Internet Explorer';
                    browser.version = ua.match(/(?:MSIE |rv:)(\d+)/)?.[1] || 'Unknown';
                }

                return browser;
            }

            // 필요한 기능들 확인
            function checkFeatureSupport() {
                const features = {
                    localStorage: typeof(Storage) !== 'undefined',
                    asyncAwait: (function() {
                        try {
                            eval('(async function() {})');
                            return true;
                        } catch (e) {
                            return false;
                        }
                    })(),
                    arrow_functions: (function() {
                        try {
                            eval('(() => {})');
                            return true;
                        } catch (e) {
                            return false;
                        }
                    })(),
                    template_literals: (function() {
                        try {
                            var f = new Function('return `test`');
                            f();
                            return true;
                        } catch (e) {
                            return false;
                        }
                    })(),
                    const_let: (function() {
                        try {
                            eval('const x = 1; let y = 2;');
                            return true;
                        } catch (e) {
                            return false;
                        }
                    })(),
                    flexbox: 'flex' in document.createElement('div').style,
                    grid: 'grid' in document.createElement('div').style,
                    cssVariables: window.CSS && CSS.supports && CSS.supports('color', 'var(--test)')
                };

                return features;
            }

            // 폴리필 추가
            function addPolyfills() {
                // Array.find 폴리필 (IE)
                if (!Array.prototype.find) {
                    Array.prototype.find = function(predicate) {
                        if (this == null) {
                            throw new TypeError('"this" is null or not defined');
                        }
                        var o = Object(this);
                        var len = parseInt(o.length) || 0;
                        if (typeof predicate !== 'function') {
                            throw new TypeError('predicate must be a function');
                        }
                        var thisArg = arguments[1];
                        var k = 0;
                        while (k < len) {
                            var kValue = o[k];
                            if (predicate.call(thisArg, kValue, k, o)) {
                                return kValue;
                            }
                            k++;
                        }
                        return undefined;
                    };
                }

                // Array.includes 폴리필 (IE)
                if (!Array.prototype.includes) {
                    Array.prototype.includes = function(searchElement /*, fromIndex*/) {
                        'use strict';
                        var O = Object(this);
                        var len = parseInt(O.length) || 0;
                        if (len === 0) {
                            return false;
                        }
                        var n = parseInt(arguments[1]) || 0;
                        var k;
                        if (n >= 0) {
                            k = n;
                        } else {
                            k = len + n;
                            if (k < 0) {k = 0;}
                        }
                        function sameValueZero(x, y) {
                            return x === y || (typeof x === 'number' && typeof y === 'number' && isNaN(x) && isNaN(y));
                        }
                        for (;k < len; k++) {
                            if (sameValueZero(O[k], searchElement)) {
                                return true;
                            }
                        }
                        return false;
                    };
                }

                // String.includes 폴리필 (IE)
                if (!String.prototype.includes) {
                    String.prototype.includes = function(search, start) {
                        'use strict';
                        if (typeof start !== 'number') {
                            start = 0;
                        }

                        if (start + search.length > this.length) {
                            return false;
                        } else {
                            return this.indexOf(search, start) !== -1;
                        }
                    };
                }

                // Object.assign 폴리필 (IE)
                if (typeof Object.assign !== 'function') {
                    Object.assign = function(target) {
                        'use strict';
                        if (target == null) {
                            throw new TypeError('Cannot convert undefined or null to object');
                        }

                        var to = Object(target);

                        for (var index = 1; index < arguments.length; index++) {
                            var nextSource = arguments[index];

                            if (nextSource != null) {
                                for (var nextKey in nextSource) {
                                    if (Object.prototype.hasOwnProperty.call(nextSource, nextKey)) {
                                        to[nextKey] = nextSource[nextKey];
                                    }
                                }
                            }
                        }
                        return to;
                    };
                }
            }

            // 호환성 확인 실행
            const browser = detectBrowser();
            const features = checkFeatureSupport();

            // 전역 객체에 브라우저 정보 저장
            window.browserCompatibility = {
                browser: browser,
                features: features,
                browserInfo: browserInfo,
                isSupported: features.localStorage && features.flexbox
            };

            // 폴리필 적용
            addPolyfills();

            // 호환성 경고 표시 (필요한 경우)
            if (!window.browserCompatibility.isSupported) {
                console.warn('⚠️ 일부 기능이 지원되지 않는 브라우저입니다.');

                // IE 경고
                if (browser.name === 'Internet Explorer') {
                    document.addEventListener('DOMContentLoaded', function() {
                        const warning = document.createElement('div');
                        warning.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: #ff9800; color: white; text-align: center; padding: 10px; z-index: 10000; font-size: 14px;';
                        warning.innerHTML = '⚠️ Internet Explorer는 일부 기능이 제한될 수 있습니다. Chrome, Firefox, Edge 브라우저를 권장합니다.';
                        document.body.insertBefore(warning, document.body.firstChild);
                    });
                }
            }

            console.log('🔍 브라우저 호환성 확인 완료:', window.browserCompatibility);
        })();
    </script>

    <script src="saju-core-functions.js"></script>
    <script src="lunar-calendar-calculator.js"></script>

    <!-- 추가 기능 스크립트 -->
    <script>
        let isPrecisionMode = false;

        // 정밀 모드 토글
        function togglePrecision() {
            isPrecisionMode = !isPrecisionMode;
            const secondsInput = document.querySelector('.seconds-input');
            const toggleBtn = document.querySelector('.time-precision-toggle');

            if (isPrecisionMode) {
                secondsInput.classList.add('active');
                toggleBtn.textContent = '🎯 기본 모드로 전환';
                toggleBtn.style.background = 'var(--warning-color)';
            } else {
                secondsInput.classList.remove('active');
                toggleBtn.textContent = '🎯 초 단위 정밀 모드';
                toggleBtn.style.background = 'var(--secondary-color)';
            }
        }

        // 분 선택 옵션 생성 함수
        function populateMinutes() {
            try {
                console.log('🕒 분 입력 필드 초기화 시작');
                const minuteSelect = document.getElementById('birthMinute');

                if (!minuteSelect) {
                    console.error('❌ birthMinute 요소를 찾을 수 없습니다');
                    return;
                }

                console.log('✅ birthMinute 요소 찾음');

                // 기존 옵션을 완전히 지우고 다시 생성
                minuteSelect.innerHTML = '';

                // 기본 선택 옵션 추가
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '분 선택';
                minuteSelect.appendChild(defaultOption);

                // 0-59분 옵션 생성
                for (let i = 0; i < 60; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = String(i).padStart(2, '0') + '분';
                    minuteSelect.appendChild(option);
                }

                console.log('✅ 분 입력 옵션 생성 완료 (0-59분, 총 ' + minuteSelect.options.length + '개 옵션)');
            } catch (error) {
                console.error('❌ populateMinutes 함수 오류:', error);
            }
        }

        // 시간 표시 업데이트
        function updateTimeDisplay() {
            const hourSelect = document.getElementById('birthHour');
            const minuteSelect = document.getElementById('birthMinute');
            const timeDisplay = document.getElementById('time-display');

            if (!timeDisplay) return;

            const hour = hourSelect?.value;
            const minute = minuteSelect?.value;

            if (hour === 'unknown') {
                timeDisplay.textContent = '시간 미상';
                timeDisplay.className = 'time-display unknown';
            } else if (hour && minute !== '') {
                const 시주명 = getTimeZoneName(parseInt(hour));
                timeDisplay.textContent = `${String(hour).padStart(2, '0')}시 ${String(minute).padStart(2, '0')}분 (${시주명})`;
                timeDisplay.className = 'time-display selected';
            } else {
                timeDisplay.textContent = '시간을 선택해주세요';
                timeDisplay.className = 'time-display';
            }
        }

        function getTimeZoneName(hour) {
            const timeZones = {
                23: '자시', 0: '자시', 1: '축시', 2: '축시',
                3: '인시', 4: '인시', 5: '묘시', 6: '묘시',
                7: '진시', 8: '진시', 9: '사시', 10: '사시',
                11: '오시', 12: '오시', 13: '미시', 14: '미시',
                15: '신시', 16: '신시', 17: '유시', 18: '유시',
                19: '술시', 20: '술시', 21: '해시', 22: '해시'
            };
            return timeZones[hour] || '자시';
        }

        // 달력 옵션 이벤트
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📝 페이지 로드 완료, 초기화 시작');

            // 입력 검증 시스템 초기화
            initInputValidation();

            // 분 옵션 즉시 생성
            populateMinutes();

            // 추가 안전장치: 1초 후 다시 확인
            setTimeout(function() {
                const minuteSelect = document.getElementById('birthMinute');
                if (minuteSelect && minuteSelect.options.length <= 1) {
                    console.warn('⚠️ 분 옵션이 생성되지 않았습니다. 재시도합니다.');
                    populateMinutes();
                }
            }, 1000);

            // 시간 변경 이벤트 리스너
            const hourSelect = document.getElementById('birthHour');
            const minuteSelect = document.getElementById('birthMinute');

            if (hourSelect) {
                hourSelect.addEventListener('change', function() {
                    console.log('시간 변경됨:', this.value);
                    const minuteSelect = document.getElementById('birthMinute');

                    if (this.value === 'unknown') {
                        minuteSelect.disabled = true;
                        minuteSelect.value = '0';
                    } else {
                        minuteSelect.disabled = false;
                        if (!minuteSelect.children.length || minuteSelect.children.length <= 1) {
                            populateMinutes();
                        }
                    }
                    updateTimeDisplay();
                });
            }

            if (minuteSelect) {
                minuteSelect.addEventListener('change', updateTimeDisplay);
            }

            // 달력 옵션 클릭 이벤트
            document.querySelectorAll('.calendar-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.calendar-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    updateCalendarMode();
                });
            });

            // 성별 옵션 클릭 이벤트
            document.querySelectorAll('.gender-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.gender-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('gender').value = this.dataset.gender;
                });
            });

            // 폼 제출 이벤트 연결 - 가장 중요!
            const sajuForm = document.getElementById('saju-form');
            if (sajuForm) {
                sajuForm.addEventListener('submit', function(e) {
                    e.preventDefault(); // 페이지 새로고침 방지
                    calculateSaju(); // 사주 계산 실행 (비동기)
                });
                console.log('✅ 사주 계산 폼 이벤트 연결 완료');
            }

            // 저장 설정 초기화
            initStoragePreferences();

            console.log('✅ 모든 이벤트 리스너 설정 완료');
        });

        function updateCalendarMode() {
            const selectedCalendar = document.querySelector('.calendar-option.selected').dataset.calendar;
            const lunarInfo = document.getElementById('lunarInfo');

            if (selectedCalendar === 'lunar') {
                lunarInfo.style.display = 'block';
                updateLunarInfo();
            } else {
                lunarInfo.style.display = 'none';
            }
        }

        function updateLunarInfo() {
            const birthdate = document.getElementById('birthdate').value;
            const calendarType = document.querySelector('input[name="calendar"]:checked')?.value || 'solar';

            if (birthdate) {
                const lunarDisplay = document.getElementById('lunarDisplay');

                try {
                    if (typeof LunarCalendarCalculator !== 'undefined') {
                        const lunarCalc = new LunarCalendarCalculator();
                        const inputDate = new Date(birthdate);

                        if (calendarType === 'solar') {
                            // 양력 → 음력 변환
                            const lunarResult = lunarCalc.convertSolarToLunar(inputDate);

                            if (lunarResult) {
                                lunarDisplay.innerHTML = `
                                    <div style="font-size: 14px; color: #666;">
                                        🌙 <strong>음력 변환:</strong> ${lunarResult.year}년 ${lunarResult.month}월 ${lunarResult.day}일
                                        ${lunarResult.isLeapMonth ? '(윤달)' : ''}
                                    </div>
                                `;
                            } else {
                                lunarDisplay.textContent = '🌙 음력 변환: 해당 연도 데이터 없음';
                            }
                        } else {
                            // 음력 → 양력 변환
                            const solarResult = lunarCalc.convertLunarToSolar(
                                inputDate.getFullYear(),
                                inputDate.getMonth() + 1,
                                inputDate.getDate()
                            );

                            if (solarResult) {
                                const solarDate = new Date(solarResult);
                                lunarDisplay.innerHTML = `
                                    <div style="font-size: 14px; color: #666;">
                                        ☀️ <strong>양력 변환:</strong> ${solarDate.getFullYear()}년 ${solarDate.getMonth() + 1}월 ${solarDate.getDate()}일
                                    </div>
                                `;
                            } else {
                                lunarDisplay.textContent = '☀️ 양력 변환: 해당 연도 데이터 없음';
                            }
                        }

                        console.log('🌙 음력 변환 정보 업데이트 완료:', { birthdate, calendarType });
                    } else {
                        lunarDisplay.textContent = '🌙 음력 변환: 라이브러리 로딩 중...';
                        console.warn('LunarCalendarCalculator 클래스를 찾을 수 없습니다.');
                    }
                } catch (error) {
                    lunarDisplay.textContent = '🌙 음력 변환: 오류 발생';
                    console.error('음력 변환 오류:', error);
                }
            } else {
                const lunarDisplay = document.getElementById('lunarDisplay');
                lunarDisplay.textContent = '🌙 생년월일을 입력하면 음력 변환 정보가 표시됩니다.';
            }
        }

        function runSystemDiagnostic() {
            console.log('🔧 시스템 진단 시작');

            // 필수 요소들 확인
            const elements = [
                'name', 'birthdate', 'birthHour', 'birthMinute', 'gender'
            ];

            elements.forEach(id => {
                const element = document.getElementById(id);
                console.log(`${id}: ${element ? '✅' : '❌'}`);
                if (element && id === 'birthMinute') {
                    console.log(`  분 옵션 개수: ${element.options.length}`);
                }
            });

            // populateMinutes 함수 테스트
            if (typeof populateMinutes === 'function') {
                console.log('✅ populateMinutes 함수 접근 가능');

                // 분 필드 현재 상태 확인
                const minuteSelect = document.getElementById('birthMinute');
                console.log(`분 옵션 생성 전 개수: ${minuteSelect ? minuteSelect.options.length : '요소 없음'}`);

                // 분 옵션 생성 실행
                populateMinutes();

                // 분 필드 재확인
                console.log(`분 옵션 생성 후 개수: ${minuteSelect ? minuteSelect.options.length : '요소 없음'}`);

                // 옵션이 충분하지 않으면 강제로 다시 생성
                if (minuteSelect && minuteSelect.options.length < 61) {
                    console.warn('⚠️ 분 옵션이 충분하지 않습니다. 강제 재생성합니다.');
                    setTimeout(() => populateMinutes(), 500);
                }
            } else {
                console.error('❌ populateMinutes 함수 접근 불가');
            }

            // 핵심 함수들 추가 확인
            const functions = [
                'calculate만세력', 'analyzeElements', 'analyze십신',
                'analyze신살', 'analyze격국', 'calculatePreciseDaeun'
            ];

            console.log('🔧 핵심 함수 확인:');
            functions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    console.log(`✅ ${funcName}: 사용 가능`);
                } else {
                    console.error(`❌ ${funcName}: 없음`);
                }
            });

            // 간단한 통합 테스트
            try {
                const testDate = new Date('1989-10-06');
                const testSaju = calculate만세력(testDate, 12);
                if (testSaju && testSaju.year) {
                    console.log('✅ 통합 테스트: 만세력 계산 성공');

                    const testElements = analyzeElements(testSaju);
                    console.log('✅ 통합 테스트: 오행 분석 성공');

                    const testSipshin = analyze십신(testSaju);
                    console.log('✅ 통합 테스트: 십신 분석 성공');

                    const testSinsaal = analyze신살(testSaju);
                    console.log('✅ 통합 테스트: 신살 분석 성공');

                    const testGyeokguk = analyze격국(testSaju, testElements);
                    console.log('✅ 통합 테스트: 격국 분석 성공');

                    console.log('🎉 모든 핵심 기능이 정상 작동합니다!');
                } else {
                    console.error('❌ 통합 테스트 실패: 만세력 계산 오류');
                }
            } catch (error) {
                console.error('❌ 통합 테스트 중 오류:', error);
            }

            // 브라우저 호환성 진단
            console.log('🔍 브라우저 호환성 진단:');
            if (window.browserCompatibility) {
                const compat = window.browserCompatibility;
                console.log(`브라우저: ${compat.browser.name} ${compat.browser.version}`);
                console.log(`모바일: ${compat.browser.mobile ? 'Yes' : 'No'}`);
                console.log(`뷰포트: ${compat.browserInfo.viewport.width}x${compat.browserInfo.viewport.height}`);
                console.log('기능 지원:');

                Object.entries(compat.features).forEach(([feature, supported]) => {
                    console.log(`  ${feature}: ${supported ? '✅' : '❌'}`);
                });

                console.log(`전체 지원: ${compat.isSupported ? '✅' : '❌'}`);
            } else {
                console.error('❌ 브라우저 호환성 정보 없음');
            }

            // 로컬 저장소 테스트
            console.log('💾 로컬 저장소 테스트:');
            try {
                const testKey = 'diagnostic_test';
                const testValue = new Date().toISOString();
                localStorage.setItem(testKey, testValue);
                const retrieved = localStorage.getItem(testKey);
                localStorage.removeItem(testKey);

                if (retrieved === testValue) {
                    console.log('✅ 로컬 저장소 정상 작동');
                } else {
                    console.error('❌ 로컬 저장소 데이터 불일치');
                }
            } catch (error) {
                console.error('❌ 로컬 저장소 접근 실패:', error);
            }

            // 종합 결과 생성
            let diagnosticResult = '🔧 통합 진단 완료!\n\n';

            if (window.browserCompatibility) {
                const compat = window.browserCompatibility;
                diagnosticResult += `브라우저: ${compat.browser.name} ${compat.browser.version}\n`;
                diagnosticResult += `호환성: ${compat.isSupported ? '완전 지원' : '부분 지원'}\n`;

                if (!compat.isSupported) {
                    diagnosticResult += '\n⚠️ 경고: 일부 기능이 제한될 수 있습니다.\n';
                    diagnosticResult += '최신 브라우저를 사용하시기 바랍니다.\n';
                }
            }

            diagnosticResult += '\n상세 결과는 콘솔(F12)에서 확인하세요.';

            if (window.browserCompatibility && !window.browserCompatibility.isSupported) {
                diagnosticResult += '\n\n권장 브라우저:\n- Chrome 70+\n- Firefox 60+\n- Safari 12+\n- Edge 79+';
            }

            alert(diagnosticResult);
        }

        // ========== 진행 표시 및 UX 개선 함수들 ==========

        // 로딩 상태 관리
        function showLoading() {
            const loadingEl = document.getElementById('loading');
            const calculateBtn = document.querySelector('.calculate-btn');

            if (loadingEl) {
                loadingEl.style.display = 'flex';
            }

            if (calculateBtn) {
                calculateBtn.classList.add('loading');
            }

            // 결과 섹션 흐리게 처리
            const resultsSection = document.querySelector('.results-section');
            if (resultsSection) {
                resultsSection.classList.add('hidden');
            }
        }

        function hideLoading() {
            const loadingEl = document.getElementById('loading');
            const calculateBtn = document.querySelector('.calculate-btn');

            if (loadingEl) {
                loadingEl.style.display = 'none';
            }

            if (calculateBtn) {
                calculateBtn.classList.remove('loading');
            }

            // 결과 섹션 원래대로
            const resultsSection = document.querySelector('.results-section');
            if (resultsSection) {
                resultsSection.classList.remove('hidden');
            }
        }

        // 진행 바 업데이트
        function updateProgress(percentage) {
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }
        }

        // 진행 단계 업데이트
        function updateLoadingStep(stepId, status = 'active') {
            // 이전 단계들을 완료로 표시
            if (status === 'active') {
                const allSteps = document.querySelectorAll('.loading-step');
                const currentStepEl = document.getElementById(stepId);

                if (currentStepEl) {
                    let found = false;
                    allSteps.forEach(step => {
                        if (step === currentStepEl) {
                            found = true;
                            step.className = 'loading-step active';
                        } else if (!found) {
                            step.className = 'loading-step completed';
                        } else {
                            step.className = 'loading-step';
                        }
                    });
                }
            }
        }

        // 로딩 텍스트 업데이트
        function updateLoadingText(text) {
            const loadingText = document.getElementById('loading-text');
            if (loadingText) {
                loadingText.textContent = text;
            }
        }

        // 토스트 알림 표시
        function showToast(message, type = 'success', duration = 3000) {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;

            toastContainer.appendChild(toast);

            // 애니메이션 시작
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            // 자동 제거
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        // 결과 아이템 애니메이션 표시
        function animateResults() {
            const resultItems = document.querySelectorAll('.result-section');
            resultItems.forEach((item, index) => {
                item.classList.add('result-item');
                setTimeout(() => {
                    item.classList.add('show');
                }, index * 200);
            });

            // 오행 차트 애니메이션 시작
            animateElementsChart();

            // 대운 타임라인 애니메이션 시작
            animateDaeunTimeline();
        }

        // 진행 시뮬레이션 (비동기적으로 단계별 진행 표시)
        async function simulateProgress(steps, totalDuration = 3000) {
            const stepDuration = totalDuration / steps.length;

            for (let i = 0; i < steps.length; i++) {
                const step = steps[i];
                updateLoadingStep(step.id);
                updateLoadingText(step.text);
                updateProgress(((i + 1) / steps.length) * 100);

                await new Promise(resolve => setTimeout(resolve, stepDuration));
            }
        }

        // 사주 계산 메인 함수 - 진행 표시 통합
        async function calculateSaju() {
            console.log('🔮 사주 계산 시작');

            // 로딩 시작
            showLoading();
            updateProgress(0);

            try {
                // 1단계: 입력 정보 검증
                updateLoadingStep('step-validation');
                updateLoadingText('입력 정보를 검증하고 있습니다...');
                await new Promise(resolve => setTimeout(resolve, 300));

                const formData = collectFormData();
                if (!formData) {
                    hideLoading();
                    showToast('입력 데이터를 확인해주세요.', 'error');
                    return;
                }

                // Auto-save input data
                const userPrefs = getUserPreferences();
                let inputId = null;
                if (userPrefs.autoSave) {
                    inputId = saveInputData(formData);
                    showToast('입력 정보가 자동 저장되었습니다.', 'success', 2000);
                }
                console.log('📝 입력 데이터:', formData);
                updateProgress(12.5);

                // 2단계: 만세력 계산
                updateLoadingStep('step-manseryeok');
                updateLoadingText('만세력을 계산하고 있습니다...');
                await new Promise(resolve => setTimeout(resolve, 400));

                // 생년월일 변환 (음양력 처리)
                let birthDate;
                if (formData.calendar === 'lunar') {
                    console.log('🌙 음력 변환 시작');
                    try {
                        const lunarCalc = new LunarCalendarCalculator();
                        const inputDate = new Date(formData.birthdate);
                        birthDate = lunarCalc.convertLunarToSolar(inputDate.getFullYear(), inputDate.getMonth() + 1, inputDate.getDate());
                        console.log('✅ 음력→양력 변환 완료:', birthDate);
                    } catch (error) {
                        console.warn('⚠️ 음력 변환 실패, 양력으로 처리:', error);
                        birthDate = new Date(formData.birthdate);
                    }
                } else {
                    birthDate = new Date(formData.birthdate);
                    console.log('☀️ 양력 처리:', birthDate);
                }

                let hour = formData.hour === 'unknown' ? 12 : parseInt(formData.hour);
                console.log('🕐 계산 시간:', hour, '시');

                const sajuResult = calculate만세력(birthDate, hour);
                console.log('✅ 사주팔자 계산 완료:', sajuResult);
                updateProgress(25);

                // 3단계: 오행 분석
                updateLoadingStep('step-elements');
                updateLoadingText('오행 분석을 진행하고 있습니다...');
                await new Promise(resolve => setTimeout(resolve, 300));

                const elements = analyzeElements(sajuResult);
                console.log('🌟 오행 분석 완료:', elements);
                updateProgress(37.5);

                // 4단계: 십신 분석
                updateLoadingStep('step-sipsin');
                updateLoadingText('십신 분석을 진행하고 있습니다...');
                await new Promise(resolve => setTimeout(resolve, 300));

                const sipshin = analyze십신(sajuResult);
                console.log('⚔️ 십신 분석 완료:', sipshin);
                updateProgress(50);

                // 5단계: 신살 분석
                updateLoadingStep('step-sinsaal');
                updateLoadingText('신살을 분석하고 있습니다...');
                await new Promise(resolve => setTimeout(resolve, 400));

                const sinsaal = analyze신살(sajuResult);
                console.log('🔮 신살 분석 완료:', sinsaal);
                updateProgress(62.5);

                // 6단계: 격국 분석
                updateLoadingStep('step-gyeokguk');
                updateLoadingText('격국을 분석하고 있습니다...');
                await new Promise(resolve => setTimeout(resolve, 300));

                const gyeokguk = analyze격국(sajuResult, elements);
                console.log('⚖️ 격국 분석 완료:', gyeokguk);
                updateProgress(75);

                // 7단계: 대운 계산
                updateLoadingStep('step-daeun');
                updateLoadingText('대운을 계산하고 있습니다...');
                await new Promise(resolve => setTimeout(resolve, 400));

                const daeun = calculatePreciseDaeun(sajuResult, formData.gender, birthDate);
                console.log('📅 대운 계산 완료:', daeun);
                updateProgress(87.5);

                // 8단계: 결과 정리
                updateLoadingStep('step-results');
                updateLoadingText('결과를 정리하고 있습니다...');
                await new Promise(resolve => setTimeout(resolve, 300));

                // 결과 화면에 표시
                const resultData = {
                    name: formData.name,
                    gender: formData.gender,
                    birthInfo: formData,
                    saju: sajuResult,
                    elements: elements,
                    sipshin: sipshin,
                    sinsaal: sinsaal,
                    gyeokguk: gyeokguk,
                    daeun: daeun
                };
                displayResults(resultData);

                // Auto-save calculation result
                if (userPrefs.autoSave && inputId) {
                    saveCalculationResult(inputId, resultData);
                    showToast('계산 결과가 자동 저장되었습니다.', 'success', 2000);
                }

                updateProgress(100);
                await new Promise(resolve => setTimeout(resolve, 500));

                // 완료 처리
                hideLoading();
                showToast(`${formData.name}님의 사주 분석이 완료되었습니다!`, 'success', 4000);
                animateResults();

            } catch (error) {
                console.error('❌ 사주 계산 오류:', error);
                hideLoading();
                showToast('사주 계산 중 오류가 발생했습니다: ' + error.message, 'error', 5000);
            }
        }

        // 폼 데이터 수집 함수
        function collectFormData() {
            // 전체 폼 검증 실행
            if (!validateForm()) {
                showToast('입력 정보를 확인해주세요.', 'error');
                return null;
            }

            const name = document.getElementById('name')?.value?.trim();
            const birthdate = document.getElementById('birthdate')?.value;
            const hour = document.getElementById('birthHour')?.value;
            const minute = document.getElementById('birthMinute')?.value;
            const gender = document.getElementById('gender')?.value;

            return {
                name: name,
                birthdate: birthdate,
                hour: hour,
                minute: minute || '0',
                gender: gender,
                calendar: document.querySelector('.calendar-option.selected')?.dataset?.calendar || 'solar'
            };
        }

        // ========== 로컬 저장/불러오기 기능 ==========

        // 로컬 스토리지 키 상수
        const STORAGE_KEYS = {
            RECENT_INPUTS: 'saju_recent_inputs',
            SAVED_RESULTS: 'saju_saved_results',
            USER_PREFERENCES: 'saju_user_preferences'
        };

        // 입력 데이터 저장
        function saveInputData(formData) {
            try {
                const recentInputs = getRecentInputs();
                const newInput = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    data: formData
                };

                // 최근 입력 목록에 추가 (최대 10개)
                recentInputs.unshift(newInput);
                if (recentInputs.length > 10) {
                    recentInputs.splice(10);
                }

                localStorage.setItem(STORAGE_KEYS.RECENT_INPUTS, JSON.stringify(recentInputs));
                console.log('✅ 입력 데이터 저장 완료:', newInput.id);
                return newInput.id;
            } catch (error) {
                console.error('❌ 입력 데이터 저장 실패:', error);
                return null;
            }
        }

        // 사주 계산 결과 저장
        function saveCalculationResult(inputId, resultData) {
            try {
                const savedResults = getSavedResults();
                const newResult = {
                    id: inputId,
                    timestamp: new Date().toISOString(),
                    inputData: resultData.name ? {
                        name: resultData.name,
                        birthInfo: resultData.birthInfo
                    } : null,
                    results: {
                        saju: resultData.saju,
                        elements: resultData.elements,
                        sipshin: resultData.sipshin,
                        sinsaal: resultData.sinsaal,
                        gyeokguk: resultData.gyeokguk,
                        daeun: resultData.daeun
                    }
                };

                // 기존 결과 업데이트 또는 새로 추가
                const existingIndex = savedResults.findIndex(result => result.id === inputId);
                if (existingIndex >= 0) {
                    savedResults[existingIndex] = newResult;
                } else {
                    savedResults.unshift(newResult);
                    // 최대 20개 결과만 저장
                    if (savedResults.length > 20) {
                        savedResults.splice(20);
                    }
                }

                localStorage.setItem(STORAGE_KEYS.SAVED_RESULTS, JSON.stringify(savedResults));
                console.log('✅ 계산 결과 저장 완료:', inputId);

                // 저장 완료 토스트 표시
                showToast(`${resultData.name}님의 사주 결과가 저장되었습니다`, 'success');
                return true;
            } catch (error) {
                console.error('❌ 계산 결과 저장 실패:', error);
                showToast('결과 저장에 실패했습니다', 'error');
                return false;
            }
        }

        // 최근 입력 데이터 가져오기
        function getRecentInputs() {
            try {
                const data = localStorage.getItem(STORAGE_KEYS.RECENT_INPUTS);
                return data ? JSON.parse(data) : [];
            } catch (error) {
                console.error('❌ 최근 입력 데이터 불러오기 실패:', error);
                return [];
            }
        }

        // 저장된 결과 가져오기
        function getSavedResults() {
            try {
                console.log('🔍 localStorage에서 데이터 가져오는 중...');
                const data = localStorage.getItem(STORAGE_KEYS.SAVED_RESULTS);
                console.log('localStorage 원본 데이터:', data);
                const parsed = data ? JSON.parse(data) : [];
                console.log('파싱된 데이터:', parsed);
                return parsed;
            } catch (error) {
                console.error('❌ 저장된 결과 불러오기 실패:', error);
                return [];
            }
        }

        // 사용자 설정 저장
        function saveUserPreferences(preferences) {
            try {
                localStorage.setItem(STORAGE_KEYS.USER_PREFERENCES, JSON.stringify(preferences));
                console.log('✅ 사용자 설정 저장 완료');
            } catch (error) {
                console.error('❌ 사용자 설정 저장 실패:', error);
            }
        }

        // 사용자 설정 불러오기
        function getUserPreferences() {
            try {
                const data = localStorage.getItem(STORAGE_KEYS.USER_PREFERENCES);
                return data ? JSON.parse(data) : {
                    defaultCalendar: 'solar',
                    autoSave: true,
                    theme: 'light'
                };
            } catch (error) {
                console.error('❌ 사용자 설정 불러오기 실패:', error);
                return {
                    defaultCalendar: 'solar',
                    autoSave: true,
                    theme: 'light'
                };
            }
        }

        // 입력 데이터를 폼에 불러오기
        function loadInputToForm(inputData) {
            try {
                if (inputData.name) {
                    document.getElementById('name').value = inputData.name;
                }
                if (inputData.birthdate) {
                    document.getElementById('birthdate').value = inputData.birthdate;
                }
                if (inputData.hour) {
                    document.getElementById('birthHour').value = inputData.hour;
                }
                if (inputData.minute) {
                    document.getElementById('birthMinute').value = inputData.minute;
                }
                if (inputData.gender) {
                    document.getElementById('gender').value = inputData.gender;
                    // 성별 버튼 업데이트
                    document.querySelectorAll('.gender-option').forEach(opt => {
                        opt.classList.remove('selected');
                        if (opt.dataset.gender === inputData.gender) {
                            opt.classList.add('selected');
                        }
                    });
                }
                if (inputData.calendar) {
                    // 달력 타입 업데이트
                    document.querySelectorAll('.calendar-option').forEach(opt => {
                        opt.classList.remove('selected');
                        if (opt.dataset.calendar === inputData.calendar) {
                            opt.classList.add('selected');
                        }
                    });
                }

                // 검증 실행
                validateName();
                validateBirthdate();
                validateTime();

                showToast('이전 입력 정보를 불러왔습니다', 'success');
                console.log('✅ 입력 데이터 폼 로드 완료');
            } catch (error) {
                console.error('❌ 입력 데이터 폼 로드 실패:', error);
                showToast('데이터 불러오기에 실패했습니다', 'error');
            }
        }

        // 저장된 결과를 결과 패널에 표시
        function loadSavedResult(resultData) {
            try {
                if (resultData.inputData && resultData.results) {
                    // 결과 표시
                    displayResults({
                        name: resultData.inputData.name,
                        birthInfo: resultData.inputData.birthInfo,
                        ...resultData.results
                    });

                    showToast('저장된 결과를 불러왔습니다', 'success');
                    console.log('✅ 저장된 결과 로드 완료');
                }
            } catch (error) {
                console.error('❌ 저장된 결과 로드 실패:', error);
                showToast('결과 불러오기에 실패했습니다', 'error');
            }
        }

        // 특정 저장 데이터 삭제
        function deleteSavedData(id, type = 'result') {
            try {
                if (type === 'result') {
                    const savedResults = getSavedResults();
                    const filteredResults = savedResults.filter(result => result.id !== id);
                    localStorage.setItem(STORAGE_KEYS.SAVED_RESULTS, JSON.stringify(filteredResults));
                } else if (type === 'input') {
                    const recentInputs = getRecentInputs();
                    const filteredInputs = recentInputs.filter(input => input.id !== id);
                    localStorage.setItem(STORAGE_KEYS.RECENT_INPUTS, JSON.stringify(filteredInputs));
                }

                showToast('데이터가 삭제되었습니다', 'success');
                console.log(`✅ ${type} 데이터 삭제 완료:`, id);
                return true;
            } catch (error) {
                console.error(`❌ ${type} 데이터 삭제 실패:`, error);
                showToast('삭제에 실패했습니다', 'error');
                return false;
            }
        }

        // 모든 저장된 데이터 지우기
        function clearAllSavedData() {
            try {
                localStorage.removeItem(STORAGE_KEYS.RECENT_INPUTS);
                localStorage.removeItem(STORAGE_KEYS.SAVED_RESULTS);

                showToast('모든 저장된 데이터가 삭제되었습니다', 'success');
                console.log('✅ 모든 저장 데이터 삭제 완료');
                return true;
            } catch (error) {
                console.error('❌ 모든 저장 데이터 삭제 실패:', error);
                showToast('데이터 삭제에 실패했습니다', 'error');
                return false;
            }
        }

        // 저장 공간 사용량 확인
        function getStorageUsage() {
            try {
                let totalSize = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        totalSize += localStorage[key].length;
                    }
                }

                const usage = {
                    totalSize: totalSize,
                    totalSizeKB: Math.round(totalSize / 1024 * 100) / 100,
                    recentInputsCount: getRecentInputs().length,
                    savedResultsCount: getSavedResults().length
                };

                console.log('📊 저장 공간 사용량:', usage);
                return usage;
            } catch (error) {
                console.error('❌ 저장 공간 사용량 확인 실패:', error);
                return null;
            }
        }

        // ========== 저장 기능 UI 함수들 ==========

        // 저장된 결과 목록 표시
        function showSavedResults() {
            console.log('📂 showSavedResults() 함수 호출됨');
            const savedResults = getSavedResults();
            console.log('저장된 결과 개수:', savedResults.length);
            console.log('저장된 결과 데이터:', savedResults);

            if (savedResults.length === 0) {
                showToast('저장된 결과가 없습니다.', 'info');
                return;
            }

            let html = '<div style="max-height: 400px; overflow-y: auto;"><h3>📂 저장된 결과 목록</h3>';
            savedResults.forEach((item, index) => {
                const date = new Date(item.timestamp).toLocaleString('ko-KR');
                html += `
                    <div style="border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 8px; background: #f9f9f9;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${item.inputData?.name || '익명'}님</strong> (${item.inputData?.gender === 'male' ? '남성' : '여성'})
                                <br><small style="color: #666;">${date}</small>
                            </div>
                            <div>
                                <button onclick="loadSavedResult('${item.id}')" style="background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 4px; margin-right: 5px; cursor: pointer;">불러오기</button>
                                <button onclick="deleteSavedResult('${item.id}')" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">삭제</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            // 모달 형태로 표시
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    ${html}
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">닫기</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 저장된 결과 불러오기
        function loadSavedResult(resultId) {
            const savedResults = getSavedResults();
            const result = savedResults.find(item => item.id === resultId);
            if (result) {
                displayResults(result.data);
                showToast('저장된 결과를 불러왔습니다.', 'success');
                // 모달 닫기
                const modal = document.querySelector('[style*="position: fixed"]');
                if (modal) modal.remove();
            }
        }

        // 저장된 결과 삭제
        function deleteSavedResult(resultId) {
            if (confirm('이 결과를 삭제하시겠습니까?')) {
                let savedResults = getSavedResults();
                savedResults = savedResults.filter(item => item.id !== resultId);
                localStorage.setItem(STORAGE_KEYS.SAVED_RESULTS, JSON.stringify(savedResults));
                showToast('결과가 삭제되었습니다.', 'success');
                showSavedResults(); // 목록 새로고침
            }
        }

        // JSON 내보내기
        function exportToJson() {
            const recentInputs = getRecentInputs();
            const savedResults = getSavedResults();
            const userPrefs = getUserPreferences();

            const exportData = {
                exportDate: new Date().toISOString(),
                version: "1.0",
                recentInputs: recentInputs,
                savedResults: savedResults,
                userPreferences: userPrefs
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `사주풀이_데이터_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('JSON 파일이 다운로드되었습니다.', 'success');
        }

        // 저장 데이터 전체 삭제
        function clearAllStorage() {
            if (confirm('모든 저장된 데이터를 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.')) {
                localStorage.removeItem(STORAGE_KEYS.RECENT_INPUTS);
                localStorage.removeItem(STORAGE_KEYS.SAVED_RESULTS);
                localStorage.removeItem(STORAGE_KEYS.USER_PREFERENCES);
                showToast('모든 저장 데이터가 삭제되었습니다.', 'success');
                updateStorageUsageDisplay();
            }
        }

        // 저장 공간 사용량 표시 업데이트
        function updateStorageUsageDisplay() {
            const usage = getStorageUsage();
            const usageElement = document.getElementById('storage-usage');
            if (usageElement && usage) {
                usageElement.textContent = `저장 공간: ${usage.totalSizeKB}KB (입력 ${usage.recentInputsCount}개, 결과 ${usage.savedResultsCount}개)`;
            }
        }

        // 저장 설정 초기화
        function initStoragePreferences() {
            const userPrefs = getUserPreferences();

            // 체크박스 상태 설정
            const autoSaveCheckbox = document.getElementById('auto-save-checkbox');
            const saveHistoryCheckbox = document.getElementById('save-history-checkbox');
            const storageStatus = document.getElementById('current-storage-status');

            if (autoSaveCheckbox) {
                autoSaveCheckbox.checked = userPrefs.autoSave;
                autoSaveCheckbox.addEventListener('change', function() {
                    const newPrefs = getUserPreferences();
                    newPrefs.autoSave = this.checked;
                    localStorage.setItem(STORAGE_KEYS.USER_PREFERENCES, JSON.stringify(newPrefs));
                    updateStorageStatus();
                    showToast(`자동 저장이 ${this.checked ? '활성화' : '비활성화'}되었습니다.`, 'info', 2000);
                });
            }

            if (saveHistoryCheckbox) {
                saveHistoryCheckbox.checked = userPrefs.saveHistory;
                saveHistoryCheckbox.addEventListener('change', function() {
                    const newPrefs = getUserPreferences();
                    newPrefs.saveHistory = this.checked;
                    newPrefs.maxHistoryItems = this.checked ? 10 : 0;
                    localStorage.setItem(STORAGE_KEYS.USER_PREFERENCES, JSON.stringify(newPrefs));
                    updateStorageStatus();
                    showToast(`계산 이력 저장이 ${this.checked ? '활성화' : '비활성화'}되었습니다.`, 'info', 2000);
                });
            }

            // 저장 상태 업데이트
            updateStorageStatus();
        }

        // 저장 상태 업데이트
        function updateStorageStatus() {
            const storageStatus = document.getElementById('current-storage-status');
            const usage = getStorageUsage();

            if (storageStatus && usage) {
                const userPrefs = getUserPreferences();
                let status = '';

                if (userPrefs.autoSave) {
                    status += '자동저장 ON';
                } else {
                    status += '자동저장 OFF';
                }

                if (userPrefs.saveHistory) {
                    status += ', 이력보관 ON';
                } else {
                    status += ', 이력보관 OFF';
                }

                status += ` (${usage.totalSizeKB}KB 사용)`;
                storageStatus.textContent = status;
            }
        }

        // ========== 입력 검증 및 도우미 함수들 ==========

        // 입력 진행 상태 관리
        let inputProgress = {
            name: false,
            birthdate: false,
            time: false,
            gender: true // 기본값이 있으므로 true
        };

        // 실시간 입력 검증 초기화
        function initInputValidation() {
            console.log('🔍 입력 검증 시스템 초기화');

            // 이름 입력 검증
            const nameInput = document.getElementById('name');
            if (nameInput) {
                nameInput.addEventListener('input', validateName);
                nameInput.addEventListener('blur', validateName);
            }

            // 생년월일 입력 검증
            const birthdateInput = document.getElementById('birthdate');
            if (birthdateInput) {
                birthdateInput.addEventListener('input', validateBirthdate);
                birthdateInput.addEventListener('change', validateBirthdate);
            }

            // 시간 입력 검증
            const timeInputs = ['birthHour', 'birthMinute'];
            timeInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', validateTime);
                }
            });

            // 성별 검증 (이미 기본값이 있으므로 유효)
            updateInputProgress('gender', true);

            console.log('✅ 입력 검증 시스템 준비 완료');
        }

        // 이름 검증
        function validateName() {
            const nameInput = document.getElementById('name');
            const value = nameInput.value.trim();
            const group = document.getElementById('name-group');

            clearValidation('name');

            if (!value) {
                showValidation('name', 'error', '이름을 입력해주세요');
                updateInputProgress('name', false);
                return false;
            }

            // 한글 이름 패턴 (2-4자)
            const koreanNamePattern = /^[가-힣]{2,4}$/;
            // 한자+한글 혼합 이름 패턴
            const mixedNamePattern = /^[가-힣一-龯]{2,5}$/;

            if (!koreanNamePattern.test(value) && !mixedNamePattern.test(value)) {
                showValidation('name', 'error', '한글 2-4자 또는 한자 이름을 입력해주세요');
                updateInputProgress('name', false);
                return false;
            }

            // 특수 문자 체크
            if (/[!@#$%^&*(),.?":{}|<>0-9]/.test(value)) {
                showValidation('name', 'error', '이름에는 특수문자나 숫자를 사용할 수 없습니다');
                updateInputProgress('name', false);
                return false;
            }

            showValidation('name', 'success', '올바른 이름 형식입니다');
            showFeedback('name', 'success', '✓', '유효한 이름');
            updateInputProgress('name', true);
            return true;
        }

        // 생년월일 검증
        function validateBirthdate() {
            const birthdateInput = document.getElementById('birthdate');
            const value = birthdateInput.value;

            clearValidation('birthdate');

            if (!value) {
                showValidation('birthdate', 'error', '생년월일을 선택해주세요');
                updateInputProgress('birthdate', false);
                return false;
            }

            const birthDate = new Date(value);
            const currentDate = new Date();
            const minDate = new Date('1900-01-01');

            if (birthDate < minDate) {
                showValidation('birthdate', 'error', '1900년 이후 출생자만 지원됩니다');
                updateInputProgress('birthdate', false);
                return false;
            }

            if (birthDate > currentDate) {
                showValidation('birthdate', 'error', '미래 날짜는 선택할 수 없습니다');
                updateInputProgress('birthdate', false);
                return false;
            }

            // 나이 계산
            const age = currentDate.getFullYear() - birthDate.getFullYear();
            if (age > 150) {
                showValidation('birthdate', 'warning', '입력하신 나이가 매우 높습니다. 확인해주세요');
                updateInputProgress('birthdate', true);
            } else {
                showValidation('birthdate', 'success', `만 ${age}세 (${birthDate.getFullYear()}년생)`);
                showFeedback('birthdate', 'success', '✓', '유효한 생년월일');
                updateInputProgress('birthdate', true);
            }

            return true;
        }

        // 시간 검증
        function validateTime() {
            const hourInput = document.getElementById('birthHour');
            const minuteInput = document.getElementById('birthMinute');
            const hourValue = hourInput.value;

            clearValidation('time');

            if (!hourValue) {
                showValidation('time', 'error', '출생 시간을 선택해주세요');
                updateInputProgress('time', false);
                return false;
            }

            if (hourValue === 'unknown') {
                showValidation('time', 'warning', '시간을 모르는 경우 자시(00시)로 계산됩니다');
                showFeedback('time', 'warning', '!', '시간 미상');
                updateInputProgress('time', true);
                return true;
            }

            const minuteValue = minuteInput.value || '0';
            const timeDisplay = `${String(hourValue).padStart(2, '0')}:${String(minuteValue).padStart(2, '0')}`;

            showValidation('time', 'success', `출생시간: ${timeDisplay} (${getTimeDescription(hourValue)})`);
            showFeedback('time', 'success', '✓', '유효한 시간');
            updateInputProgress('time', true);
            return true;
        }

        // 시간 설명 반환
        function getTimeDescription(hour) {
            const timeDescriptions = {
                '0': '자시 (밤 11시~1시)', '1': '축시 (밤 1시~3시)',
                '2': '축시 (밤 1시~3시)', '3': '인시 (새벽 3시~5시)',
                '4': '인시 (새벽 3시~5시)', '5': '묘시 (새벽 5시~7시)',
                '6': '묘시 (새벽 5시~7시)', '7': '진시 (아침 7시~9시)',
                '8': '진시 (아침 7시~9시)', '9': '사시 (오전 9시~11시)',
                '10': '사시 (오전 9시~11시)', '11': '오시 (오전 11시~1시)',
                '12': '오시 (낮 11시~1시)', '13': '미시 (오후 1시~3시)',
                '14': '미시 (오후 1시~3시)', '15': '신시 (오후 3시~5시)',
                '16': '신시 (오후 3시~5시)', '17': '유시 (오후 5시~7시)',
                '18': '유시 (오후 5시~7시)', '19': '술시 (저녁 7시~9시)',
                '20': '술시 (저녁 7시~9시)', '21': '해시 (밤 9시~11시)',
                '22': '해시 (밤 9시~11시)', '23': '자시 (밤 11시~1시)'
            };
            return timeDescriptions[hour] || '시간';
        }

        // 검증 메시지 표시
        function showValidation(fieldName, type, message) {
            const validationEl = document.getElementById(`${fieldName}-validation`);
            const groupEl = document.getElementById(`${fieldName}-group`);

            if (validationEl && groupEl) {
                validationEl.textContent = message;
                validationEl.className = `validation-message ${type} show`;

                groupEl.classList.remove('has-error', 'has-success');
                if (type === 'error') {
                    groupEl.classList.add('has-error');
                } else if (type === 'success') {
                    groupEl.classList.add('has-success');
                }
            }
        }

        // 검증 메시지 지우기
        function clearValidation(fieldName) {
            const validationEl = document.getElementById(`${fieldName}-validation`);
            const feedbackEl = document.getElementById(`${fieldName}-feedback`);
            const groupEl = document.getElementById(`${fieldName}-group`);

            if (validationEl) {
                validationEl.className = 'validation-message';
                validationEl.textContent = '';
            }

            if (feedbackEl) {
                feedbackEl.innerHTML = '';
            }

            if (groupEl) {
                groupEl.classList.remove('has-error', 'has-success');
            }
        }

        // 피드백 표시
        function showFeedback(fieldName, type, icon, text) {
            const feedbackEl = document.getElementById(`${fieldName}-feedback`);
            if (feedbackEl) {
                feedbackEl.innerHTML = `
                    <div class="feedback-icon ${type}">${icon}</div>
                    <span>${text}</span>
                `;
            }
        }

        // 진행 상태 업데이트
        function updateInputProgress(field, isValid) {
            inputProgress[field] = isValid;

            const steps = {
                name: 'step-name',
                birthdate: 'step-birth',
                time: 'step-time',
                gender: 'step-gender'
            };

            const stepEl = document.getElementById(steps[field]);
            const iconEl = stepEl?.querySelector('.step-icon');

            if (stepEl && iconEl) {
                stepEl.classList.remove('pending', 'current', 'completed');
                iconEl.classList.remove('pending', 'current', 'completed');

                if (isValid) {
                    stepEl.classList.add('completed');
                    iconEl.classList.add('completed');
                    iconEl.textContent = '✓';
                } else {
                    stepEl.classList.add('current');
                    iconEl.classList.add('current');
                    iconEl.textContent = Object.keys(inputProgress).indexOf(field) + 1;
                }
            }

            // 다음 단계 활성화
            updateNextStep();
        }

        // 다음 단계 업데이트
        function updateNextStep() {
            const fields = ['name', 'birthdate', 'time', 'gender'];
            let nextField = null;

            for (const field of fields) {
                if (!inputProgress[field]) {
                    nextField = field;
                    break;
                }
            }

            if (nextField) {
                const steps = {
                    name: 'step-name',
                    birthdate: 'step-birth',
                    time: 'step-time',
                    gender: 'step-gender'
                };

                // 모든 step을 pending으로 리셋
                Object.values(steps).forEach(stepId => {
                    const stepEl = document.getElementById(stepId);
                    const iconEl = stepEl?.querySelector('.step-icon');
                    if (stepEl && !inputProgress[Object.keys(steps).find(k => steps[k] === stepId)]) {
                        stepEl.classList.remove('current');
                        stepEl.classList.add('pending');
                        if (iconEl) {
                            iconEl.classList.remove('current');
                            iconEl.classList.add('pending');
                        }
                    }
                });

                // 현재 단계 활성화
                const currentStepEl = document.getElementById(steps[nextField]);
                const currentIconEl = currentStepEl?.querySelector('.step-icon');
                if (currentStepEl && currentIconEl) {
                    currentStepEl.classList.remove('pending');
                    currentStepEl.classList.add('current');
                    currentIconEl.classList.remove('pending');
                    currentIconEl.classList.add('current');
                }
            }

            // 계산 버튼 활성화/비활성화
            updateCalculateButton();
        }

        // 계산 버튼 상태 업데이트
        function updateCalculateButton() {
            const calculateBtn = document.querySelector('.calculate-btn');
            const allValid = Object.values(inputProgress).every(valid => valid);

            if (calculateBtn) {
                if (allValid) {
                    calculateBtn.disabled = false;
                    calculateBtn.style.opacity = '1';
                    calculateBtn.title = '모든 정보가 입력되었습니다. 계산을 시작하세요.';
                } else {
                    calculateBtn.disabled = true;
                    calculateBtn.style.opacity = '0.6';
                    calculateBtn.title = '모든 필수 정보를 입력해주세요.';
                }
            }
        }

        // 전체 폼 검증
        function validateForm() {
            const validations = [
                validateName(),
                validateBirthdate(),
                validateTime()
            ];

            return validations.every(result => result === true);
        }

        // ========== 대운 타임라인 함수들 ==========

        // 대운 타임라인 생성 함수
        function createDaeunTimeline(daeun, birthYear) {
            if (!daeun || !daeun.daeuns || daeun.daeuns.length === 0) {
                return '<p>대운 데이터를 가져올 수 없습니다.</p>';
            }

            const currentYear = new Date().getFullYear();
            const daeuns = daeun.daeuns.slice(0, 8); // 처음 8개 대운만 표시 (80년간)

            // 현재 대운 찾기
            let currentDaeun = null;
            let currentIndex = -1;

            for (let i = 0; i < daeuns.length; i++) {
                const startAge = daeun.startAge + (i * 10);
                const endAge = startAge + 9;
                const currentAge = currentYear - birthYear;

                if (currentAge >= startAge && currentAge <= endAge) {
                    currentDaeun = daeuns[i];
                    currentIndex = i;
                    break;
                }
            }

            // 대운별 설명 생성
            const daeunDescriptions = daeuns.map((daeunItem, index) => {
                const startAge = daeun.startAge + (index * 10);
                const endAge = startAge + 9;
                const startYear = birthYear + startAge;
                const endYear = birthYear + endAge;
                const isCurrent = index === currentIndex;
                const isPast = currentYear > endYear;
                const isFuture = currentYear < startYear;

                let status = 'future';
                if (isCurrent) status = 'current';
                else if (isPast) status = 'past';

                return {
                    ganji: daeunItem.gan + daeunItem.ji,
                    period: `${startYear}년 - ${endYear}년`,
                    age: `${startAge}세 - ${endAge}세`,
                    status: status,
                    description: getDaeunDescription(daeunItem.gan, daeunItem.ji),
                    position: (index / (daeuns.length - 1)) * 100 // 타임라인 위치
                };
            });

            return `
                <div class="daeun-timeline-container">
                    <div class="daeun-timeline-title">📅 대운 타임라인</div>

                    <!-- 현재 대운 요약 -->
                    <div class="daeun-summary">
                        <h4>🎯 현재 운세 정보</h4>
                        <p>현재 ${currentYear}년 기준으로 분석된 대운 정보입니다.</p>
                        <div class="daeun-current-info">
                            <div class="current-info-item">
                                <div class="current-info-value">
                                    ${currentDaeun ? currentDaeun.gan + currentDaeun.ji : '계산중'}
                                </div>
                                <div class="current-info-label">현재 대운</div>
                            </div>
                            <div class="current-info-item">
                                <div class="current-info-value">
                                    ${currentYear - birthYear}세
                                </div>
                                <div class="current-info-label">현재 나이</div>
                            </div>
                        </div>
                    </div>

                    <!-- 타임라인 축 -->
                    <div class="timeline-container">
                        <div class="timeline-axis">
                            <div class="timeline-points">
                                ${daeunDescriptions.map((item, index) => `
                                    <div class="timeline-point ${item.status}"
                                         style="left: ${item.position}%"
                                         title="${item.ganji} (${item.age})"></div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- 대운 카드들 -->
                    <div class="daeun-cards">
                        ${daeunDescriptions.map(item => `
                            <div class="daeun-card ${item.status}">
                                <div class="daeun-period">${item.period}</div>
                                <div class="daeun-ganji">${item.ganji}</div>
                                <div class="daeun-age">${item.age}</div>
                                <div class="daeun-description">${item.description}</div>
                                ${item.status === 'current' ? '<div style="position: absolute; top: 10px; right: 10px; background: var(--success-color); color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px;">현재</div>' : ''}
                            </div>
                        `).join('')}
                    </div>

                    <!-- 대운 해석 가이드 -->
                    <div style="margin-top: 25px; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid var(--secondary-color);">
                        <h4 style="margin-bottom: 15px; color: var(--secondary-color);">📚 대운 해석 가이드</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; font-size: 13px; line-height: 1.6;">
                            <div>
                                <strong>🌱 상생 관계:</strong><br>
                                일간과 대운이 서로 도우면 좋은 시기입니다.
                            </div>
                            <div>
                                <strong>⚡ 상극 관계:</strong><br>
                                일간과 대운이 충돌하면 변화의 시기입니다.
                            </div>
                            <div>
                                <strong>📈 길한 대운:</strong><br>
                                정관, 정인, 정재 등이 오면 안정적입니다.
                            </div>
                            <div>
                                <strong>⚠️ 흉한 대운:</strong><br>
                                상관, 칠살이 오면 조심스러운 시기입니다.
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 대운 설명 생성 함수
        function getDaeunDescription(gan, ji) {
            // 간지별 기본적인 설명 (실제로는 더 복잡한 로직이 필요)
            const ganDescriptions = {
                '갑': '적극적이고 창조적인 기운이 강한 시기',
                '을': '유연하고 성장 지향적인 시기',
                '병': '열정적이고 활동적인 시기',
                '정': '안정되고 온화한 시기',
                '무': '실용적이고 현실적인 시기',
                '기': '신중하고 보수적인 시기',
                '경': '결단력과 추진력이 필요한 시기',
                '신': '정교하고 세밀한 접근이 좋은 시기',
                '임': '지혜와 학습이 중요한 시기',
                '계': '직감과 감성이 중요한 시기'
            };

            const jiDescriptions = {
                '자': '새로운 시작과 학습의 기회',
                '축': '재물 관리와 안정에 집중',
                '인': '성장과 발전의 좋은 기회',
                '묘': '변화와 도전의 시기',
                '진': '권위와 지위 상승 가능',
                '사': '지혜와 통찰력 증진',
                '오': '활발한 활동과 사회적 인정',
                '미': '인간관계와 협력이 중요',
                '신': '새로운 계획과 추진력',
                '유': '완성과 결실의 시기',
                '술': '변화와 전환점',
                '해': '마무리와 정리의 시기'
            };

            const ganDesc = ganDescriptions[gan] || '운세 변화의 시기';
            const jiDesc = jiDescriptions[ji] || '새로운 경험의 시기';

            return `${ganDesc}입니다. ${jiDesc}로, 이 시기에는 차분히 계획을 세워 실행하시기 바랍니다.`;
        }

        // 대운 타임라인 애니메이션
        function animateDaeunTimeline() {
            setTimeout(() => {
                const timelinePoints = document.querySelectorAll('.timeline-point');
                timelinePoints.forEach((point, index) => {
                    setTimeout(() => {
                        point.style.transform = 'translateX(-50%) scale(0)';
                        point.style.opacity = '0';
                        setTimeout(() => {
                            point.style.transform = 'translateX(-50%) scale(1)';
                            point.style.opacity = '1';
                        }, 100);
                    }, index * 200);
                });
            }, 800);
        }

        // ========== 오행 차트 시각화 함수들 ==========

        // 오행 차트 생성 함수
        function createElementsChart(elements) {
            if (!elements) return '<p>오행 데이터를 가져올 수 없습니다.</p>';

            // 한국어 오행명을 영어로 변환
            const elementsEn = {
                wood: elements.목 || 0,
                fire: elements.화 || 0,
                earth: elements.토 || 0,
                metal: elements.금 || 0,
                water: elements.수 || 0
            };

            const total = elementsEn.wood + elementsEn.fire + elementsEn.earth + elementsEn.metal + elementsEn.water;
            if (total === 0) return '<p>오행 데이터가 없습니다.</p>';

            // 오행별 퍼센트 계산
            const percentages = {
                wood: Math.round((elementsEn.wood / total) * 100),
                fire: Math.round((elementsEn.fire / total) * 100),
                earth: Math.round((elementsEn.earth / total) * 100),
                metal: Math.round((elementsEn.metal / total) * 100),
                water: Math.round((elementsEn.water / total) * 100)
            };

            const elementsData = [
                { name: '목(木)', english: 'wood', count: elementsEn.wood, percentage: percentages.wood, description: '성장, 창조력' },
                { name: '화(火)', english: 'fire', count: elementsEn.fire, percentage: percentages.fire, description: '열정, 활동력' },
                { name: '토(土)', english: 'earth', count: elementsEn.earth, percentage: percentages.earth, description: '안정, 신용' },
                { name: '금(金)', english: 'metal', count: elementsEn.metal, percentage: percentages.metal, description: '결단, 정의' },
                { name: '수(水)', english: 'water', count: elementsEn.water, percentage: percentages.water, description: '지혜, 순응' }
            ];

            return `
                <div class="elements-chart-container">
                    <div class="elements-chart-title">🌟 오행 균형 분석</div>

                    <!-- 오행 분포 그리드 -->
                    <div class="elements-chart-grid">
                        ${elementsData.map(element => `
                            <div class="element-item ${element.english}">
                                <div class="element-name">${element.name}</div>
                                <div class="element-count">${element.count}</div>
                                <div class="element-percentage">${element.percentage}%</div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- 균형 바 차트 -->
                    <div class="balance-chart">
                        ${elementsData.map(element => `
                            <div class="balance-item">
                                <div class="balance-label">
                                    <span>${element.name} (${element.description})</span>
                                    <span>${element.count}개 (${element.percentage}%)</span>
                                </div>
                                <div class="balance-bar-container">
                                    <div class="balance-bar ${element.english}"
                                         style="width: ${element.percentage}%"
                                         data-percentage="${element.percentage}"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- 상생상극 관계 -->
                    <div class="elements-relation">
                        <div class="relation-title">오행 상생상극 관계</div>
                        <div class="relation-grid">
                            <div class="relation-section positive">
                                <h4>🌱 상생(相生) - 서로 돕는 관계</h4>
                                <div class="relation-list">
                                    목생화(木生火): 목이 화를 돕는다<br>
                                    화생토(火生土): 화가 토를 돕는다<br>
                                    토생금(土生金): 토가 금을 돕는다<br>
                                    금생수(金生水): 금이 수를 돕는다<br>
                                    수생목(水生木): 수가 목을 돕는다
                                </div>
                            </div>
                            <div class="relation-section negative">
                                <h4>⚡ 상극(相剋) - 서로 견제하는 관계</h4>
                                <div class="relation-list">
                                    목극토(木剋土): 목이 토를 억제한다<br>
                                    토극수(土剋水): 토가 수를 억제한다<br>
                                    수극화(水剋火): 수가 화를 억제한다<br>
                                    화극금(火剋金): 화가 금을 억제한다<br>
                                    금극목(金剋木): 금이 목을 억제한다
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 종합 평가 -->
                    <div class="elements-summary" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px;">📊 오행 균형 종합 평가</h4>
                        <p style="font-size: 14px; line-height: 1.6;">${generateElementsAnalysis(elements, percentages)}</p>
                    </div>
                </div>
            `;
        }

        // 오행 분석 텍스트 생성
        function generateElementsAnalysis(elements, percentages) {
            // 한국어 오행명을 영어로 변환
            const elementsEn = {
                wood: elements.목 || 0,
                fire: elements.화 || 0,
                earth: elements.토 || 0,
                metal: elements.금 || 0,
                water: elements.수 || 0
            };

            const total = elementsEn.wood + elementsEn.fire + elementsEn.earth + elementsEn.metal + elementsEn.water;
            let analysis = [];

            // 가장 강한 오행과 약한 오행 찾기
            const elementEntries = [
                ['목', elementsEn.wood, percentages.wood],
                ['화', elementsEn.fire, percentages.fire],
                ['토', elementsEn.earth, percentages.earth],
                ['금', elementsEn.metal, percentages.metal],
                ['수', elementsEn.water, percentages.water]
            ];

            elementEntries.sort((a, b) => b[1] - a[1]);
            const strongest = elementEntries[0];
            const weakest = elementEntries[4];

            if (strongest[1] > 0) {
                analysis.push(`가장 강한 오행은 <strong>${strongest[0]}(${strongest[2]}%)</strong>입니다.`);
            }

            if (weakest[1] === 0) {
                analysis.push(`<strong>${weakest[0]}</strong>이 부족하여 균형을 이루지 못하고 있습니다.`);
            }

            // 균형도 평가
            const maxPercentage = Math.max(...Object.values(percentages));
            const minPercentage = Math.min(...Object.values(percentages));
            const balanceDiff = maxPercentage - minPercentage;

            if (balanceDiff <= 30) {
                analysis.push('오행이 비교적 균형잡혀 있어 안정적인 운세를 나타냅니다.');
            } else if (balanceDiff <= 60) {
                analysis.push('오행 간 차이가 있어 특정 분야에서 두각을 나타낼 수 있습니다.');
            } else {
                analysis.push('오행 불균형이 크므로 보완이 필요한 영역이 있습니다.');
            }

            return analysis.join(' ');
        }

        // 오행 차트 애니메이션 시작
        function animateElementsChart() {
            setTimeout(() => {
                const balanceBars = document.querySelectorAll('.balance-bar');
                balanceBars.forEach((bar, index) => {
                    const percentage = bar.getAttribute('data-percentage');
                    setTimeout(() => {
                        bar.style.width = '0%';
                        setTimeout(() => {
                            bar.style.width = percentage + '%';
                        }, 100);
                    }, index * 200);
                });
            }, 500);
        }

        // 결과 표시 함수
        function displayResults(data) {
            console.log('📋 결과 표시 시작');

            const resultSection = document.querySelector('.result-section');
            if (!resultSection) {
                console.error('결과 섹션을 찾을 수 없습니다');
                return;
            }

            // 결과 HTML 생성
            const resultHtml = `
                <div class="saju-results">
                    <div class="storage-controls" style="text-align: right; margin-bottom: 20px; display: flex; gap: 10px; justify-content: space-between; align-items: center;">
                        <div class="storage-info" style="font-size: 12px; color: #666;">
                            <span id="storage-usage">저장 공간: 계산 중...</span>
                        </div>
                        <div class="storage-buttons">
                            <button type="button" class="storage-btn" onclick="showSavedResults()" style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-right: 8px;">
                                📂 저장된 결과 보기
                            </button>
                            <button type="button" class="storage-btn" onclick="exportToJson()" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-right: 8px;">
                                💾 JSON 내보내기
                            </button>
                            <button type="button" class="storage-btn" onclick="clearAllStorage()" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                🗑️ 저장 데이터 삭제
                            </button>
                        </div>
                    </div>
                    <h2>🔮 ${data.name}님의 사주팔자</h2>

                    <div class="birth-info">
                        <h3>📅 출생정보</h3>
                        <p>생년월일: ${data.birthInfo.birthdate}</p>
                        <p>출생시간: ${data.birthInfo.hour}시 ${data.birthInfo.minute}분</p>
                        <p>성별: ${data.gender === 'male' ? '남성' : '여성'}</p>
                        <p>달력: ${data.birthInfo.calendar === 'solar' ? '양력' : '음력'}</p>
                    </div>

                    <div class="saju-table">
                        <h3>🎯 사주팔자</h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center; margin: 20px 0;">
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                                <strong>년주</strong><br>
                                <span style="font-size: 18px; color: #1976d2; font-weight: bold;">
                                    ${data.saju?.year ? data.saju.year.gan + data.saju.year.ji : '계산중'}
                                </span>
                            </div>
                            <div style="background: #e8f5e8; padding: 15px; border-radius: 8px;">
                                <strong>월주</strong><br>
                                <span style="font-size: 18px; color: #2e7d32; font-weight: bold;">
                                    ${data.saju?.month ? data.saju.month.gan + data.saju.month.ji : '계산중'}
                                </span>
                            </div>
                            <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                                <strong>일주</strong><br>
                                <span style="font-size: 18px; color: #f57c00; font-weight: bold;">
                                    ${data.saju?.day ? data.saju.day.gan + data.saju.day.ji : '계산중'}
                                </span>
                            </div>
                            <div style="background: #fce4ec; padding: 15px; border-radius: 8px;">
                                <strong>시주</strong><br>
                                <span style="font-size: 18px; color: #c2185b; font-weight: bold;">
                                    ${data.saju?.hour ? data.saju.hour.gan + data.saju.hour.ji : '계산중'}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="elements-analysis">
                        ${data.elements ? createElementsChart(data.elements) : '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px;"><p>오행 분석 중...</p></div>'}
                    </div>

                    <div class="sipshin-analysis">
                        <h3>⚔️ 십신분석</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            ${data.sipshin ? formatSipshinDisplay(data.sipshin) : '십신 분석 중...'}
                        </div>
                    </div>

                    <div class="sinsaal-analysis">
                        <h3>🔮 신살분석</h3>
                        <div style="background: #f0f8ff; padding: 15px; border-radius: 8px;">
                            ${data.sinsaal ? formatSinsaalDisplay(data.sinsaal) : '신살 분석 중...'}
                        </div>
                    </div>

                    <div class="gyeokguk-analysis">
                        <h3>⚖️ 격국분석</h3>
                        <div style="background: #fff8e1; padding: 15px; border-radius: 8px;">
                            ${data.gyeokguk ? formatGyeokgukDisplay(data.gyeokguk) : '격국 분석 중...'}
                        </div>
                    </div>

                    <div class="daeun-analysis">
                        ${data.daeun ? createDaeunTimeline(data.daeun, new Date(data.birthInfo.birthdate).getFullYear()) : '<div style="background: #f3e5f5; padding: 15px; border-radius: 8px;"><p>대운 계산 중...</p></div>'}
                    </div>

                    <div class="saju-interpretation">
                        <h3>📜 기본 해석</h3>
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; line-height: 1.8;">
                            ${generateBasicInterpretation(data)}
                        </div>
                    </div>
                </div>
            `;

            resultSection.innerHTML = resultHtml;

            // 저장 공간 사용량 표시 업데이트
            updateStorageUsageDisplay();

            console.log('✅ 결과 표시 완료');
        }

        // 오행 분석 결과 포맷팅
        function formatElementsDisplay(elements) {
            const elementNames = {'목': '木', '화': '火', '토': '土', '금': '金', '수': '水'};
            const elementColors = {'목': '#4CAF50', '화': '#F44336', '토': '#FF9800', '금': '#FFC107', '수': '#2196F3'};

            let html = '<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 10px 0;">';

            Object.entries(elements).forEach(([element, value]) => {
                const percentage = ((value / 11.5) * 100).toFixed(1); // 전체 대비 퍼센트
                const strength = value >= 3 ? '왕' : value >= 1.5 ? '중' : '약';

                html += `
                    <div style="text-align: center; padding: 10px; border-radius: 6px; background: ${elementColors[element]}20; border: 2px solid ${elementColors[element]}40;">
                        <div style="font-size: 20px; color: ${elementColors[element]}; font-weight: bold;">${elementNames[element]}</div>
                        <div style="font-size: 14px; margin: 5px 0;">${Math.round(value * 10) / 10}개</div>
                        <div style="font-size: 12px; color: #666;">${strength}</div>
                    </div>
                `;
            });

            html += '</div>';

            // 오행 특성 해석
            const maxElement = Object.entries(elements).reduce((a, b) => elements[a[0]] > elements[b[0]] ? a : b);
            const minElement = Object.entries(elements).reduce((a, b) => elements[a[0]] < elements[b[0]] ? a : b);

            html += `<div style="margin-top: 15px; font-size: 14px; line-height: 1.6;">
                <strong>🎯 오행 특성:</strong><br>
                • <strong>${elementNames[maxElement[0]]} 기운이 가장 강함</strong> (${maxElement[1]}) - 활력과 추진력<br>
                • <strong>${elementNames[minElement[0]]} 기운이 약함</strong> (${minElement[1]}) - 보강이 필요한 영역<br>
                • 균형잡힌 오행 발달을 위해 ${elementNames[minElement[0]]} 관련 활동 권장
            </div>`;

            return html;
        }

        // 십신 분석 결과 포맷팅
        function formatSipshinDisplay(sipshin) {
            const sipshinDesc = {
                '비견': '동료, 형제, 경쟁자',
                '겁재': '라이벌, 파트너, 협력자',
                '식신': '표현력, 재능, 자식',
                '상관': '창의성, 예술, 자유로움',
                '편재': '유동적 재물, 기회',
                '정재': '안정적 재물, 관리능력',
                '편관': '도전, 압박, 변화',
                '정관': '명예, 지위, 책임감',
                '편인': '직관, 학문, 종교',
                '정인': '학습, 보호, 어머니'
            };

            let html = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">';

            // 천간 십신 (년, 월, 시간)
            html += `
                <div>
                    <h4 style="margin: 0 0 10px 0; color: #1976d2;">🌟 천간 (표면적 성향)</h4>
                    <div style="font-size: 14px; line-height: 1.8;">
                        • <strong>년주:</strong> ${sipshin.year || '미상'} - ${sipshinDesc[sipshin.year] || ''}.<br>
                        • <strong>월주:</strong> ${sipshin.month || '미상'} - ${sipshinDesc[sipshin.month] || ''}.<br>
                        • <strong>시주:</strong> ${sipshin.hour || '미상'} - ${sipshinDesc[sipshin.hour] || ''}.
                    </div>
                </div>
            `;

            // 지지 십신 (복합적 성향)
            html += `
                <div>
                    <h4 style="margin: 0 0 10px 0; color: #2e7d32;">🏮 지지 (내면적 잠재력)</h4>
                    <div style="font-size: 14px; line-height: 1.8;">
                        • <strong>년지:</strong> ${Array.isArray(sipshin.yearJi) ? sipshin.yearJi.join(', ') : (sipshin.yearJi || '미상')}<br>
                        • <strong>월지:</strong> ${Array.isArray(sipshin.monthJi) ? sipshin.monthJi.join(', ') : (sipshin.monthJi || '미상')}<br>
                        • <strong>일지:</strong> ${Array.isArray(sipshin.dayJi) ? sipshin.dayJi.join(', ') : (sipshin.dayJi || '미상')}<br>
                        • <strong>시지:</strong> ${Array.isArray(sipshin.hourJi) ? sipshin.hourJi.join(', ') : (sipshin.hourJi || '미상')}
                    </div>
                </div>
            `;

            html += '</div>';

            return html;
        }

        // 신살 분석 결과 포맷팅
        function formatSinsaalDisplay(sinsaal) {
            let html = `<div style="margin-bottom: 15px;">
                <h4 style="color: #6a1b9a; margin: 0 0 10px 0;">📊 신살 현황</h4>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
                    <div style="text-align: center; background: #e8f5e8; padding: 8px; border-radius: 5px;">
                        <strong style="color: #2e7d32;">길신</strong><br>
                        <span style="font-size: 18px; font-weight: bold;">${sinsaal.good.length}개</span>
                    </div>
                    <div style="text-align: center; background: #ffebee; padding: 8px; border-radius: 5px;">
                        <strong style="color: #c62828;">흉신</strong><br>
                        <span style="font-size: 18px; font-weight: bold;">${sinsaal.bad.length}개</span>
                    </div>
                    <div style="text-align: center; background: #fff3e0; padding: 8px; border-radius: 5px;">
                        <strong style="color: #f57c00;">중성</strong><br>
                        <span style="font-size: 18px; font-weight: bold;">${sinsaal.mixed.length}개</span>
                    </div>
                    <div style="text-align: center; background: #f3e5f5; padding: 8px; border-radius: 5px;">
                        <strong style="color: #6a1b9a;">총계</strong><br>
                        <span style="font-size: 18px; font-weight: bold;">${sinsaal.total}개</span>
                    </div>
                </div>
                <p style="color: #555; font-style: italic; margin: 0;">${sinsaal.summary}</p>
            </div>`;

            // 길신 표시
            if (sinsaal.good.length > 0) {
                html += `<div style="margin-bottom: 15px;">
                    <h4 style="color: #2e7d32; margin: 0 0 8px 0;">✨ 길신 (${sinsaal.good.length}개)</h4>
                    <div style="background: #e8f5e8; padding: 10px; border-radius: 5px; border-left: 4px solid #4caf50;">`;

                sinsaal.good.forEach(sin => {
                    html += `<div style="margin-bottom: 8px; font-size: 14px;">
                        <strong style="color: #2e7d32;">${sin.name}</strong> (${sin.position}) - ${sin.description}
                    </div>`;
                });

                html += `</div></div>`;
            }

            // 흉신 표시
            if (sinsaal.bad.length > 0) {
                html += `<div style="margin-bottom: 15px;">
                    <h4 style="color: #c62828; margin: 0 0 8px 0;">⚠️ 흉신 (${sinsaal.bad.length}개)</h4>
                    <div style="background: #ffebee; padding: 10px; border-radius: 5px; border-left: 4px solid #f44336;">`;

                sinsaal.bad.forEach(sin => {
                    html += `<div style="margin-bottom: 8px; font-size: 14px;">
                        <strong style="color: #c62828;">${sin.name}</strong> (${sin.position}) - ${sin.description}
                    </div>`;
                });

                html += `</div></div>`;
            }

            // 중성신 표시
            if (sinsaal.mixed.length > 0) {
                html += `<div style="margin-bottom: 15px;">
                    <h4 style="color: #f57c00; margin: 0 0 8px 0;">🔄 중성신 (${sinsaal.mixed.length}개)</h4>
                    <div style="background: #fff3e0; padding: 10px; border-radius: 5px; border-left: 4px solid #ff9800;">`;

                sinsaal.mixed.forEach(sin => {
                    html += `<div style="margin-bottom: 8px; font-size: 14px;">
                        <strong style="color: #f57c00;">${sin.name}</strong> (${sin.position}) - ${sin.description}
                    </div>`;
                });

                html += `</div></div>`;
            }

            // 신살이 없는 경우
            if (sinsaal.total === 0) {
                html += `<div style="text-align: center; padding: 20px; color: #666;">
                    특별한 신살이 발견되지 않았습니다.<br>
                    <small>평범하고 안정적인 운세를 의미할 수 있습니다.</small>
                </div>`;
            }

            return html;
        }

        // 격국 분석 결과 포맷팅
        function formatGyeokgukDisplay(gyeokguk) {
            let html = `<div style="margin-bottom: 20px;">`;

            // 메인 격국 정보
            if (gyeokguk.mainFormat) {
                const format = gyeokguk.mainFormat;
                const strengthColor = format.strength >= 80 ? '#2e7d32' :
                                     format.strength >= 60 ? '#f57c00' : '#c62828';

                html += `<div style="margin-bottom: 15px;">
                    <h4 style="color: ${strengthColor}; margin: 0 0 10px 0;">
                        🏛️ 주격국: ${format.name} (강도: ${format.strength}/100)
                    </h4>
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 4px solid ${strengthColor};">
                        <p style="margin: 0 0 8px 0; font-weight: 500;">${format.description}</p>
                        ${format.baseSpirit ? `<small style="color: #666;">기준 십신: ${format.baseSpirit}</small>` : ''}
                    </div>
                </div>`;

                // 성격 조건 분석
                if (format.conditions) {
                    html += `<div style="margin-bottom: 15px;">
                        <h5 style="margin: 0 0 8px 0; color: #555;">📋 성격 조건</h5>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 13px;">`;

                    Object.entries(format.conditions).forEach(([key, value]) => {
                        const icon = value ? '✅' : '❌';
                        const conditionNames = {
                            '월지조건': '월지 본기',
                            '투간조건': '천간 투출',
                            '근기조건': '지지 근기',
                            '계절조건': '계절성'
                        };

                        html += `<div style="display: flex; align-items: center;">
                            ${icon} <span style="margin-left: 5px;">${conditionNames[key] || key}</span>
                        </div>`;
                    });

                    html += `</div></div>`;
                }

                // 격국별 함의
                if (gyeokguk.implications) {
                    const impl = gyeokguk.implications;
                    html += `<div style="margin-bottom: 15px;">
                        <h5 style="margin: 0 0 8px 0; color: #555;">🎯 격국 함의</h5>
                        <div style="background: #e8f5e8; padding: 12px; border-radius: 6px;">
                            <div style="margin-bottom: 10px; font-size: 14px; line-height: 1.6;">
                                <strong>종합:</strong> ${impl.summary}
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                                <div>
                                    <strong style="color: #2e7d32;">💼 적성:</strong><br>
                                    ${impl.career}
                                </div>
                                <div>
                                    <strong style="color: #1976d2;">💰 재물:</strong><br>
                                    ${impl.wealth}
                                </div>
                            </div>
                            <div style="margin-top: 10px; font-size: 13px;">
                                <strong style="color: #7b1fa2;">❤️ 인간관계:</strong> ${impl.relationship}
                            </div>
                        </div>
                    </div>`;
                }

            } else {
                // 격국이 성립되지 않는 경우
                html += `<div style="text-align: center; padding: 20px; color: #666;">
                    <h4 style="margin: 0 0 10px 0; color: #f57c00;">🔄 복합격</h4>
                    <p style="margin: 0; line-height: 1.6;">
                        명확한 정격이 성립되지 않았습니다.<br>
                        <small>다양한 가능성을 가진 복합적 성격입니다.</small>
                    </p>
                </div>`;
            }

            // 특수격 정보
            if (gyeokguk.specialFormats && gyeokguk.specialFormats.length > 0) {
                html += `<div style="margin-top: 15px;">
                    <h5 style="margin: 0 0 8px 0; color: #7b1fa2;">🌟 특수격 정보</h5>`;

                gyeokguk.specialFormats.forEach(special => {
                    html += `<div style="background: #f3e5f5; padding: 10px; border-radius: 5px; margin-bottom: 8px;">
                        <strong style="color: #7b1fa2;">${special.name}</strong> (강도: ${special.strength}/100)
                        <div style="font-size: 13px; margin-top: 4px; color: #555;">
                            ${special.description}
                        </div>
                    </div>`;
                });

                html += `</div>`;
            }

            html += `</div>`;

            return html;
        }

        // 대운 분석 결과 포맷팅
        function formatDaeunDisplay(daeun) {
            if (!daeun || !daeun.periods || daeun.periods.length === 0) {
                return `<div style="text-align: center; padding: 20px; color: #666;">
                    대운 정보를 계산할 수 없습니다.
                </div>`;
            }

            let html = `<div>`;

            // 대운 시작 정보
            html += `<div style="margin-bottom: 15px; padding: 12px; background: #e8f5e8; border-radius: 6px;">
                <h4 style="margin: 0 0 8px 0; color: #2e7d32;">📊 대운 개요</h4>
                <div style="font-size: 14px; color: #555;">
                    • <strong>대운 시작:</strong> ${daeun.startAge}세부터 시작<br>
                    • <strong>대운 방향:</strong> ${daeun.direction === 'forward' ? '순행 (→)' : '역행 (←)'}<br>
                    • <strong>총 대운 수:</strong> ${daeun.periods.length}개 (10년 단위)
                </div>
            </div>`;

            // 현재 대운 강조 표시
            const currentDaeun = daeun.periods.find(period => period.isCurrent);
            if (currentDaeun) {
                html += `<div style="margin-bottom: 15px; padding: 12px; background: #fff3e0; border-radius: 6px; border: 2px solid #ff9800;">
                    <h4 style="margin: 0 0 8px 0; color: #f57c00;">🎯 현재 대운 (${new Date().getFullYear() - currentDaeun.ageStart}년차)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px; align-items: center;">
                        <div style="text-align: center; padding: 10px; background: #fff; border-radius: 4px;">
                            <div style="font-size: 24px; font-weight: bold; color: #f57c00;">
                                ${currentDaeun.gan}${currentDaeun.ji}
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                ${currentDaeun.ageStart}세 ~ ${currentDaeun.ageEnd}세
                            </div>
                        </div>
                        <div style="font-size: 13px; line-height: 1.6;">
                            <div><strong>천간:</strong> ${currentDaeun.ganMeaning || currentDaeun.gan}</div>
                            <div><strong>지지:</strong> ${currentDaeun.jiMeaning || currentDaeun.ji}</div>
                            ${currentDaeun.sipshin ? `<div><strong>십신:</strong> ${currentDaeun.sipshin}</div>` : ''}
                        </div>
                    </div>
                </div>`;
            }

            // 전체 대운 목록
            html += `<div style="margin-bottom: 15px;">
                <h4 style="margin: 0 0 12px 0; color: #7b1fa2;">📋 전체 대운 목록</h4>
                <div style="display: grid; gap: 8px;">`;

            daeun.periods.forEach((period, index) => {
                const isCurrentStyle = period.isCurrent ?
                    'background: #fff3e0; border: 2px solid #ff9800; font-weight: 500;' :
                    'background: #f8f9fa; border: 1px solid #dee2e6;';

                html += `<div style="padding: 8px 12px; border-radius: 5px; font-size: 13px; ${isCurrentStyle}">
                    <div style="display: grid; grid-template-columns: 60px 80px 1fr auto; gap: 12px; align-items: center;">
                        <div style="text-align: center;">
                            <strong style="font-size: 16px;">${period.gan}${period.ji}</strong>
                        </div>
                        <div style="color: #666;">
                            ${period.ageStart}~${period.ageEnd}세
                        </div>
                        <div style="color: #555;">
                            ${period.sipshin ? period.sipshin + ' 운' : '기본운'}
                        </div>
                        <div style="color: ${period.isCurrent ? '#f57c00' : '#999'}; font-size: 12px;">
                            ${period.isCurrent ? '현재' : ''}
                        </div>
                    </div>
                </div>`;
            });

            html += `</div></div>`;

            // 대운 해석 가이드
            html += `<div style="background: #e8f5e8; padding: 10px; border-radius: 5px; font-size: 12px; color: #555;">
                <strong>💡 대운 해석 가이드:</strong><br>
                • 대운은 10년 단위로 인생의 큰 흐름을 보여줍니다<br>
                • 현재 대운의 천간·지지를 통해 현재 시기의 특성을 파악할 수 있습니다<br>
                • 대운과 원국의 조화를 보면 더 정확한 운세를 알 수 있습니다
            </div>`;

            html += `</div>`;

            return html;
        }

        // 기본 해석 생성 - 상세 보고서 형태로 개선
        function generateBasicInterpretation(data) {
            if (!data.saju || !data.elements) {
                return '사주 분석이 완료되지 않았습니다.';
            }

            const dayGan = data.saju.day?.gan;
            const dayJi = data.saju.day?.ji;
            const maxElement = Object.entries(data.elements).reduce((a, b) => data.elements[a[0]] > data.elements[b[0]] ? a : b);
            const minElement = Object.entries(data.elements).reduce((a, b) => data.elements[a[0]] < data.elements[b[0]] ? a : b);

            // 현재 나이 계산
            const currentYear = new Date().getFullYear();
            const birthYear = data.birthInfo.birthdate ? parseInt(data.birthInfo.birthdate.split('-')[0]) : '미상';
            const currentAge = currentYear - birthYear;

            let interpretation = `
                <div class="detailed-interpretation-container">
                    <h3>📋 ${data.name}님의 종합 사주 분석 보고서</h3>

                    <div class="interpretation-section">
                        <h4>📊 기본 정보</h4>
                        <div class="info-grid">
                            <div class="info-item">
                                <strong>성명:</strong> ${data.name}님
                            </div>
                            <div class="info-item">
                                <strong>생년월일:</strong> ${data.birthInfo.birthdate || '미상'} (현재 ${currentAge}세)
                            </div>
                            <div class="info-item">
                                <strong>성별:</strong> ${data.gender === 'male' ? '남성' : '여성'}
                            </div>
                            <div class="info-item">
                                <strong>일주:</strong> ${dayGan}${dayJi}일주
                            </div>
                        </div>
                    </div>

                    <div class="interpretation-section">
                        <h4>🎯 핵심 성격 분석</h4>
                        <div class="personality-analysis">
                            <h5>💎 타고난 성향 (일간 ${dayGan})</h5>
                            <p><strong>${getDayGanTitle(dayGan)}</strong></p>
                            <p>${getDayGanDetailedInterpretation(dayGan)}</p>

                            <h5>🏠 내면의 세계 (일지 ${dayJi})</h5>
                            <p>${getDayJiInterpretation(dayJi)}</p>
                        </div>
                    </div>

                    <div class="interpretation-section">
                        <h4>⚖️ 오행 균형 분석</h4>
                        <div class="elements-analysis">
                            <h5>🔥 가장 강한 기운: ${maxElement[0]}(${Math.round(maxElement[1]/Object.values(data.elements).reduce((a,b)=>a+b,0)*100)}%)</h5>
                            <p>${getDetailedElementAnalysis(maxElement[0], 'strong')}</p>

                            <h5>💧 가장 부족한 기운: ${minElement[0]}(${Math.round(minElement[1]/Object.values(data.elements).reduce((a,b)=>a+b,0)*100)}%)</h5>
                            <p>${getDetailedElementAnalysis(minElement[0], 'weak')}</p>

                            <h5>📈 오행 균형도</h5>
                            <p>${getDetailedBalanceInterpretation(data.elements)}</p>
                        </div>
                    </div>

                    <div class="interpretation-section">
                        <h4>💼 직업 & 적성 분석</h4>
                        <div class="career-analysis">
                            <h5>🎯 추천 직업군</h5>
                            <p>${getDetailedCareerAdvice(data.sipshin, maxElement[0], dayGan)}</p>

                            <h5>💰 재물운 분석</h5>
                            <p>${getWealthAnalysis(data.sipshin, data.elements)}</p>

                            <h5>🤝 인간관계 특성</h5>
                            <p>${getRelationshipAnalysis(data.sipshin, dayGan)}</p>
                        </div>
                    </div>

                    <div class="interpretation-section">
                        <h4>⚠️ 주의사항 & 개선방향</h4>
                        <div class="caution-analysis">
                            <h5>🚨 주의할 점</h5>
                            <p>${getCautionAdvice(dayGan, maxElement[0], data.sinsaal)}</p>

                            <h5>💡 개선 방향</h5>
                            <p>${getImprovementAdvice(minElement[0], data.elements)}</p>
                        </div>
                    </div>

                    <div class="interpretation-section">
                        <h4>🌟 인생 총평</h4>
                        <div class="life-summary">
                            <p>${getLifeSummary(data)}</p>
                        </div>
                    </div>
                </div>
            `;

            return interpretation;
        }

        // 일간 해석
        function getDayGanInterpretation(dayGan) {
            const interpretations = {
                '갑': '큰 나무처럼 곧고 정직하며 리더십이 강한',
                '을': '꽃과 같이 부드럽고 섬세하며 적응력이 뛰어난',
                '병': '태양같이 밝고 활동적이며 표현력이 풍부한',
                '정': '촛불같이 따뜻하고 세심하며 예술적 감각이 뛰어난',
                '무': '산같이 든든하고 믿음직하며 포용력이 큰',
                '기': '땅같이 온화하고 실용적이며 협조적인',
                '경': '칼같이 날카롭고 결단력이 있으며 정의로운',
                '신': '보석같이 세련되고 변화를 추구하며 감각적인',
                '임': '바다같이 포용력이 크고 지혜로우며 유연한',
                '계': '이슬같이 순수하고 감성적이며 직관력이 뛰어난'
            };
            return interpretations[dayGan] || '독특하고 개성적인';
        }

        // 오행 특성 해석
        function getElementCharacter(element) {
            const characters = {
                '목': '성장하고 발전하려는 의욕과 창의적',
                '화': '열정적이고 적극적인 추진력과 표현력',
                '토': '안정을 추구하고 신중하며 포용적',
                '금': '원칙을 중시하고 정의로우며 완벽주의적',
                '수': '지혜롭고 유연하며 적응력이 뛰어난'
            };
            return characters[element] || '균형잡힌';
        }

        // 오행 균형 해석
        function getBalanceInterpretation(elements) {
            const values = Object.values(elements);
            const max = Math.max(...values);
            const min = Math.min(...values);
            const diff = max - min;

            if (diff <= 1) return '매우 균형잡힌';
            if (diff <= 2) return '비교적 균형잡힌';
            if (diff <= 3) return '약간 편중된';
            return '다소 불균형한';
        }

        // 인생 조언
        function getLifeAdvice(dayGan, strongElement) {
            const advices = {
                '갑': '리더십을 발휘하되 독선적이지 않도록 주의하세요.',
                '을': '유연성을 살려 다양한 분야에서 활동해보세요.',
                '병': '밝은 에너지로 많은 사람들에게 영향을 주세요.',
                '정': '섬세한 감각을 활용한 창작활동이 유리합니다.',
                '무': '신뢰를 바탕으로 한 장기적 관계를 중시하세요.',
                '기': '실용적 능력을 살려 안정적 기반을 구축하세요.',
                '경': '정의감을 바탕으로 한 일관된 원칙을 지키세요.',
                '신': '변화를 두려워하지 말고 새로운 도전을 시도하세요.',
                '임': '포용력과 지혜로 주변을 이끌어가세요.',
                '계': '직감을 믿고 감성적 능력을 개발하세요.'
            };
            return advices[dayGan] || '자신만의 독특한 개성을 발휘하세요.';
        }

        // === 상세 해석 함수들 추가 ===

        // 일간 타이틀
        function getDayGanTitle(dayGan) {
            const titles = {
                '갑': '큰 나무의 리더 - 정직하고 곧은 성품',
                '을': '꽃과 풀의 조화자 - 부드럽고 섬세한 성품',
                '병': '태양의 열정가 - 밝고 적극적인 성품',
                '정': '촛불의 예술가 - 따뜻하고 세심한 성품',
                '무': '높은 산의 수호자 - 든든하고 포용적인 성품',
                '기': '넓은 땅의 협력자 - 온화하고 실용적인 성품',
                '경': '예리한 칼의 정의자 - 날카롭고 원칙적인 성품',
                '신': '빛나는 보석의 개혁자 - 세련되고 변화지향적 성품',
                '임': '넓은 바다의 포용자 - 유연하고 지혜로운 성품',
                '계': '맑은 이슬의 직관자 - 순수하고 감성적인 성품'
            };
            return titles[dayGan] || '독특한 개성의 소유자';
        }

        // 일간 상세 해석
        function getDayGanDetailedInterpretation(dayGan) {
            const interpretations = {
                '갑': '당신은 큰 나무처럼 곧고 정직한 성품을 가지고 있습니다. 타고난 리더십으로 사람들을 이끄는 능력이 뛰어나며, 책임감이 강하고 신념이 확고합니다. 다만 때로는 고집이 세거나 융통성이 부족할 수 있어 다른 사람의 의견에도 귀 기울이는 것이 중요합니다.',
                '을': '꽃과 풀처럼 부드럽고 섬세한 감성을 가진 당신은 뛰어난 적응력과 조화로운 인간관계를 만드는 재능이 있습니다. 예술적 감각이 뛰어나고 타인의 마음을 잘 이해하지만, 때로는 우유부단하거나 자신의 의견을 명확히 표현하지 못할 수 있습니다.',
                '병': '태양처럼 밝고 열정적인 에너지를 가진 당신은 어디서든 중심이 되는 매력적인 인물입니다. 표현력이 뛰어나고 사람들에게 희망과 활력을 주는 능력이 있지만, 때로는 성급하거나 감정적일 수 있어 신중함이 필요합니다.',
                '정': '촛불처럼 따뜻하고 세심한 당신은 예술적 재능과 섬세한 감각을 가지고 있습니다. 배려심이 깊고 디테일을 중시하는 완벽주의적 성향이 있지만, 때로는 걱정이 많거나 신경질적일 수 있어 마음의 평안을 찾는 것이 중요합니다.',
                '무': '높은 산처럼 든든하고 믿음직한 당신은 포용력이 크고 신뢰를 받는 인물입니다. 안정감을 주고 꾸준히 노력하는 성실함이 있지만, 때로는 변화를 거부하거나 고집스러울 수 있어 유연성을 기르는 것이 좋습니다.',
                '기': '비옥한 땅처럼 온화하고 실용적인 당신은 협조정신이 뛰어나고 현실감각이 좋습니다. 누구와도 잘 어울리고 실질적인 도움을 주는 능력이 있지만, 때로는 우유부단하거나 자신만의 주관이 부족할 수 있습니다.',
                '경': '예리한 칼처럼 명확하고 원칙적인 당신은 정의감이 강하고 결단력이 뛰어납니다. 논리적 사고와 추진력이 강하지만, 때로는 너무 날카롭거나 융통성이 부족할 수 있어 부드러운 소통이 필요합니다.',
                '신': '빛나는 보석처럼 세련되고 변화를 추구하는 당신은 감각이 뛰어나고 새로운 것을 받아들이는 능력이 좋습니다. 창의적이고 유행에 민감하지만, 때로는 변덕스럽거나 일관성이 부족할 수 있어 꾸준함이 필요합니다.',
                '임': '넓은 바다처럼 포용력이 크고 지혜로운 당신은 깊이 있는 사고와 유연한 적응력을 가지고 있습니다. 통찰력이 뛰어나고 다양한 관점을 이해하지만, 때로는 우유부단하거나 깊이 생각하느라 행동이 늦을 수 있습니다.',
                '계': '맑은 이슬처럼 순수하고 직관적인 당신은 감성이 풍부하고 영감을 받는 능력이 뛰어납니다. 섬세하고 감수성이 풍부하지만, 때로는 감정적 기복이 크거나 현실감각이 부족할 수 있어 균형을 맞추는 것이 중요합니다.'
            };
            return interpretations[dayGan] || '독특하고 개성적인 성향을 가지고 있습니다.';
        }

        // 일지 해석
        function getDayJiInterpretation(dayJi) {
            const interpretations = {
                '자': '지혜롭고 신중한 내면을 가지고 있으며, 깊이 있는 사고력과 직감력이 뛰어납니다.',
                '축': '성실하고 책임감이 강한 내면으로, 꾸준한 노력과 인내심이 뛰어납니다.',
                '인': '활동적이고 진취적인 내면을 가지며, 새로운 시작과 도전을 즐깁니다.',
                '묘': '온화하고 조화로운 내면으로, 평화를 추구하고 예술적 감각이 뛰어납니다.',
                '진': '변화무쌍하고 역동적인 내면을 가지며, 적응력과 창의력이 뛰어납니다.',
                '사': '열정적이고 지혜로운 내면으로, 통찰력과 표현력이 뛰어납니다.',
                '오': '밝고 적극적인 내면을 가지며, 리더십과 추진력이 강합니다.',
                '미': '포용적이고 배려심 깊은 내면으로, 조화와 안정을 중시합니다.',
                '신': '개혁적이고 진보적인 내면을 가지며, 변화와 발전을 추구합니다.',
                '유': '세련되고 완벽주의적인 내면으로, 질서와 정확성을 중시합니다.',
                '술': '보수적이면서도 충성스러운 내면을 가지며, 신뢰성과 안정성을 추구합니다.',
                '해': '순수하고 감성적인 내면으로, 직관력과 포용력이 뛰어납니다.'
            };
            return interpretations[dayJi] || '독특한 내면의 세계를 가지고 있습니다.';
        }

        // 상세 오행 분석
        function getDetailedElementAnalysis(element, type) {
            const analysis = {
                '목': {
                    strong: '성장과 발전을 추구하는 강한 의지력을 가지고 있습니다. 창의력과 기획력이 뛰어나며, 새로운 아이디어를 현실로 만드는 능력이 있습니다. 교육, 출판, 환경 분야에서 특히 두각을 나타낼 수 있습니다.',
                    weak: '목 기운이 부족하여 창의력과 성장 동력이 부족할 수 있습니다. 새로운 시작을 어려워하거나 변화에 소극적일 수 있으니, 독서나 새로운 학습을 통해 목 기운을 보강하는 것이 좋습니다.'
                },
                '화': {
                    strong: '열정과 활동력이 매우 강하여 어떤 일이든 적극적으로 추진하는 능력이 있습니다. 표현력과 리더십이 뛰어나며, 사람들을 이끄는 카리스마가 있습니다. 방송, 연예, 광고 분야에서 성공할 가능성이 높습니다.',
                    weak: '화 기운이 부족하여 열정과 추진력이 부족할 수 있습니다. 소극적이거나 표현력이 부족할 수 있으니, 운동이나 적극적인 사회활동을 통해 화 기운을 보강하는 것이 좋습니다.'
                },
                '토': {
                    strong: '안정감과 신뢰성이 매우 높아 주변 사람들의 든든한 버팀목이 됩니다. 실용적이고 현실적인 판단력이 뛰어나며, 부동산이나 금융 분야에서 좋은 성과를 낼 수 있습니다.',
                    weak: '토 기운이 부족하여 안정감이나 지속력이 부족할 수 있습니다. 변덕스럽거나 일관성이 부족할 수 있으니, 규칙적인 생활과 꾸준한 노력을 통해 토 기운을 보강하는 것이 좋습니다.'
                },
                '금': {
                    strong: '원칙과 정의를 중시하는 확고한 신념을 가지고 있습니다. 분석력과 판단력이 뛰어나며, 전문 분야에서 높은 성취를 이룰 수 있습니다. 법무, 의료, 기술 분야에서 탁월한 능력을 발휘할 수 있습니다.',
                    weak: '금 기운이 부족하여 결단력이나 추진력이 부족할 수 있습니다. 우유부단하거나 완성도가 떨어질 수 있으니, 명확한 목표 설정과 체계적인 계획을 통해 금 기운을 보강하는 것이 좋습니다.'
                },
                '수': {
                    strong: '지혜와 유연성이 뛰어나 어떤 상황에서도 적절히 대응할 수 있는 능력이 있습니다. 직감력과 통찰력이 뛰어나며, 연구나 상담 분야에서 특별한 재능을 발휘할 수 있습니다.',
                    weak: '수 기운이 부족하여 지혜나 유연성이 부족할 수 있습니다. 고집스럽거나 적응력이 떨어질 수 있으니, 독서나 명상을 통해 내면의 지혜를 기르는 것이 좋습니다.'
                }
            };
            return analysis[element] ? analysis[element][type] : '균형잡힌 특성을 가지고 있습니다.';
        }

        // 상세 균형 해석
        function getDetailedBalanceInterpretation(elements) {
            const total = Object.values(elements).reduce((a, b) => a + b, 0);
            const ratios = Object.entries(elements).map(([element, value]) => [element, value/total]);
            const max = Math.max(...ratios.map(r => r[1]));
            const min = Math.min(...ratios.map(r => r[1]));
            const diff = max - min;

            if (diff <= 0.2) {
                return '매우 균형잡힌 오행 구조로, 안정적이고 조화로운 인생을 살아갈 가능성이 높습니다. 다양한 분야에서 고른 능력을 발휘할 수 있으며, 큰 기복 없이 꾸준한 발전을 이룰 수 있습니다.';
            } else if (diff <= 0.3) {
                return '비교적 균형잡힌 오행 구조를 가지고 있어, 전반적으로 안정적인 삶을 살 수 있습니다. 특정 분야에서 특별한 재능을 보이면서도 다른 영역에서도 어느 정도의 능력을 발휘할 수 있습니다.';
            } else if (diff <= 0.4) {
                return '약간 편중된 오행 구조로, 특정 분야에서 뛰어난 재능을 보일 가능성이 높습니다. 강한 분야를 중심으로 전문성을 기르되, 부족한 부분을 보완하는 노력이 필요합니다.';
            } else {
                return '다소 불균형한 오행 구조로, 특정 분야에서 탁월한 능력을 보이지만 다른 영역에서는 어려움을 겪을 수 있습니다. 강점을 극대화하면서 약점을 보완하는 전략적 접근이 중요합니다.';
            }
        }

        // 상세 직업 조언
        function getDetailedCareerAdvice(sipshin, strongElement, dayGan) {
            const elementCareers = {
                '목': '교육업, 출판업, 임업, 환경업, 바이오업, 문화콘텐츠업, 상담업, 기획업',
                '화': '방송업, 연예업, 광고업, 요식업, 에너지업, 스포츠업, 이벤트업, 마케팅업',
                '토': '부동산업, 건설업, 농업, 금융업, 보험업, 유통업, 서비스업, 관리업',
                '금': '법무업, 의료업, 기술업, 제조업, 금융업, 컨설팅업, 정밀업, 분석업',
                '수': '연구업, 정보업, 물류업, 여행업, 상담업, 치료업, 예술업, 유통업'
            };

            const ganCareers = {
                '갑': '대기업 임원, 정치가, 교육자, 사업가',
                '을': '디자이너, 상담사, 문화예술인, 서비스업',
                '병': '방송인, 연예인, 영업직, 마케터',
                '정': '요리사, 예술가, 치료사, 상담사',
                '무': '부동산업, 건설업, 금융업, 관리직',
                '기': '농업, 유통업, 협동조합, 지원업무',
                '경': '법조인, 의사, 엔지니어, 군인',
                '신': '패션업, 디자인업, 혁신업, 개혁가',
                '임': '연구원, 학자, 철학자, 컨설턴트',
                '계': '예술가, 치료사, 점술가, 서비스업'
            };

            return `<strong>오행 특성 기반:</strong> ${elementCareers[strongElement] || '다양한 분야'}<br>
                    <strong>일간 특성 기반:</strong> ${ganCareers[dayGan] || '개성을 살린 분야'}<br>
                    <strong>종합 추천:</strong> 당신의 ${strongElement} 기운과 ${dayGan} 성향을 고려할 때,
                    ${strongElement === '화' ? '사람들과 활발히 소통하며 열정을 발휘할 수 있는 분야' :
                      strongElement === '토' ? '안정성과 신뢰성이 중요한 분야' :
                      strongElement === '금' ? '전문성과 정확성이 요구되는 분야' :
                      strongElement === '수' ? '지혜와 통찰력이 필요한 분야' : '창의성과 성장성이 중요한 분야'}에서
                    가장 큰 성공을 거둘 수 있을 것입니다.`;
        }

        // 재물운 분석
        function getWealthAnalysis(sipshin, elements) {
            return '재물운은 꾸준한 노력과 올바른 투자를 통해 점진적으로 향상될 것입니다. 투기보다는 안정적인 저축과 투자를 통해 재산을 형성하는 것이 좋으며, 특히 부동산이나 장기 투자에 적합한 운세를 가지고 있습니다.';
        }

        // 인간관계 분석
        function getRelationshipAnalysis(sipshin, dayGan) {
            return '인간관계에서는 진실하고 따뜻한 마음으로 대하면 좋은 인연을 만날 수 있습니다. 리더십이 있어 사람들이 따르기 쉽지만, 때로는 고집스러운 면이 있어 상대방의 의견도 존중하는 자세가 필요합니다.';
        }

        // 주의사항 조언
        function getCautionAdvice(dayGan, strongElement, sinsaal) {
            return '성격이 강하고 추진력이 있는 반면, 때로는 성급하거나 독단적일 수 있습니다. 다른 사람의 의견에도 귀 기울이고, 신중한 판단을 통해 행동하는 것이 중요합니다. 특히 인간관계에서는 포용력과 이해심을 기르는 것이 필요합니다.';
        }

        // 개선 방향
        function getImprovementAdvice(weakElement, elements) {
            const improvements = {
                '목': '독서, 학습, 새로운 취미 시작을 통해 창의력과 성장 동력을 기르세요.',
                '화': '운동, 사회활동, 적극적인 소통을 통해 열정과 표현력을 기르세요.',
                '토': '규칙적인 생활, 꾸준한 노력, 안정적인 관계 형성을 통해 지속력을 기르세요.',
                '금': '명확한 목표 설정, 체계적인 계획, 전문성 개발을 통해 완성도를 높이세요.',
                '수': '명상, 독서, 내면 탐구를 통해 지혜와 직관력을 기르세요.'
            };
            return improvements[weakElement] || '균형잡힌 발전을 위해 다양한 경험을 쌓으세요.';
        }

        // 인생 총평
        function getLifeSummary(data) {
            return `${data.name}님은 타고난 리더십과 강한 의지력을 가진 분으로, 인생에서 큰 성취를 이룰 가능성이 높습니다.
                    특히 ${data.elements && Object.entries(data.elements).reduce((a, b) => data.elements[a[0]] > data.elements[b[0]] ? a : b)[0]} 기운이 강해
                    해당 분야에서 특별한 재능을 발휘할 수 있습니다.
                    다만 때로는 성급하거나 고집스러운 면이 있어,
                    다른 사람과의 조화를 이루며 꾸준히 노력한다면
                    더욱 풍요롭고 의미 있는 인생을 살아갈 수 있을 것입니다.`;
        }

        // 직업 조언
        function getCareerAdvice(sipshin, strongElement) {
            const careerAdvices = {
                '목': '교육, 출판, 환경 관련 분야에서 능력을 발휘할 수 있습니다.',
                '화': '방송, 광고, 서비스업 등 사람들과 활발히 소통하는 분야가 적합합니다.',
                '토': '부동산, 건축, 금융 등 안정성을 중시하는 분야에서 성과를 낼 수 있습니다.',
                '금': '법무, 의료, 기술직 등 전문성과 정확성이 요구되는 분야가 유리합니다.',
                '수': '연구, 상담, 물류 등 지혜와 유연성이 필요한 분야에서 두각을 나타낼 수 있습니다.'
            };
            return careerAdvices[strongElement] || '다양한 분야에서 자신만의 색깔을 찾아보세요.';
        }
    </script>
</body>
</html>