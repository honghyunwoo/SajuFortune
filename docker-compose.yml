# ==================================
# ğŸš€ ìš´ëª…ì˜ í•´ë‹µ (SajuFortune) Docker Compose
# ==================================
#
# í”„ë¡œë•ì…˜ê¸‰ ë©€í‹° ì»¨í…Œì´ë„ˆ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜
# - app: Node.js ì• í”Œë¦¬ì¼€ì´ì…˜ (ì‚¬ì£¼ ê³„ì‚° ì„œë¹„ìŠ¤)
# - db: PostgreSQL 16 (ì‚¬ìš©ì ë°ì´í„°, ì‚¬ì£¼ ê²°ê³¼ ì €ì¥)
# - redis: Redis 7 (ìºì‹± ë ˆì´ì–´)
# - nginx: Nginx (ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ, SSL ì¢…ë£Œ)
#
# ì‚¬ìš©ë²•:
# - ê°œë°œ: docker-compose up -d
# - í”„ë¡œë•ì…˜: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# - ì¤‘ë‹¨: docker-compose down
# - ë¡œê·¸: docker-compose logs -f app
# ==================================

version: '3.8'

services:
  # ----------------------------------
  # Main Application (Node.js)
  # ----------------------------------
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: saju-fortune-app
    ports:
      - "5000:5000"
    environment:
      # ì„œë²„ ì„¤ì •
      - NODE_ENV=production
      - PORT=5000
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:5000}

      # ë°ì´í„°ë² ì´ìŠ¤ (ë‚´ë¶€ ì»¨í…Œì´ë„ˆ ì—°ê²°)
      - DATABASE_URL=postgresql://saju:${POSTGRES_PASSWORD:-saju_password}@db:5432/saju_fortune?sslmode=disable

      # ì„¸ì…˜ ì•”í˜¸í™” (âš ï¸ ë°˜ë“œì‹œ ë³€ê²½!)
      - SESSION_SECRET=${SESSION_SECRET}

      # Stripe ê²°ì œ
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}

      # Redis ìºì‹± (ë‚´ë¶€ ì»¨í…Œì´ë„ˆ ì—°ê²°)
      - REDIS_URL=redis://redis:6379
      - CACHE_TTL=${CACHE_TTL:-7200}

      # Rate Limiting
      - RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS:-900000}
      - RATE_LIMIT_MAX_REQUESTS=${RATE_LIMIT_MAX_REQUESTS:-100}

      # ë¡œê¹…
      - LOG_LEVEL=${LOG_LEVEL:-info}

    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5000/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1); });"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    volumes:
      # ë¡œê·¸ íŒŒì¼ ì˜êµ¬ ì €ì¥
      - app_logs:/app/logs

    networks:
      - saju-network

  # ----------------------------------
  # PostgreSQL Database
  # ----------------------------------
  db:
    image: postgres:16-alpine
    container_name: saju-fortune-db
    environment:
      - POSTGRES_DB=saju_fortune
      - POSTGRES_USER=saju
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-saju_password}
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8
      - TZ=Asia/Seoul

    volumes:
      # ë°ì´í„° ì˜êµ¬ ì €ì¥
      - postgres_data:/var/lib/postgresql/data
      # ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ (ì„ íƒì‚¬í•­)
      - ./migrations:/docker-entrypoint-initdb.d

    ports:
      # ì™¸ë¶€ ì ‘ê·¼ (ê°œë°œ/ë””ë²„ê¹…ìš©, í”„ë¡œë•ì…˜ì—ì„œëŠ” ì œê±° ê¶Œì¥)
      - "5432:5432"

    restart: unless-stopped

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U saju -d saju_fortune"]
      interval: 10s
      timeout: 5s
      retries: 5

    networks:
      - saju-network

  # ----------------------------------
  # Redis Cache
  # ----------------------------------
  redis:
    image: redis:7-alpine
    container_name: saju-fortune-redis
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru

    volumes:
      # ë°ì´í„° ì˜êµ¬ ì €ì¥ (AOF)
      - redis_data:/data

    ports:
      # ì™¸ë¶€ ì ‘ê·¼ (ê°œë°œ/ë””ë²„ê¹…ìš©, í”„ë¡œë•ì…˜ì—ì„œëŠ” ì œê±° ê¶Œì¥)
      - "6379:6379"

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

    networks:
      - saju-network

  # ----------------------------------
  # Nginx Reverse Proxy (ì„ íƒì‚¬í•­)
  # ----------------------------------
  nginx:
    image: nginx:alpine
    container_name: saju-fortune-nginx
    ports:
      - "80:80"
      - "443:443"

    volumes:
      # Nginx ì„¤ì • íŒŒì¼
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      # SSL ì¸ì¦ì„œ (Let's Encrypt)
      - ./ssl:/etc/nginx/ssl:ro
      # Static files (ì„ íƒì‚¬í•­)
      - ./dist/public:/usr/share/nginx/html:ro

    depends_on:
      - app

    restart: unless-stopped

    networks:
      - saju-network

# ----------------------------------
# Volumes (ì˜êµ¬ ì €ì¥ì†Œ)
# ----------------------------------
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  app_logs:
    driver: local

# ----------------------------------
# Networks (ì»¨í…Œì´ë„ˆ ê°„ í†µì‹ )
# ----------------------------------
networks:
  saju-network:
    driver: bridge
