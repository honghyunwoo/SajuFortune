/**
 * 격국 판별 시스템 (格局 Analysis System)
 * 전통 사주학의 격국 이론을 바탕으로 한 체계적 분석
 *
 * 격국(格局)이란?
 * 사주팔자의 구조와 균형을 분석하여 그 사람의 타고난 운명적 틀을 판단하는 명리학의 핵심 이론
 *
 * 주요 구성:
 * 1. 정격(正格) 8종: 일반적인 사주 구조
 * 2. 특수격(特殊格): 특별한 사주 구조
 */

import {
    천간, 지지, 천간오행, 십신표,
    type 천간타입, type 지지타입, type 오행타입, type 십신타입
} from './astro-data';

// 타입 정의
export type 정격타입 =
    | '정관격' | '편관격'
    | '정재격' | '편재격'
    | '식신격' | '상관격'
    | '정인격' | '편인격';

export type 특수격타입 =
    | '종강격' | '종왕격'
    | '화격' | '종화격'
    | '일행득기격';

export type 격국타입 = 정격타입 | 특수격타입 | '무격';

export interface 격국결과 {
    격국명: 격국타입;
    격국종류: '정격' | '특수격' | '무격';
    격국강도: number; // 0-100
    용신: 오행타입;
    희신: 오행타입[];
    기신: 오행타입[];
    격국함의: string;
    상세해석: {
        장점: string[];
        단점: string[];
        적합직업: string[];
        주의사항: string[];
    };
}

export interface 사주정보 {
    year: { gan: 천간타입; ji: 지지타입 };
    month: { gan: 천간타입; ji: 지지타입 };
    day: { gan: 천간타입; ji: 지지타입 };
    hour: { gan: 천간타입; ji: 지지타입 };
}

/**
 * 격국 분석 메인 함수
 */
export function analyze격국(사주: 사주정보): 격국결과 {
    console.log('🎯 격국 분석 시작');

    // 1. 일간(日干) 추출 - 격국 판단의 기준
    const 일간 = 사주.day.gan;

    // 2. 월지(月支) 추출 - 격국 성립의 핵심
    const 월지 = 사주.month.ji;

    // 3. 월간(月干) 추출 - 격국 유무 판단
    const 월간 = 사주.month.gan;

    // 4. 특수격 검사 (특수격이 우선)
    const 특수격 = check특수격(사주);
    if (특수격) {
        console.log('✨ 특수격 발견:', 특수격.격국명);
        return 특수격;
    }

    // 5. 정격 판별 (월간 기준)
    const 정격 = check정격(사주, 일간, 월간, 월지);
    if (정격) {
        console.log('📊 정격 판별:', 정격.격국명);
        return 정격;
    }

    // 6. 무격 (격국을 이루지 못한 경우)
    console.log('⚠️ 무격 판정');
    return create무격결과(사주);
}

/**
 * 정격 8종 판별
 * 월간(月干)의 십신(十神)으로 격국 판단
 */
function check정격(
    사주: 사주정보,
    일간: 천간타입,
    월간: 천간타입,
    월지: 지지타입
): 격국결과 | null {

    // 월간의 십신 확인
    const 월간십신 = 십신표[일간][월간];

    // 십신에 따른 격국 판별
    switch (월간십신) {
        case '정관':
            return create정관격(사주, 일간);
        case '편관':
            return create편관격(사주, 일간);
        case '정재':
            return create정재격(사주, 일간);
        case '편재':
            return create편재격(사주, 일간);
        case '식신':
            return create식신격(사주, 일간);
        case '상관':
            return create상관격(사주, 일간);
        case '정인':
            return create정인격(사주, 일간);
        case '편인':
            return create편인격(사주, 일간);
        default:
            return null;
    }
}

/**
 * 정관격 (正官格)
 * 월간이 정관일 때 성립
 * 특징: 정직, 책임감, 명예 중시
 */
function create정관격(사주: 사주정보, 일간: 천간타입): 격국결과 {
    const 일간오행 = 천간오행[일간];

    return {
        격국명: '정관격',
        격국종류: '정격',
        격국강도: calculate격국강도(사주, '정관'),
        용신: get용신(일간오행, '정관격'),
        희신: get희신(일간오행, '정관격'),
        기신: get기신(일간오행, '정관격'),
        격국함의: '정직하고 원칙을 중시하는 성품으로, 명예와 지위를 추구합니다. 공직, 관리직에 적합합니다.',
        상세해석: {
            장점: [
                '정직하고 성실한 성품',
                '책임감이 강하고 신뢰할 수 있음',
                '명예와 체면을 중시함',
                '조직 생활에 적합',
                '안정적인 사회생활'
            ],
            단점: [
                '융통성이 부족할 수 있음',
                '규칙과 틀에 얽매일 수 있음',
                '권위에 지나치게 의존',
                '변화에 대한 두려움'
            ],
            적합직업: [
                '공무원',
                '법조인',
                '회계사',
                '교사',
                '관리직',
                '금융권'
            ],
            주의사항: [
                '상관(傷官)을 조심하세요 - 정관을 해침',
                '편관(偏官)이 많으면 혼잡함',
                '재성(財星)의 생조가 필요함'
            ]
        }
    };
}

/**
 * 편관격 (偏官格, 칠살격)
 * 월간이 편관일 때 성립
 * 특징: 강인함, 추진력, 승부욕
 */
function create편관격(사주: 사주정보, 일간: 천간타입): 격국결과 {
    const 일간오행 = 천간오행[일간];

    return {
        격국명: '편관격',
        격국종류: '정격',
        격국강도: calculate격국강도(사주, '편관'),
        용신: get용신(일간오행, '편관격'),
        희신: get희신(일간오행, '편관격'),
        기신: get기신(일간오행, '편관격'),
        격국함의: '강인하고 추진력이 있으며, 승부욕이 강합니다. 경쟁적인 분야나 무력을 쓰는 직업에 적합합니다.',
        상세해석: {
            장점: [
                '강한 추진력과 실행력',
                '승부욕과 경쟁심이 강함',
                '위기 상황에서 강함',
                '리더십 발휘',
                '대담하고 용감함'
            ],
            단점: [
                '성격이 급하고 과격할 수 있음',
                '충동적인 결정',
                '권위적일 수 있음',
                '인내심 부족'
            ],
            적합직업: [
                '군인',
                '경찰',
                '운동선수',
                '사업가',
                '영업직',
                '정치인'
            ],
            주의사항: [
                '식신(食神)으로 제압이 필요함',
                '편관이 너무 강하면 흉함',
                '인성(印星)의 화해가 좋음'
            ]
        }
    };
}

/**
 * 정재격 (正財格)
 * 월간이 정재일 때 성립
 * 특징: 근면, 성실, 재물 축적
 */
function create정재격(사주: 사주정보, 일간: 천간타입): 격국결과 {
    const 일간오행 = 천간오행[일간];

    return {
        격국명: '정재격',
        격국종류: '정격',
        격국강도: calculate격국강도(사주, '정재'),
        용신: get용신(일간오행, '정재격'),
        희신: get희신(일간오행, '정재격'),
        기신: get기신(일간오행, '정재격'),
        격국함의: '근면하고 성실하며 재물을 잘 관리합니다. 안정적인 재물 축적에 능합니다.',
        상세해석: {
            장점: [
                '성실하고 근면한 성품',
                '돈 관리를 잘함',
                '안정적인 재물 축적',
                '가정적이고 책임감 있음',
                '검소하고 계획적'
            ],
            단점: [
                '지나치게 물질적일 수 있음',
                '인색할 수 있음',
                '융통성 부족',
                '모험을 꺼림'
            ],
            적합직업: [
                '회계사',
                '세무사',
                '은행원',
                '부동산',
                '일반 사업',
                '금융업'
            ],
            주의사항: [
                '비겁(比劫)을 조심하세요 - 재물을 탈취',
                '관성(官星)의 보호가 필요함',
                '신강(身强)이 필요함'
            ]
        }
    };
}

/**
 * 편재격 (偏財格)
 * 월간이 편재일 때 성립
 * 특징: 사교성, 활동성, 재물 유통
 */
function create편재격(사주: 사주정보, 일간: 천간타입): 격국결과 {
    const 일간오행 = 천간오행[일간];

    return {
        격국명: '편재격',
        격국종류: '정격',
        격국강도: calculate격국강도(사주, '편재'),
        용신: get용신(일간오행, '편재격'),
        희신: get희신(일간오행, '편재격'),
        기신: get기신(일간오행, '편재격'),
        격국함의: '사교적이고 활동적이며, 재물의 유통에 능합니다. 변화하는 재물에 강합니다.',
        상세해석: {
            장점: [
                '사교적이고 외향적',
                '돈을 버는 재주',
                '변화 대응 능력',
                '활동적이고 적극적',
                '사업 수완'
            ],
            단점: [
                '돈을 모으기 어려움',
                '낭비벽이 있을 수 있음',
                '정착하기 어려움',
                '여색(女色) 주의'
            ],
            적합직업: [
                '무역업',
                '중개업',
                '서비스업',
                '영업',
                '유통업',
                '장사'
            ],
            주의사항: [
                '비겁(比劫)이 많으면 재물 손실',
                '신강(身强)이 필수',
                '식상(食傷)의 생조가 좋음'
            ]
        }
    };
}

/**
 * 식신격 (食神格)
 * 월간이 식신일 때 성립
 * 특징: 여유, 예술, 표현력
 */
function create식신격(사주: 사주정보, 일간: 천간타입): 격국결과 {
    const 일간오행 = 천간오행[일간];

    return {
        격국명: '식신격',
        격국종류: '정격',
        격국강도: calculate격국강도(사주, '식신'),
        용신: get용신(일간오행, '식신격'),
        희신: get희신(일간오행, '식신격'),
        기신: get기신(일간오행, '식신격'),
        격국함의: '여유롭고 온화하며, 예술적 재능이 있습니다. 표현력과 창조력이 뛰어납니다.',
        상세해석: {
            장점: [
                '온화하고 여유로운 성품',
                '예술적 재능',
                '표현력이 뛰어남',
                '식복(食福)이 있음',
                '낙천적이고 긍정적'
            ],
            단점: [
                '게으를 수 있음',
                '현실감각 부족',
                '실천력 부족',
                '꿈만 꿀 수 있음'
            ],
            적합직업: [
                '예술가',
                '작가',
                '요리사',
                '교육자',
                '서비스업',
                '방송인'
            ],
            주의사항: [
                '편인(偏印)을 조심하세요 - 식신을 극함',
                '재성(財星)의 생조가 좋음',
                '너무 많으면 나태해짐'
            ]
        }
    };
}

/**
 * 상관격 (傷官格)
 * 월간이 상관일 때 성립
 * 특징: 재치, 비판력, 표현욕
 */
function create상관격(사주: 사주정보, 일간: 천간타입): 격국결과 {
    const 일간오행 = 천간오행[일간];

    return {
        격국명: '상관격',
        격국종류: '정격',
        격국강도: calculate격국강도(사주, '상관'),
        용신: get용신(일간오행, '상관격'),
        희신: get희신(일간오행, '상관격'),
        기신: get기신(일간오행, '상관격'),
        격국함의: '재치가 뛰어나고 표현력이 강하며, 비판적 사고를 가졌습니다. 예술과 기술 분야에 재능이 있습니다.',
        상세해석: {
            장점: [
                '뛰어난 재치와 표현력',
                '예술적 감각',
                '기술력이 뛰어남',
                '독창적 사고',
                '자유로운 영혼'
            ],
            단점: [
                '비판적이고 반항적',
                '인간관계 어려움',
                '권위 거부',
                '변덕스러울 수 있음'
            ],
            적합직업: [
                '예술가',
                '디자이너',
                '기술자',
                '프리랜서',
                '연구원',
                '평론가'
            ],
            주의사항: [
                '정관(正官)을 해침 - 직장 생활 어려움',
                '재성(財星)으로 설기(洩氣) 필요',
                '인성(印星)의 제압도 방법'
            ]
        }
    };
}

/**
 * 정인격 (正印格)
 * 월간이 정인일 때 성립
 * 특징: 학문, 지혜, 인내
 */
function create정인격(사주: 사주정보, 일간: 천간타입): 격국결과 {
    const 일간오행 = 천간오행[일간];

    return {
        격국명: '정인격',
        격국종류: '정격',
        격국강도: calculate격국강도(사주, '정인'),
        용신: get용신(일간오행, '정인격'),
        희신: get희신(일간오행, '정인격'),
        기신: get기신(일간오행, '정인격'),
        격국함의: '학문을 좋아하고 지혜로우며, 인내심이 강합니다. 모성애와 포용력이 있습니다.',
        상세해석: {
            장점: [
                '학문적 재능',
                '지혜롭고 사려 깊음',
                '인내심과 끈기',
                '모성애와 포용력',
                '신용과 명예 중시'
            ],
            단점: [
                '우유부단할 수 있음',
                '의존적 성향',
                '현실감각 부족',
                '고집이 셀 수 있음'
            ],
            적합직업: [
                '교수',
                '연구원',
                '교사',
                '의사',
                '종교인',
                '학자'
            ],
            주의사항: [
                '재성(財星)을 조심하세요 - 인성을 극함',
                '관성(官星)의 생조가 좋음',
                '너무 많으면 나태해짐'
            ]
        }
    };
}

/**
 * 편인격 (偏印格, 효신격)
 * 월간이 편인일 때 성립
 * 특징: 직관력, 신비, 변화
 */
function create편인격(사주: 사주정보, 일간: 천간타입): 격국결과 {
    const 일간오행 = 천간오행[일간];

    return {
        격국명: '편인격',
        격국종류: '정격',
        격국강도: calculate격국강도(사주, '편인'),
        용신: get용신(일간오행, '편인격'),
        희신: get희신(일간오행, '편인격'),
        기신: get기신(일간오행, '편인격'),
        격국함의: '직관력이 뛰어나고 신비로운 것을 좋아합니다. 변화를 추구하며 독특한 재능이 있습니다.',
        상세해석: {
            장점: [
                '뛰어난 직관력',
                '신비로운 것에 재능',
                '독특한 사고방식',
                '창의적 아이디어',
                '빠른 학습능력'
            ],
            단점: [
                '변덕스러울 수 있음',
                '고독을 선호',
                '현실 도피 경향',
                '식신(食神)을 극함'
            ],
            적합직업: [
                '역술가',
                '심리학자',
                '예술가',
                '연구원',
                '작가',
                '상담사'
            ],
            주의사항: [
                '식신(食神)을 해침 - 식복 손상',
                '재성(財星)의 제압이 필요',
                '너무 많으면 고독함'
            ]
        }
    };
}

/**
 * 특수격 검사
 */
function check특수격(사주: 사주정보): 격국결과 | null {
    // 종강격 검사
    const 종강격 = check종강격(사주);
    if (종강격) return 종강격;

    // 종왕격 검사
    const 종왕격 = check종왕격(사주);
    if (종왕격) return 종왕격;

    return null;
}

/**
 * 종강격 (從强格)
 * 일간이 너무 강해서 극단적으로 강한 경우
 */
function check종강격(사주: 사주정보): 격국결과 | null {
    const 일간 = 사주.day.gan;
    const 일간오행 = 천간오행[일간];

    // 간단한 판별 로직 (실제로는 더 복잡함)
    // 여기서는 기본 구조만 제공

    return null; // 실제 구현 필요
}

/**
 * 종왕격 (從旺格)
 * 비겁이 많아 강한 기운을 따르는 경우
 */
function check종왕격(사주: 사주정보): 격국결과 | null {
    // 실제 구현 필요
    return null;
}

/**
 * 무격 결과 생성
 */
function create무격결과(사주: 사주정보): 격국결과 {
    return {
        격국명: '무격',
        격국종류: '무격',
        격국강도: 0,
        용신: '목',
        희신: [],
        기신: [],
        격국함의: '명확한 격국을 이루지 못한 사주입니다. 다양한 경험과 학습을 통해 자신의 길을 찾아야 합니다.',
        상세해석: {
            장점: [
                '다양한 가능성',
                '유연한 대응력',
                '폭넓은 적응력'
            ],
            단점: [
                '방향성 부족',
                '일관성 부족',
                '결단력 약함'
            ],
            적합직업: [
                '다양한 경험이 필요한 직업',
                '변화가 많은 업종'
            ],
            주의사항: [
                '자신만의 전문성 개발 필요',
                '꾸준한 노력이 중요',
                '멘토나 스승의 도움 필요'
            ]
        }
    };
}

/**
 * 격국 강도 계산
 * 0-100 사이의 값으로 격국의 완성도를 나타냄
 */
function calculate격국강도(사주: 사주정보, 격국십신: string): number {
    let 강도 = 50; // 기본 강도

    // 월지의 지장간에 격국십신이 있으면 +20
    // 년지, 일지, 시지에 생조가 있으면 각 +10
    // 천간에 극파가 있으면 -15

    // 간단한 계산 (실제로는 더 복잡함)
    return Math.min(100, Math.max(0, 강도));
}

/**
 * 용신 결정
 * 용신(用神): 사주의 균형을 맞추는 핵심 오행
 */
function get용신(일간오행: 오행타입, 격국: string): 오행타입 {
    // 간단한 매핑 (실제로는 복잡한 로직)
    const 용신표: Record<string, 오행타입> = {
        '정관격': '수',
        '편관격': '수',
        '정재격': '토',
        '편재격': '토',
        '식신격': '화',
        '상관격': '화',
        '정인격': '목',
        '편인격': '목'
    };

    return 용신표[격국] || '목';
}

/**
 * 희신 결정
 * 희신(喜神): 용신을 돕는 오행들
 */
function get희신(일간오행: 오행타입, 격국: string): 오행타입[] {
    // 실제로는 복잡한 상생상극 이론 적용
    return ['목', '화'];
}

/**
 * 기신 결정
 * 기신(忌神): 해로운 오행들
 */
function get기신(일간오행: 오행타입, 격국: string): 오행타입[] {
    // 실제로는 복잡한 상생상극 이론 적용
    return ['금', '수'];
}

/**
 * 격국 통계 정보
 */
export function get격국통계(): Record<격국타입, string> {
    return {
        '정관격': '정직하고 명예로운 삶',
        '편관격': '강인하고 역동적인 삶',
        '정재격': '안정적이고 근면한 삶',
        '편재격': '활동적이고 사교적인 삶',
        '식신격': '여유롭고 예술적인 삶',
        '상관격': '창의적이고 자유로운 삶',
        '정인격': '학문적이고 지혜로운 삶',
        '편인격': '신비롭고 독특한 삶',
        '종강격': '극단적으로 강한 기질',
        '종왕격': '비겁이 많은 구조',
        '화격': '특수한 조화',
        '종화격': '특별한 균형',
        '일행득기격': '한 오행이 극강',
        '무격': '정해진 틀 없는 삶'
    };
}
