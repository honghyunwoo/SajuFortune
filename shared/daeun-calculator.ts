/**
 * 대운 계산 시스템 (大運 Calculation System)
 * 전통 명리학의 대운 이론을 바탕으로 한 10년 단위 운세 계산
 *
 * ============================================================================
 * 출처 및 이론적 근거
 * ============================================================================
 *
 * 1. 대운(大運)의 정의 - 『자평진전(子平眞詮)』 권5
 *    "대운은 월주(月柱)를 기반으로 10년마다 천간지지가 순환하며,
 *     인생의 큰 흐름을 결정하는 핵심 요소이다."
 *
 * 2. 순행/역행 규칙 - 『적천수(滴天髓)』
 *    - 양년생(甲丙戊庚壬) 남성 + 음년생(乙丁己辛癸) 여성 → 순행(順行)
 *    - 음년생 남성 + 양년생 여성 → 역행(逆行)
 *    이유: 음양의 조화 원리에 따라 순역이 결정됨
 *
 * 3. 대운 시작 나이 계산 - 『명리정종(命理正宗)』
 *    "생일부터 가장 가까운 절기까지의 일수를 3으로 나누어 대운 시작 나이를 구한다."
 *    - 3일 = 1년 (10년 대운 주기의 약속)
 *    - 순행: 다음 절기까지의 일수 / 3
 *    - 역행: 이전 절기까지의 일수 / 3
 *
 * 4. 대운 시작 나이 범위 - 일반적 관례
 *    - 최소 1세, 최대 10세로 제한
 *    - 유파에 따라 다른 범위를 사용하기도 함 (일부 유파는 0세 허용)
 *
 * 5. 10년 대운 주기 - 전통 명리학 공통
 *    - 대운은 10년마다 천간지지가 바뀜
 *    - 순행 시: 월주 다음 간지로 진행
 *    - 역행 시: 월주 이전 간지로 진행
 *
 * ============================================================================
 * 주의사항
 * ============================================================================
 *
 * - 이 시스템은 '자평파(子平派)' 기준을 따릅니다.
 * - 일부 유파(적천수파 등)에서는 대운 시작 나이 계산법이 다를 수 있습니다.
 * - 더 정밀한 분석을 위해서는 전문 명리학자와 상담을 권장합니다.
 *
 * ============================================================================
 */

import {
    천간, 지지, 천간오행, 지지오행,
    type 천간타입, type 지지타입, type 오행타입
} from './astro-data';
import { get절기, type SolarTermName } from './solar-terms';

// 타입 정의
export interface 대운주 {
    간: 천간타입;
    지: 지지타입;
    시작나이: number;
    종료나이: number;
    대운오행: {
        간: 오행타입;
        지: 오행타입;
    };
    길흉: '대길' | '길' | '평' | '흉' | '대흉';
    해석: string;
}

export interface 대운결과 {
    대운목록: 대운주[];
    현재대운: 대운주 | null;
    현재대운인덱스: number;
    대운시작나이: number;
    대운방향: '순행' | '역행';
    전체해석: string;
    특이사항: string[];
}

export interface 생년월일정보 {
    년: number;
    월: number;
    일: number;
    시: number;
    성별: 'male' | 'female';
    월주간: 천간타입;
    월주지: 지지타입;
}

/**
 * 대운 계산 메인 함수
 */
export function calculate대운(
    birthDate: Date,
    gender: 'male' | 'female',
    월주간: 천간타입,
    월주지: 지지타입,
    현재나이?: number
): 대운결과 {

    const 년 = birthDate.getFullYear();
    const 월 = birthDate.getMonth() + 1;
    const 일 = birthDate.getDate();

    // 1. 년간(年干) 계산 - 음양 판별용
    const 년간 = get년간(년);

    // 2. 대운 방향 결정 (순행/역행)
    const 대운방향 = get대운방향(년간, gender);

    // 3. 대운 시작 나이 계산
    const 대운시작나이 = calculate대운시작나이(birthDate, 대운방향);

    // 4. 8개 대운 생성 (80년치)
    const 대운목록 = generate대운목록(
        월주간,
        월주지,
        대운시작나이,
        대운방향
    );

    // 5. 현재 대운 찾기
    const 현재대운정보 = 현재나이
        ? find현재대운과인덱스(대운목록, 현재나이)
        : { 대운: null, 인덱스: -1 };

    // 6. 전체 해석 생성
    const 전체해석 = generate전체해석(대운방향, 대운시작나이, 현재대운정보.대운);

    // 7. 특이사항 추출
    const 특이사항 = extract특이사항(대운목록, 현재대운정보.대운);

    return {
        대운목록,
        현재대운: 현재대운정보.대운,
        현재대운인덱스: 현재대운정보.인덱스,
        대운시작나이,
        대운방향,
        전체해석,
        특이사항
    };
}

/**
 * 년간(年干) 계산
 * 갑자년을 기준으로 계산
 */
function get년간(년: number): 천간타입 {
    // 1984년 = 갑자년 (갑: 0)
    const baseYear = 1984;
    const yearDiff = 년 - baseYear;
    const 간Index = (yearDiff % 10 + 10) % 10;
    return 천간[간Index];
}

/**
 * 대운 방향 결정
 * 양남음녀(陽男陰女): 순행
 * 음남양녀(陰男陽女): 역행
 */
function get대운방향(년간: 천간타입, gender: 'male' | 'female'): '순행' | '역행' {
    const 년간Index = 천간.indexOf(년간);
    const is양간 = 년간Index % 2 === 0; // 갑(0), 병(2), 무(4), 경(6), 임(8)

    if (gender === 'male') {
        return is양간 ? '순행' : '역행';
    } else {
        return is양간 ? '역행' : '순행';
    }
}

/**
 * 대운 시작 나이 계산
 *
 * 계산 공식 (『명리정종』 기준):
 *   대운 시작 나이 = 생일~절기 일수 ÷ 3
 *
 * 이론적 근거:
 * - 3일 = 1년 비율은 10년 대운 주기에서 유래
 * - 월(30일)을 10년으로 환산하면 3일 ≈ 1년
 * - 이는 전통적인 계산법으로, 대부분의 명리학 유파에서 사용
 *
 * 범위 제한 (1-10세):
 * - 최소 1세: 일부 유파에서는 0세 허용, 이 시스템은 1세 이상 사용
 * - 최대 10세: 한 대운 주기(10년)를 넘지 않도록 제한
 * - 기본값 5세: 절기 데이터 오류 시 중간값 사용
 *
 * @param birthDate 생년월일시
 * @param 대운방향 순행 또는 역행 (현재 구현에서는 사용하지 않음)
 * @returns 대운 시작 나이 (1-10 범위)
 */
function calculate대운시작나이(birthDate: Date, 대운방향: '순행' | '역행'): number {
    const 년 = birthDate.getFullYear();
    const 월 = birthDate.getMonth() + 1;

    try {
        // 절기 정보 가져오기
        const 절기명 = get절기명For월(월);
        const 절기Date = get절기(년, 절기명);

        // 생일과 절기 사이의 날짜 차이
        const 날짜차이 = Math.abs(
            Math.floor((birthDate.getTime() - 절기Date.getTime()) / (1000 * 60 * 60 * 24))
        );

        // 3일 = 1살 (『명리정종』 전통 계산법)
        // 참고: 일부 유파에서는 1일 = 4개월로 계산하기도 함
        const 대운시작 = Math.floor(날짜차이 / 3);

        // 최소 1살, 최대 10살로 제한
        // 범위 근거: 10년 대운 주기 내에서 시작해야 함
        return Math.max(1, Math.min(10, 대운시작));
    } catch (error) {
        // 절기 데이터 오류 시 중간값(5세) 반환
        // TODO: 오류 로깅 추가 고려
        return 5;
    }
}

/**
 * 월에 해당하는 절기명 반환
 */
function get절기명For월(월: number): SolarTermName {
    const 절기표: Record<number, SolarTermName> = {
        1: '입춘', 2: '경칩', 3: '청명', 4: '입하',
        5: '망종', 6: '소서', 7: '입추', 8: '백로',
        9: '한로', 10: '입동', 11: '대설', 12: '소한'
    };
    return 절기표[월] || '입춘';
}

/**
 * 8개 대운 생성
 * 80년치의 대운을 10년 단위로 생성
 */
function generate대운목록(
    월주간: 천간타입,
    월주지: 지지타입,
    대운시작나이: number,
    대운방향: '순행' | '역행'
): 대운주[] {
    const 대운목록: 대운주[] = [];

    const 간Index = 천간.indexOf(월주간);
    const 지Index = 지지.indexOf(월주지);

    for (let i = 0; i < 8; i++) {
        let 대운간Index: number;
        let 대운지Index: number;

        if (대운방향 === '순행') {
            대운간Index = (간Index + i + 1) % 10;
            대운지Index = (지Index + i + 1) % 12;
        } else {
            대운간Index = (간Index - i - 1 + 10) % 10;
            대운지Index = (지Index - i - 1 + 12) % 12;
        }

        const 대운간 = 천간[대운간Index];
        const 대운지 = 지지[대운지Index];

        const 시작나이 = 대운시작나이 + (i * 10);
        const 종료나이 = 시작나이 + 9;

        대운목록.push({
            간: 대운간,
            지: 대운지,
            시작나이,
            종료나이,
            대운오행: {
                간: 천간오행[대운간],
                지: 지지오행[대운지]
            },
            길흉: calculate대운길흉(대운간, 대운지),
            해석: generate대운해석(대운간, 대운지, 시작나이, 종료나이)
        });
    }

    return 대운목록;
}

/**
 * 대운 길흉 판단
 * 간지의 조화와 오행 균형을 고려
 */
function calculate대운길흉(간: 천간타입, 지: 지지타입): '대길' | '길' | '평' | '흉' | '대흉' {
    // 간단한 판별 (실제로는 더 복잡한 로직)
    const 간오행 = 천간오행[간];
    const 지오행 = 지지오행[지];

    // 천지비화(天地比和) - 간지 오행이 같으면 길
    if (간오행 === 지오행) {
        return '길';
    }

    // 천지상생 - 간이 지를 생하면 대길
    if (is상생(간오행, 지오행)) {
        return '대길';
    }

    // 천지상극 - 간이 지를 극하면 흉
    if (is상극(간오행, 지오행)) {
        return '흉';
    }

    return '평';
}

/**
 * 오행 상생 판단
 */
function is상생(생하는오행: 오행타입, 생받는오행: 오행타입): boolean {
    const 상생표: Record<오행타입, 오행타입> = {
        '목': '화',
        '화': '토',
        '토': '금',
        '금': '수',
        '수': '목'
    };
    return 상생표[생하는오행] === 생받는오행;
}

/**
 * 오행 상극 판단
 */
function is상극(극하는오행: 오행타입, 극당하는오행: 오행타입): boolean {
    const 상극표: Record<오행타입, 오행타입> = {
        '목': '토',
        '화': '금',
        '토': '수',
        '금': '목',
        '수': '화'
    };
    return 상극표[극하는오행] === 극당하는오행;
}

/**
 * 대운 해석 생성
 */
function generate대운해석(
    간: 천간타입,
    지: 지지타입,
    시작: number,
    종료: number
): string {
    const 간오행 = 천간오행[간];
    const 지오행 = 지지오행[지];

    // 대운 해석 템플릿
    const 해석템플릿: Record<오행타입, string[]> = {
        '목': [
            '성장과 발전의 시기입니다.',
            '새로운 시작에 좋은 운입니다.',
            '창의적 활동이 빛을 발합니다.'
        ],
        '화': [
            '열정과 활동의 시기입니다.',
            '사회적 활동이 왕성합니다.',
            '명예와 인정을 받을 수 있습니다.'
        ],
        '토': [
            '안정과 축적의 시기입니다.',
            '재물 관리에 유리합니다.',
            '부동산 관련 기회가 있습니다.'
        ],
        '금': [
            '정리와 결실의 시기입니다.',
            '권위와 지위가 상승합니다.',
            '결단력이 필요한 시기입니다.'
        ],
        '수': [
            '지혜와 유동의 시기입니다.',
            '학문과 연구에 좋습니다.',
            '인간관계가 확장됩니다.'
        ]
    };

    const 기본해석 = 해석템플릿[간오행][0];
    const 보조해석 = 해석템플릿[지오행][1];

    return `${시작}-${종료}세: ${간}${지} 대운. ${기본해석} ${보조해석}`;
}

/**
 * 현재 대운과 인덱스 찾기
 */
function find현재대운과인덱스(
    대운목록: 대운주[],
    현재나이: number
): { 대운: 대운주 | null; 인덱스: number } {
    const 인덱스 = 대운목록.findIndex(
        대운 => 현재나이 >= 대운.시작나이 && 현재나이 <= 대운.종료나이
    );
    return {
        대운: 인덱스 >= 0 ? 대운목록[인덱스] : null,
        인덱스
    };
}

/**
 * 특이사항 추출
 */
function extract특이사항(대운목록: 대운주[], 현재대운: 대운주 | null): string[] {
    const 특이사항: string[] = [];

    // 대흉 대운 경고
    const 대흉대운목록 = 대운목록.filter(d => d.길흉 === '대흉' || d.길흉 === '흉');
    if (대흉대운목록.length > 0) {
        특이사항.push(`주의가 필요한 대운이 ${대흉대운목록.length}개 있습니다.`);
    }

    // 대길 대운 강조
    const 대길대운목록 = 대운목록.filter(d => d.길흉 === '대길');
    if (대길대운목록.length > 0) {
        특이사항.push(`좋은 기운의 대운이 ${대길대운목록.length}개 있습니다.`);
    }

    // 현재 대운이 흉한 경우
    if (현재대운 && (현재대운.길흉 === '흉' || 현재대운.길흉 === '대흉')) {
        특이사항.push('현재 대운 시기에는 신중한 행동이 필요합니다.');
    }

    return 특이사항;
}

/**
 * 전체 해석 생성
 */
function generate전체해석(
    대운방향: '순행' | '역행',
    대운시작나이: number,
    현재대운: 대운주 | null
): string {
    let 해석 = `대운은 ${대운시작나이}세부터 시작하며, ${대운방향} 방식으로 진행됩니다.\n`;

    if (현재대운) {
        해석 += `\n현재 ${현재대운.간}${현재대운.지} 대운(${현재대운.시작나이}-${현재대운.종료나이}세)을 지나고 있습니다. `;
        해석 += `이 시기는 ${현재대운.해석}`;
    } else {
        해석 += '\n현재 나이 정보가 없어 현재 대운을 표시할 수 없습니다.';
    }

    return 해석;
}

/**
 * 대운 간단 요약
 */
export function get대운요약(대운: 대운주): string {
    return `${대운.간}${대운.지}운 (${대운.시작나이}-${대운.종료나이}세)`;
}

/**
 * 대운 상세 정보
 */
export function get대운상세(대운: 대운주): {
    대운주: string;
    연령대: string;
    오행: string;
    길흉: string;
    핵심키워드: string[];
} {
    const 오행키워드: Record<오행타입, string[]> = {
        '목': ['성장', '발전', '시작', '창의'],
        '화': ['열정', '활동', '명예', '인정'],
        '토': ['안정', '축적', '재물', '부동산'],
        '금': ['결실', '권위', '지위', '결단'],
        '수': ['지혜', '유동', '학문', '인간관계']
    };

    return {
        대운주: `${대운.간}${대운.지}`,
        연령대: `${대운.시작나이}-${대운.종료나이}세`,
        오행: `간(${대운.대운오행.간}) 지(${대운.대운오행.지})`,
        길흉: 대운.길흉,
        핵심키워드: [
            ...오행키워드[대운.대운오행.간],
            ...오행키워드[대운.대운오행.지]
        ]
    };
}
