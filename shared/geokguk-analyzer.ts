/**
 * 격국 판별 시스템 (格局 Analysis System)
 * 전통 사주학의 격국 이론을 바탕으로 한 체계적 분석
 *
 * ============================================================================
 * 격국(格局)이란?
 * ============================================================================
 *
 * 사주팔자의 구조와 균형을 분석하여 그 사람의 타고난 운명적 틀을 판단하는
 * 명리학의 핵심 이론입니다.
 *
 * 주요 구성:
 * 1. 정격(正格) 8종: 일반적인 사주 구조
 *    - 정관격, 편관격, 정재격, 편재격, 식신격, 상관격, 정인격, 편인격
 * 2. 특수격(特殊格): 특별한 사주 구조
 *    - 종강격, 종왕격, 화격, 종화격, 일행득기격
 *
 * ============================================================================
 * 출처 및 이론적 근거
 * ============================================================================
 *
 * 1. 격국 판별 - 『자평진전(子平眞詮)』 권3
 *    "격국은 월령(月令)을 기준으로 삼고, 천간에 투출된 십신을 본다."
 *
 * 2. 특수격 판별 - 『적천수(滴天髓)』
 *    "일간이 극강하거나 극약할 때는 억부(抑扶)보다 순응(順應)이 낫다."
 *
 * 3. 용신/희신/기신 - 『명리정종(命理正宗)』
 *    "격국의 성패(成敗)는 용신의 득실(得失)에 달려 있다."
 *
 * ============================================================================
 * 임계값 설정 및 근거
 * ============================================================================
 *
 * 아래 임계값들은 명리학 전문 서적과 실무 경험을 참고하여 설정되었습니다.
 * 유파에 따라 다른 기준을 사용할 수 있으며, 추후 전문가 검증이 필요합니다.
 *
 * ┌────────────────────────────────────────────────────────────────────────┐
 * │ 임계값              │ 값      │ 근거                                    │
 * ├────────────────────────────────────────────────────────────────────────┤
 * │ MIN_BIGEOP_COUNT    │ 2개     │ 비겁 최소 2개 이상이어야 종격 성립       │
 * │                     │         │ (『자평진전』: "비겁다자(比劫多者)")     │
 * │ MAX_OPPOSING_POWER  │ 30점    │ 관성/재성/식상 세력이 30 초과 시 종격    │
 * │                     │         │ 불성립. 100점 기준 약 30%               │
 * │ MIN_INSUNG_POWER    │ 20점    │ 종왕격 성립을 위한 인성 최소 세력       │
 * │                     │         │ 인성이 비겁을 생조해야 함               │
 * │ GEOKGUK_THRESHOLD   │ 60점    │ 격국 성립 최소 강도                     │
 * │                     │         │ 60점 이하면 격국이 약한 것으로 판단     │
 * └────────────────────────────────────────────────────────────────────────┘
 *
 * 주의: 이 임계값들은 경험적 값으로, 모든 사주에 완벽히 적용되지 않을 수 있습니다.
 *       전문 명리학자와 상담 후 최종 판단을 권장합니다.
 *
 * ============================================================================
 */

import {
    천간, 지지, 천간오행, 지지오행, 십신표,
    type 천간타입, type 지지타입, type 오행타입, type 십신타입
} from './astro-data';
import { lookup희신기신, type LookupContext } from '../src/data/mapping-lookup';

// ============================================================================
// 특수격 판별 임계값 상수
// ============================================================================
// 이 값들은 파일 상단의 문서에서 설명된 근거에 따라 설정되었습니다.
// 전문가 검증 후 조정이 필요할 수 있습니다.

/**
 * 비겁 최소 개수 (종강격/종왕격 성립 조건)
 * 근거: 『자평진전』 - "비겁다자(比劫多者)" 조건
 */
const MIN_BIGEOP_COUNT = 2;

/**
 * 반대 세력 최대값 (관성/재성/식상)
 * 이 값을 초과하면 종격 불성립
 * 근거: 100점 만점 기준 약 30% 이하여야 순종 가능
 */
const MAX_OPPOSING_POWER = 30;

/**
 * 인성 최소 세력 (종왕격 성립 조건)
 * 근거: 인성이 비겁을 생조하여 왕성함을 더해야 함
 */
const MIN_INSUNG_POWER = 20;

/**
 * 격국 성립 최소 강도
 * 이 값 이하면 격국이 약한 것으로 판단
 */
const GEOKGUK_THRESHOLD = 60;

// ============================================================================
// 타입 정의
// ============================================================================
export type 정격타입 =
    | '정관격' | '편관격'
    | '정재격' | '편재격'
    | '식신격' | '상관격'
    | '정인격' | '편인격';

export type 특수격타입 =
    | '종강격' | '종왕격'
    | '화격' | '종화격'
    | '일행득기격';

export type 격국타입 = 정격타입 | 특수격타입 | '무격';

export interface 격국결과 {
    격국명: 격국타입;
    격국종류: '정격' | '특수격' | '무격';
    격국강도: number; // 0-100
    용신: 오행타입;
    희신: 오행타입[];
    기신: 오행타입[];
    격국함의: string;
    상세해석: {
        장점: string[];
        단점: string[];
        적합직업: string[];
        주의사항: string[];
    };
}

export interface 사주정보 {
    year: { gan: 천간타입; ji: 지지타입 };
    month: { gan: 천간타입; ji: 지지타입 };
    day: { gan: 천간타입; ji: 지지타입 };
    hour: { gan: 천간타입; ji: 지지타입 };
}

/**
 * 격국 분석 메인 함수
 */
export function analyze격국(사주: 사주정보): 격국결과 {

    // 1. 일간(日干) 추출 - 격국 판단의 기준
    const 일간 = 사주.day.gan;

    // 2. 월지(月支) 추출 - 격국 성립의 핵심
    const 월지 = 사주.month.ji;

    // 3. 월간(月干) 추출 - 격국 유무 판단
    const 월간 = 사주.month.gan;

    // 4. 특수격 검사 (특수격이 우선)
    const 특수격 = check특수격(사주);
    if (특수격) {
        return 특수격;
    }

    // 5. 정격 판별 (월간 기준)
    const 정격 = check정격(사주, 일간, 월간, 월지);
    if (정격) {
        return 정격;
    }

    // 6. 무격 (격국을 이루지 못한 경우)
    return create무격결과(사주);
}

/**
 * 정격 8종 판별
 * 월간(月干)의 십신(十神)으로 격국 판단
 */
function check정격(
    사주: 사주정보,
    일간: 천간타입,
    월간: 천간타입,
    월지: 지지타입
): 격국결과 | null {

    // 월간의 십신 확인
    const 월간십신 = 십신표[일간][월간];

    // 십신에 따른 격국 판별
    switch (월간십신) {
        case '정관':
            return create정관격(사주, 일간);
        case '편관':
            return create편관격(사주, 일간);
        case '정재':
            return create정재격(사주, 일간);
        case '편재':
            return create편재격(사주, 일간);
        case '식신':
            return create식신격(사주, 일간);
        case '상관':
            return create상관격(사주, 일간);
        case '정인':
            return create정인격(사주, 일간);
        case '편인':
            return create편인격(사주, 일간);
        default:
            return null;
    }
}

/**
 * 정관격 (正官格)
 * 월간이 정관일 때 성립
 * 특징: 정직, 책임감, 명예 중시
 */
function create정관격(사주: 사주정보, 일간: 천간타입): 격국결과 {
    const 일간오행 = 천간오행[일간];

    return {
        격국명: '정관격',
        격국종류: '정격',
        격국강도: calculate격국강도(사주, '정관'),
        용신: get용신(일간오행, '정관격'),
        희신: get희신(사주, 일간, '정관격'),
        기신: get기신(사주, 일간, '정관격'),
        격국함의: '정직하고 원칙을 중시하는 성품으로, 명예와 지위를 추구합니다. 공직, 관리직에 적합합니다.',
        상세해석: {
            장점: [
                '정직하고 성실한 성품',
                '책임감이 강하고 신뢰할 수 있음',
                '명예와 체면을 중시함',
                '조직 생활에 적합',
                '안정적인 사회생활'
            ],
            단점: [
                '융통성이 부족할 수 있음',
                '규칙과 틀에 얽매일 수 있음',
                '권위에 지나치게 의존',
                '변화에 대한 두려움'
            ],
            적합직업: [
                '공무원',
                '법조인',
                '회계사',
                '교사',
                '관리직',
                '금융권'
            ],
            주의사항: [
                '상관(傷官)을 조심하세요 - 정관을 해침',
                '편관(偏官)이 많으면 혼잡함',
                '재성(財星)의 생조가 필요함'
            ]
        }
    };
}

/**
 * 편관격 (偏官格, 칠살격)
 * 월간이 편관일 때 성립
 * 특징: 강인함, 추진력, 승부욕
 */
function create편관격(사주: 사주정보, 일간: 천간타입): 격국결과 {
    const 일간오행 = 천간오행[일간];

    return {
        격국명: '편관격',
        격국종류: '정격',
        격국강도: calculate격국강도(사주, '편관'),
        용신: get용신(일간오행, '편관격'),
        희신: get희신(사주, 일간, '편관격'),
        기신: get기신(사주, 일간, '편관격'),
        격국함의: '강인하고 추진력이 있으며, 승부욕이 강합니다. 경쟁적인 분야나 무력을 쓰는 직업에 적합합니다.',
        상세해석: {
            장점: [
                '강한 추진력과 실행력',
                '승부욕과 경쟁심이 강함',
                '위기 상황에서 강함',
                '리더십 발휘',
                '대담하고 용감함'
            ],
            단점: [
                '성격이 급하고 과격할 수 있음',
                '충동적인 결정',
                '권위적일 수 있음',
                '인내심 부족'
            ],
            적합직업: [
                '군인',
                '경찰',
                '운동선수',
                '사업가',
                '영업직',
                '정치인'
            ],
            주의사항: [
                '식신(食神)으로 제압이 필요함',
                '편관이 너무 강하면 흉함',
                '인성(印星)의 화해가 좋음'
            ]
        }
    };
}

/**
 * 정재격 (正財格)
 * 월간이 정재일 때 성립
 * 특징: 근면, 성실, 재물 축적
 */
function create정재격(사주: 사주정보, 일간: 천간타입): 격국결과 {
    const 일간오행 = 천간오행[일간];

    return {
        격국명: '정재격',
        격국종류: '정격',
        격국강도: calculate격국강도(사주, '정재'),
        용신: get용신(일간오행, '정재격'),
        희신: get희신(사주, 일간, '정재격'),
        기신: get기신(사주, 일간, '정재격'),
        격국함의: '근면하고 성실하며 재물을 잘 관리합니다. 안정적인 재물 축적에 능합니다.',
        상세해석: {
            장점: [
                '성실하고 근면한 성품',
                '돈 관리를 잘함',
                '안정적인 재물 축적',
                '가정적이고 책임감 있음',
                '검소하고 계획적'
            ],
            단점: [
                '지나치게 물질적일 수 있음',
                '인색할 수 있음',
                '융통성 부족',
                '모험을 꺼림'
            ],
            적합직업: [
                '회계사',
                '세무사',
                '은행원',
                '부동산',
                '일반 사업',
                '금융업'
            ],
            주의사항: [
                '비겁(比劫)을 조심하세요 - 재물을 탈취',
                '관성(官星)의 보호가 필요함',
                '신강(身强)이 필요함'
            ]
        }
    };
}

/**
 * 편재격 (偏財格)
 * 월간이 편재일 때 성립
 * 특징: 사교성, 활동성, 재물 유통
 */
function create편재격(사주: 사주정보, 일간: 천간타입): 격국결과 {
    const 일간오행 = 천간오행[일간];

    return {
        격국명: '편재격',
        격국종류: '정격',
        격국강도: calculate격국강도(사주, '편재'),
        용신: get용신(일간오행, '편재격'),
        희신: get희신(사주, 일간, '편재격'),
        기신: get기신(사주, 일간, '편재격'),
        격국함의: '사교적이고 활동적이며, 재물의 유통에 능합니다. 변화하는 재물에 강합니다.',
        상세해석: {
            장점: [
                '사교적이고 외향적',
                '돈을 버는 재주',
                '변화 대응 능력',
                '활동적이고 적극적',
                '사업 수완'
            ],
            단점: [
                '돈을 모으기 어려움',
                '낭비벽이 있을 수 있음',
                '정착하기 어려움',
                '여색(女色) 주의'
            ],
            적합직업: [
                '무역업',
                '중개업',
                '서비스업',
                '영업',
                '유통업',
                '장사'
            ],
            주의사항: [
                '비겁(比劫)이 많으면 재물 손실',
                '신강(身强)이 필수',
                '식상(食傷)의 생조가 좋음'
            ]
        }
    };
}

/**
 * 식신격 (食神格)
 * 월간이 식신일 때 성립
 * 특징: 여유, 예술, 표현력
 */
function create식신격(사주: 사주정보, 일간: 천간타입): 격국결과 {
    const 일간오행 = 천간오행[일간];

    return {
        격국명: '식신격',
        격국종류: '정격',
        격국강도: calculate격국강도(사주, '식신'),
        용신: get용신(일간오행, '식신격'),
        희신: get희신(사주, 일간, '식신격'),
        기신: get기신(사주, 일간, '식신격'),
        격국함의: '여유롭고 온화하며, 예술적 재능이 있습니다. 표현력과 창조력이 뛰어납니다.',
        상세해석: {
            장점: [
                '온화하고 여유로운 성품',
                '예술적 재능',
                '표현력이 뛰어남',
                '식복(食福)이 있음',
                '낙천적이고 긍정적'
            ],
            단점: [
                '게으를 수 있음',
                '현실감각 부족',
                '실천력 부족',
                '꿈만 꿀 수 있음'
            ],
            적합직업: [
                '예술가',
                '작가',
                '요리사',
                '교육자',
                '서비스업',
                '방송인'
            ],
            주의사항: [
                '편인(偏印)을 조심하세요 - 식신을 극함',
                '재성(財星)의 생조가 좋음',
                '너무 많으면 나태해짐'
            ]
        }
    };
}

/**
 * 상관격 (傷官格)
 * 월간이 상관일 때 성립
 * 특징: 재치, 비판력, 표현욕
 */
function create상관격(사주: 사주정보, 일간: 천간타입): 격국결과 {
    const 일간오행 = 천간오행[일간];

    return {
        격국명: '상관격',
        격국종류: '정격',
        격국강도: calculate격국강도(사주, '상관'),
        용신: get용신(일간오행, '상관격'),
        희신: get희신(사주, 일간, '상관격'),
        기신: get기신(사주, 일간, '상관격'),
        격국함의: '재치가 뛰어나고 표현력이 강하며, 비판적 사고를 가졌습니다. 예술과 기술 분야에 재능이 있습니다.',
        상세해석: {
            장점: [
                '뛰어난 재치와 표현력',
                '예술적 감각',
                '기술력이 뛰어남',
                '독창적 사고',
                '자유로운 영혼'
            ],
            단점: [
                '비판적이고 반항적',
                '인간관계 어려움',
                '권위 거부',
                '변덕스러울 수 있음'
            ],
            적합직업: [
                '예술가',
                '디자이너',
                '기술자',
                '프리랜서',
                '연구원',
                '평론가'
            ],
            주의사항: [
                '정관(正官)을 해침 - 직장 생활 어려움',
                '재성(財星)으로 설기(洩氣) 필요',
                '인성(印星)의 제압도 방법'
            ]
        }
    };
}

/**
 * 정인격 (正印格)
 * 월간이 정인일 때 성립
 * 특징: 학문, 지혜, 인내
 */
function create정인격(사주: 사주정보, 일간: 천간타입): 격국결과 {
    const 일간오행 = 천간오행[일간];

    return {
        격국명: '정인격',
        격국종류: '정격',
        격국강도: calculate격국강도(사주, '정인'),
        용신: get용신(일간오행, '정인격'),
        희신: get희신(사주, 일간, '정인격'),
        기신: get기신(사주, 일간, '정인격'),
        격국함의: '학문을 좋아하고 지혜로우며, 인내심이 강합니다. 모성애와 포용력이 있습니다.',
        상세해석: {
            장점: [
                '학문적 재능',
                '지혜롭고 사려 깊음',
                '인내심과 끈기',
                '모성애와 포용력',
                '신용과 명예 중시'
            ],
            단점: [
                '우유부단할 수 있음',
                '의존적 성향',
                '현실감각 부족',
                '고집이 셀 수 있음'
            ],
            적합직업: [
                '교수',
                '연구원',
                '교사',
                '의사',
                '종교인',
                '학자'
            ],
            주의사항: [
                '재성(財星)을 조심하세요 - 인성을 극함',
                '관성(官星)의 생조가 좋음',
                '너무 많으면 나태해짐'
            ]
        }
    };
}

/**
 * 편인격 (偏印格, 효신격)
 * 월간이 편인일 때 성립
 * 특징: 직관력, 신비, 변화
 */
function create편인격(사주: 사주정보, 일간: 천간타입): 격국결과 {
    const 일간오행 = 천간오행[일간];

    return {
        격국명: '편인격',
        격국종류: '정격',
        격국강도: calculate격국강도(사주, '편인'),
        용신: get용신(일간오행, '편인격'),
        희신: get희신(사주, 일간, '편인격'),
        기신: get기신(사주, 일간, '편인격'),
        격국함의: '직관력이 뛰어나고 신비로운 것을 좋아합니다. 변화를 추구하며 독특한 재능이 있습니다.',
        상세해석: {
            장점: [
                '뛰어난 직관력',
                '신비로운 것에 재능',
                '독특한 사고방식',
                '창의적 아이디어',
                '빠른 학습능력'
            ],
            단점: [
                '변덕스러울 수 있음',
                '고독을 선호',
                '현실 도피 경향',
                '식신(食神)을 극함'
            ],
            적합직업: [
                '역술가',
                '심리학자',
                '예술가',
                '연구원',
                '작가',
                '상담사'
            ],
            주의사항: [
                '식신(食神)을 해침 - 식복 손상',
                '재성(財星)의 제압이 필요',
                '너무 많으면 고독함'
            ]
        }
    };
}

/**
 * 특수격 검사
 */
function check특수격(사주: 사주정보): 격국결과 | null {
    // 종강격 검사
    const 종강격 = check종강격(사주);
    if (종강격) return 종강격;

    // 종왕격 검사
    const 종왕격 = check종왕격(사주);
    if (종왕격) return 종왕격;

    return null;
}

/**
 * 종강격 (從强格)
 * 일간이 너무 강해서 극단적으로 강한 경우
 *
 * 성립 조건:
 * 1. 일간이 월령에서 득령해야 함
 * 2. 비겁(比劫)이 많아야 함 (2개 이상)
 * 3. 관성(官星)과 재성(財星)이 약하거나 없어야 함
 *
 * TODO: 전문가 컨설팅 후 판별 조건 정확도 개선 필요
 */
function check종강격(사주: 사주정보): 격국결과 | null {
    const 일간 = 사주.day.gan;
    const 일간오행 = 천간오행[일간];
    const 월지 = 사주.month.ji;

    // ===== 1. 월령 득령 확인 =====
    const 득령여부 = check득령(일간오행, 월지);
    if (!득령여부) {
        return null; // 득령하지 못하면 종강격 불가
    }

    // ===== 2. 비겁 개수 확인 =====
    const 비겁개수 = count비겁(사주, 일간);
    if (비겁개수 < MIN_BIGEOP_COUNT) {
        // 파일 상단 상수 참조: MIN_BIGEOP_COUNT
        return null;
    }

    // ===== 3. 관성/재성 약함 확인 =====
    const 관성세력 = calculate관성세력(사주, 일간오행);
    const 재성세력 = calculate재성세력(사주, 일간오행);

    // 관성이나 재성이 너무 강하면 종강격 불가
    if (관성세력 > MAX_OPPOSING_POWER || 재성세력 > MAX_OPPOSING_POWER) {
        // 파일 상단 상수 참조: MAX_OPPOSING_POWER
        return null;
    }

    // ===== 4. 종강격 성립 - 격국결과 생성 =====
    return {
        격국명: '종강격',
        격국종류: '특수격',
        격국강도: calculate격국강도(사주, '비겁'),
        용신: 일간오행, // 종강격은 일간 자체가 용신
        희신: get희신(사주, 일간, '종강격'),
        기신: get기신(사주, 일간, '종강격'),
        격국함의: '강함을 따르는 격국으로, 강한 리더십과 추진력을 가지고 있습니다. 독립적이고 자기 주도적인 성향이 강합니다.',
        상세해석: {
            장점: [
                '강력한 리더십',
                '뛰어난 추진력',
                '독립적 성향',
                '자신감과 결단력',
                '어려움을 극복하는 힘'
            ],
            단점: [
                '독선적일 수 있음',
                '타협이 어려움',
                '고집이 셀 수 있음',
                '협력보다 단독 행동 선호'
            ],
            적합직업: [
                '경영자',
                '사업가',
                '정치인',
                '군인/경찰',
                '운동선수',
                '독립 전문직'
            ],
            주의사항: [
                '관성(官星)의 제압을 조심하세요',
                '재성(財星)이 너무 많으면 불리',
                '협력과 타협의 중요성 인식 필요',
                '독단적 결정을 자제할 필요'
            ]
        }
    };
}

/**
 * 종왕격 (從旺格)
 * 비겁이 많아 강한 기운을 따르는 경우
 *
 * 종강격과의 차이점:
 * - 종강격: 일간이 월령 득령 + 비겁 많음 (더 극단적)
 * - 종왕격: 비겁과 인성이 함께 많음 (비겁 생조)
 *
 * 성립 조건:
 * 1. 비겁(比劫)이 많아야 함 (2개 이상)
 * 2. 인성(印星)이 비겁을 생조해야 함 (1개 이상)
 * 3. 식상(食傷), 재성(財星), 관성(官星)이 약해야 함
 *
 * TODO: 전문가 컨설팅 후 종강격과의 차이 명확화 필요
 */
function check종왕격(사주: 사주정보): 격국결과 | null {
    const 일간 = 사주.day.gan;
    const 일간오행 = 천간오행[일간];

    // ===== 1. 비겁 개수 확인 =====
    const 비겁개수 = count비겁(사주, 일간);
    if (비겁개수 < MIN_BIGEOP_COUNT) {
        // 파일 상단 상수 참조: MIN_BIGEOP_COUNT
        return null;
    }

    // ===== 2. 인성 세력 확인 =====
    const 정인세력 = calculate십신세력(사주, 일간, '정인');
    const 편인세력 = calculate십신세력(사주, 일간, '편인');
    const 인성세력 = 정인세력 + 편인세력;

    if (인성세력 < MIN_INSUNG_POWER) {
        // 파일 상단 상수 참조: MIN_INSUNG_POWER
        return null;
    }

    // ===== 3. 식상/재성/관성 약함 확인 =====
    const 식상세력 = calculate십신세력(사주, 일간, '식신') + calculate십신세력(사주, 일간, '상관');
    const 재성세력 = calculate재성세력(사주, 일간오행);
    const 관성세력 = calculate관성세력(사주, 일간오행);

    // 식상/재성/관성이 너무 강하면 종왕격 불가
    if (식상세력 > MAX_OPPOSING_POWER || 재성세력 > MAX_OPPOSING_POWER || 관성세력 > MAX_OPPOSING_POWER) {
        // 파일 상단 상수 참조: MAX_OPPOSING_POWER
        return null;
    }

    // ===== 4. 종왕격 성립 - 격국결과 생성 =====
    return {
        격국명: '종왕격',
        격국종류: '특수격',
        격국강도: calculate격국강도(사주, '비겁') + (인성세력 / 10), // 인성 가산
        용신: 일간오행, // 종왕격도 일간 자체가 용신
        희신: get희신(사주, 일간, '종왕격'),
        기신: get기신(사주, 일간, '종왕격'),
        격국함의: '왕성함을 따르는 격국으로, 비겁과 인성의 생조를 받아 강한 힘을 발휘합니다. 협력과 네트워크를 통해 성공합니다.',
        상세해석: {
            장점: [
                '강한 추진력',
                '네트워크 활용 능력',
                '협력 관계에서 강함',
                '학습과 성장 능력',
                '인내심과 끈기'
            ],
            단점: [
                '의존적일 수 있음',
                '독립성 부족',
                '과도한 자신감',
                '타인 의견 경시'
            ],
            적합직업: [
                '협회/단체 리더',
                '교육자',
                '컨설턴트',
                '네트워크 비즈니스',
                '프랜차이즈 사업',
                '전문 기술직'
            ],
            주의사항: [
                '식상(食傷)이 강하면 불리 - 기운 분산',
                '재성(財星)이 많으면 소모됨',
                '관성(官星)의 제압 주의',
                '독립성과 협력의 균형 필요'
            ]
        }
    };
}

/**
 * 무격 결과 생성
 */
function create무격결과(사주: 사주정보): 격국결과 {
    return {
        격국명: '무격',
        격국종류: '무격',
        격국강도: 0,
        용신: '목',
        희신: [],
        기신: [],
        격국함의: '명확한 격국을 이루지 못한 사주입니다. 다양한 경험과 학습을 통해 자신의 길을 찾아야 합니다.',
        상세해석: {
            장점: [
                '다양한 가능성',
                '유연한 대응력',
                '폭넓은 적응력'
            ],
            단점: [
                '방향성 부족',
                '일관성 부족',
                '결단력 약함'
            ],
            적합직업: [
                '다양한 경험이 필요한 직업',
                '변화가 많은 업종'
            ],
            주의사항: [
                '자신만의 전문성 개발 필요',
                '꾸준한 노력이 중요',
                '멘토나 스승의 도움 필요'
            ]
        }
    };
}

/**
 * 격국 강도 계산
 * 0-100 사이의 값으로 격국의 완성도를 나타냄
 */
function calculate격국강도(사주: 사주정보, 격국십신: string): number {
    let 강도 = 50; // 기본 강도

    // 월지가 격국과 부합하는지 확인
    const 월지오행 = 지지오행[사주.month.ji];
    강도 += 10; // 월지 기본 가산점

    // 년지, 일지, 시지가 동일 오행이면 가산점
    const 년지오행 = 지지오행[사주.year.ji];
    const 일지오행 = 지지오행[사주.day.ji];
    const 시지오행 = 지지오행[사주.hour.ji];

    if (년지오행 === 월지오행) 강도 += 10;
    if (일지오행 === 월지오행) 강도 += 10;
    if (시지오행 === 월지오행) 강도 += 10;

    // 천간에 같은 십신이 있으면 가산점
    const 일간 = 사주.day.gan;
    const 년간십신 = 십신표[일간][사주.year.gan];
    const 시간십신 = 십신표[일간][사주.hour.gan];

    if (년간십신 === 격국십신) 강도 += 5;
    if (시간십신 === 격국십신) 강도 += 5;

    return Math.min(100, Math.max(0, 강도));
}

/**
 * 용신 결정
 * 용신(用神): 사주의 균형을 맞추는 핵심 오행
 *
 * 격국별 용신 이론:
 * - 정관격/편관격: 관성(官星) 자체가 용신 → 일간을 극하는 오행
 * - 정재격/편재격: 재성(財星) 자체가 용신 → 일간이 극하는 오행
 * - 식신격/상관격: 식상(食傷) 자체가 용신 → 일간이 생하는 오행
 * - 정인격/편인격: 인성(印星) 자체가 용신 → 일간을 생하는 오행
 */
function get용신(일간오행: 오행타입, 격국: string): 오행타입 {
    // 오행 상생상극 관계를 활용한 용신 결정
    const 상생관계 = { 목: '화', 화: '토', 토: '금', 금: '수', 수: '목' } as const;
    const 상극관계 = { 목: '토', 화: '금', 토: '수', 금: '목', 수: '화' } as const;

    // 일간을 극하는 오행 (관성)
    const 관성오행 = Object.entries(상극관계).find(([_, 피극]) => 피극 === 일간오행)?.[0] as 오행타입 || '금';
    // 일간이 생하는 오행 (식상)
    const 식상오행 = 상생관계[일간오행];
    // 일간을 생하는 오행 (인성)
    const 인성오행 = Object.entries(상생관계).find(([_, 생하는오행]) => 생하는오행 === 일간오행)?.[0] as 오행타입 || '수';
    // 일간이 극하는 오행 (재성)
    const 재성오행 = 상극관계[일간오행];

    const 용신표: Record<string, 오행타입> = {
        '정관격': 관성오행,
        '편관격': 관성오행,
        '정재격': 재성오행,
        '편재격': 재성오행,
        '식신격': 식상오행,
        '상관격': 식상오행,
        '정인격': 인성오행,
        '편인격': 인성오행
    };

    return 용신표[격국] || '목';
}

/**
 * 희신 결정
 * 희신(喜神): 용신을 돕는 오행들
 *
 * Phase 3.3: 80개 매핑 테이블 기반으로 희신 조회
 * - 일간과 격국에 따른 기본 매핑
 * - 사주 컨텍스트에 따른 예외상황 자동 감지
 * - 확신도 기반 결과 제공
 */
function get희신(사주: 사주정보, 일간: 천간타입, 격국: string): 오행타입[] {
    // 1. Context 생성
    const context = build조회컨텍스트(사주, 일간);

    // 2. 매핑 조회
    const result = lookup희신기신(일간, 격국, context);

    // 3. 결과 반환 (조회 실패 시 안전한 기본값)
    if (!result) {
        console.warn(`[get희신] 매핑 조회 실패: ${일간} + ${격국}, 기본값 사용`);
        // Fallback: 상생 이론 기반 기본값
        const 일간오행 = 천간오행[일간];
        return [일간오행]; // 일단 일간 오행 자체를 반환
    }

    return result.희신;
}

/**
 * 기신 결정
 * 기신(忌神): 해로운 오행들
 *
 * Phase 3.3: 80개 매핑 테이블 기반으로 기신 조회
 */
function get기신(사주: 사주정보, 일간: 천간타입, 격국: string): 오행타입[] {
    // 1. Context 생성
    const context = build조회컨텍스트(사주, 일간);

    // 2. 매핑 조회
    const result = lookup희신기신(일간, 격국, context);

    // 3. 결과 반환 (조회 실패 시 안전한 기본값)
    if (!result) {
        console.warn(`[get기신] 매핑 조회 실패: ${일간} + ${격국}, 기본값 사용`);
        // Fallback: 상극 이론 기반 기본값
        const 일간오행 = 천간오행[일간];
        return [일간오행]; // 일단 일간 오행 자체를 반환
    }

    return result.기신;
}

// ============================================
// 헬퍼 함수들
// ============================================

/**
 * 비겁(比劫) 개수 세기
 * 비견(比肩), 겁재(劫財)의 개수를 센다
 */
function count비겁(사주: 사주정보, 일간: 천간타입): number {
    let count = 0;

    // 년간 확인
    const 년간십신 = 십신표[일간][사주.year.gan];
    if (년간십신 === '비견' || 년간십신 === '겁재') {
        count++;
    }

    // 월간 확인
    const 월간십신 = 십신표[일간][사주.month.gan];
    if (월간십신 === '비견' || 월간십신 === '겁재') {
        count++;
    }

    // 시간 확인
    const 시간십신 = 십신표[일간][사주.hour.gan];
    if (시간십신 === '비견' || 시간십신 === '겁재') {
        count++;
    }

    return count;
}

/**
 * 식상(食傷) 개수 세기
 * 식신(食神), 상관(傷官)의 개수를 센다
 */
function count식상(사주: 사주정보, 일간: 천간타입): number {
    let count = 0;

    [사주.year.gan, 사주.month.gan, 사주.hour.gan].forEach(천간 => {
        const 십신 = 십신표[일간][천간];
        if (십신 === '식신' || 십신 === '상관') {
            count++;
        }
    });

    return count;
}

/**
 * 재성(財星) 개수 세기
 * 정재(正財), 편재(偏財)의 개수를 센다
 */
function count재성(사주: 사주정보, 일간: 천간타입): number {
    let count = 0;

    [사주.year.gan, 사주.month.gan, 사주.hour.gan].forEach(천간 => {
        const 십신 = 십신표[일간][천간];
        if (십신 === '정재' || 십신 === '편재') {
            count++;
        }
    });

    return count;
}

/**
 * 관성(官星) 개수 세기
 * 정관(正官), 편관(偏官/七殺)의 개수를 센다
 */
function count관성(사주: 사주정보, 일간: 천간타입): number {
    let count = 0;

    [사주.year.gan, 사주.month.gan, 사주.hour.gan].forEach(천간 => {
        const 십신 = 십신표[일간][천간];
        if (십신 === '정관' || 십신 === '편관') {
            count++;
        }
    });

    return count;
}

/**
 * 인성(印星) 개수 세기
 * 정인(正印), 편인(偏印)의 개수를 센다
 */
function count인성(사주: 사주정보, 일간: 천간타입): number {
    let count = 0;

    [사주.year.gan, 사주.month.gan, 사주.hour.gan].forEach(천간 => {
        const 십신 = 십신표[일간][천간];
        if (십신 === '정인' || 십신 === '편인') {
            count++;
        }
    });

    return count;
}

/**
 * 사주로부터 LookupContext 생성
 * 희신/기신 조회를 위한 컨텍스트 정보 구축
 */
function build조회컨텍스트(사주: 사주정보, 일간: 천간타입): LookupContext {
    const 비겁개수 = count비겁(사주, 일간);
    const 식상개수 = count식상(사주, 일간);
    const 재성개수 = count재성(사주, 일간);
    const 관성개수 = count관성(사주, 일간);
    const 인성개수 = count인성(사주, 일간);

    // 일간 강약 추정
    let 일간강약: '태왕' | '왕' | '중화' | '약' | '극약';
    const 생조개수 = 비겁개수 + 인성개수;

    if (생조개수 >= 5) 일간강약 = '태왕';
    else if (생조개수 >= 4) 일간강약 = '왕';
    else if (생조개수 >= 2) 일간강약 = '중화';
    else if (생조개수 >= 1) 일간강약 = '약';
    else 일간강약 = '극약';

    // 투출 천간 목록
    const 투출천간 = [
        사주.year.gan,
        사주.month.gan,
        사주.hour.gan
    ].filter((천간, idx, arr) => arr.indexOf(천간) === idx); // 중복 제거

    return {
        일간강약,
        월령천간: 사주.month.gan,
        투출천간,
        비겁개수,
        식상개수,
        재성개수,
        관성개수,
        인성개수
    };
}

/**
 * 월령 득령(得令) 확인
 * 일간이 월지에서 힘을 얻는지 확인
 */
function check득령(일간오행: 오행타입, 월지: 지지타입): boolean {
    const 월지오행 = 지지오행[월지];

    // 득령 테이블: 각 오행이 왕성한 계절(지지)
    const 득령표: Record<오행타입, 지지타입[]> = {
        '목': ['인', '묘', '진'],    // 봄 (寅卯辰)
        '화': ['사', '오', '미'],    // 여름 (巳午未)
        '토': ['진', '술', '축', '미'],  // 사계(四季)
        '금': ['신', '유', '술'],    // 가을 (申酉戌)
        '수': ['해', '자', '축']     // 겨울 (亥子丑)
    };

    return 득령표[일간오행].includes(월지);
}

/**
 * 특정 십신의 세력 계산
 * 천간에서 해당 십신의 강도를 0-100으로 계산
 */
function calculate십신세력(
    사주: 사주정보,
    일간: 천간타입,
    대상십신: 십신타입
): number {
    let 세력 = 0;

    // 년간 확인 (20점)
    if (십신표[일간][사주.year.gan] === 대상십신) {
        세력 += 20;
    }

    // 월간 확인 (30점 - 가장 중요)
    if (십신표[일간][사주.month.gan] === 대상십신) {
        세력 += 30;
    }

    // 시간 확인 (20점)
    if (십신표[일간][사주.hour.gan] === 대상십신) {
        세력 += 20;
    }

    return 세력;
}

/**
 * 관성(官星) 세력 계산
 * 정관 + 편관의 총 세력
 */
function calculate관성세력(사주: 사주정보, 일간오행: 오행타입): number {
    const 일간 = 사주.day.gan;
    const 정관세력 = calculate십신세력(사주, 일간, '정관');
    const 편관세력 = calculate십신세력(사주, 일간, '편관');
    return 정관세력 + 편관세력;
}

/**
 * 재성(財星) 세력 계산
 * 정재 + 편재의 총 세력
 */
function calculate재성세력(사주: 사주정보, 일간오행: 오행타입): number {
    const 일간 = 사주.day.gan;
    const 정재세력 = calculate십신세력(사주, 일간, '정재');
    const 편재세력 = calculate십신세력(사주, 일간, '편재');
    return 정재세력 + 편재세력;
}

/**
 * 격국 통계 정보
 */
export function get격국통계(): Record<격국타입, string> {
    return {
        '정관격': '정직하고 명예로운 삶',
        '편관격': '강인하고 역동적인 삶',
        '정재격': '안정적이고 근면한 삶',
        '편재격': '활동적이고 사교적인 삶',
        '식신격': '여유롭고 예술적인 삶',
        '상관격': '창의적이고 자유로운 삶',
        '정인격': '학문적이고 지혜로운 삶',
        '편인격': '신비롭고 독특한 삶',
        '종강격': '극단적으로 강한 기질',
        '종왕격': '비겁이 많은 구조',
        '화격': '특수한 조화',
        '종화격': '특별한 균형',
        '일행득기격': '한 오행이 극강',
        '무격': '정해진 틀 없는 삶'
    };
}
