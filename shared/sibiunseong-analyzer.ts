// 십이운성 분석 시스템
// 12 Life Stages Analysis System

import type { 천간타입, 지지타입, 오행타입 } from './astro-data';

export interface 사주정보 {
  year: { gan: 천간타입; ji: 지지타입 };
  month: { gan: 천간타입; ji: 지지타입 };
  day: { gan: 천간타입; ji: 지지타입 };
  hour: { gan: 천간타입; ji: 지지타입 };
}

/**
 * 십이운성 (12 Life Stages)
 * 일간(日干)과 각 지지(地支)의 관계를 12가지 생명 단계로 표현
 */
export type 십이운성타입 =
  | '장생' // 長生: 탄생, 시작
  | '목욕' // 沐浴: 성장, 변화
  | '관대' // 冠帶: 성년, 성숙
  | '건록' // 建祿: 왕성, 전성기
  | '제왕' // 帝旺: 최고점, 정점
  | '쇠'   // 衰: 쇠퇴 시작
  | '병'   // 病: 약화
  | '사'   // 死: 정지
  | '묘'   // 墓: 저장, 잠복
  | '절'   // 絶: 소멸
  | '태'   // 胎: 잉태, 준비
  | '양';  // 養: 양육, 성장

/**
 * 십이운성 결과 인터페이스
 */
export interface 십이운성결과 {
  년주십이운성: {
    운성: 십이운성타입;
    강도: number;
    해석: string;
  };
  월주십이운성: {
    운성: 십이운성타입;
    강도: number;
    해석: string;
  };
  일주십이운성: {
    운성: 십이운성타입;
    강도: number;
    해석: string;
  };
  시주십이운성: {
    운성: 십이운성타입;
    강도: number;
    해석: string;
  };
  전체평가: {
    주요운성: 십이운성타입[];
    생애에너지: number; // 0-100
    종합해석: string;
  };
}

/**
 * 십이운성 순서표 (일간 오행별)
 * 각 오행은 특정 지지에서 장생을 시작하여 12단계를 순환
 */
const 십이운성순서: Record<오행타입, Record<지지타입, 십이운성타입>> = {
  목: {
    해: '장생', 자: '목욕', 축: '관대', 인: '건록', 묘: '제왕', 진: '쇠',
    사: '병', 오: '사', 미: '묘', 신: '절', 유: '태', 술: '양'
  },
  화: {
    인: '장생', 묘: '목욕', 진: '관대', 사: '건록', 오: '제왕', 미: '쇠',
    신: '병', 유: '사', 술: '묘', 해: '절', 자: '태', 축: '양'
  },
  토: {
    인: '장생', 묘: '목욕', 진: '관대', 사: '건록', 오: '제왕', 미: '쇠',
    신: '병', 유: '사', 술: '묘', 해: '절', 자: '태', 축: '양'
  },
  금: {
    사: '장생', 오: '목욕', 미: '관대', 신: '건록', 유: '제왕', 술: '쇠',
    해: '병', 자: '사', 축: '묘', 인: '절', 묘: '태', 진: '양'
  },
  수: {
    신: '장생', 유: '목욕', 술: '관대', 해: '건록', 자: '제왕', 축: '쇠',
    인: '병', 묘: '사', 진: '묘', 사: '절', 오: '태', 미: '양'
  }
};

/**
 * 십이운성 강도표
 */
const 십이운성강도: Record<십이운성타입, number> = {
  장생: 70,
  목욕: 50,
  관대: 80,
  건록: 90,
  제왕: 100,
  쇠: 40,
  병: 20,
  사: 10,
  묘: 30,
  절: 5,
  태: 60,
  양: 65
};

/**
 * 십이운성 상세 해석
 */
const 십이운성해석: Record<십이운성타입, {
  기본의미: string;
  성격특성: string;
  인생국면: string;
  주의사항: string;
}> = {
  장생: {
    기본의미: '새로운 생명의 탄생, 시작의 에너지',
    성격특성: '생동감 넘치고 적극적이며 새로운 시도를 즐김',
    인생국면: '새로운 기회와 시작이 많은 시기, 성장 가능성 높음',
    주의사항: '너무 많은 것을 시작하여 집중력이 분산될 수 있음'
  },
  목욕: {
    기본의미: '정화와 변화, 성장통의 시기',
    성격특성: '감수성이 풍부하고 변화에 민감하며 유연함',
    인생국면: '급격한 변화와 성장의 시기, 불안정하지만 발전적',
    주의사항: '감정 기복이 크고 유혹에 약할 수 있음'
  },
  관대: {
    기본의미: '성년식, 사회 진출의 단계',
    성격특성: '책임감이 강하고 체계적이며 성숙함',
    인생국면: '사회적 위치 확립, 안정적 발전 시기',
    주의사항: '체면과 외형에 집착할 수 있음'
  },
  건록: {
    기본의미: '왕성한 활동력, 전성기의 시작',
    성격특성: '추진력과 실행력이 뛰어나며 자신감 넘침',
    인생국면: '능력을 최대한 발휘하는 전성기, 성취의 시기',
    주의사항: '과도한 자신감으로 무리할 수 있음'
  },
  제왕: {
    기본의미: '최고의 정점, 극성의 에너지',
    성격특성: '카리스마와 리더십이 강하며 독립적',
    인생국면: '인생의 정점, 최고의 영향력 발휘',
    주의사항: '독선적이 되거나 하강을 준비해야 함'
  },
  쇠: {
    기본의미: '쇠퇴의 시작, 내적 성찰의 시기',
    성격특성: '차분하고 신중하며 경험을 중시함',
    인생국면: '외적 활동보다 내실을 다지는 시기',
    주의사항: '의욕 저하와 소극적 태도 주의'
  },
  병: {
    기본의미: '약화와 휴식, 치유의 필요',
    성격특성: '섬세하고 조심스러우며 건강에 민감',
    인생국면: '휴식과 재충전이 필요한 시기',
    주의사항: '건강 관리 필수, 과로 금물'
  },
  사: {
    기본의미: '정지와 전환, 끝과 새 시작의 경계',
    성격특성: '내향적이고 사색적이며 정신적',
    인생국면: '한 단계의 마무리, 전환 준비',
    주의사항: '우울감 주의, 새로운 방향 모색 필요'
  },
  묘: {
    기본의미: '저장과 잠복, 에너지 축적',
    성격특성: '내실을 다지고 준비하며 인내심 강함',
    인생국면: '표면적으론 조용하나 내적 준비 시기',
    주의사항: '답답함을 느낄 수 있으나 준비의 시간'
  },
  절: {
    기본의미: '소멸과 재생 직전, 극한의 시련',
    성격특성: '위기 대처 능력이 있으며 생존력 강함',
    인생국면: '가장 어려운 시기이나 재생의 전조',
    주의사항: '절망하지 말고 희망을 유지해야 함'
  },
  태: {
    기본의미: '새로운 잉태, 미래의 준비',
    성격특성: '미래 지향적이고 계획적이며 희망적',
    인생국면: '새로운 가능성이 생기는 시기',
    주의사항: '아직 초기 단계, 서두르지 말 것'
  },
  양: {
    기본의미: '양육과 성장, 발전의 기반',
    성격특성: '꾸준하고 성실하며 발전적',
    인생국면: '기반을 다지며 점진적 성장하는 시기',
    주의사항: '급한 성과를 바라지 말고 착실히'
  }
};

/**
 * 일간의 오행 추출
 */
function get일간오행(일간: 천간타입): 오행타입 {
  const 천간오행: Record<천간타입, 오행타입> = {
    갑: '목', 을: '목',
    병: '화', 정: '화',
    무: '토', 기: '토',
    경: '금', 신: '금',
    임: '수', 계: '수'
  };
  return 천간오행[일간];
}

/**
 * 특정 지지에서의 십이운성 계산
 */
function calculate십이운성(일간: 천간타입, 지지: 지지타입): 십이운성타입 {
  const 일간오행 = get일간오행(일간);
  return 십이운성순서[일간오행][지지];
}

/**
 * 십이운성별 상세 해석 생성
 */
function get십이운성상세해석(운성: 십이운성타입, 주: string): string {
  const 해석 = 십이운성해석[운성];
  return `${주}에 ${운성}(${십이운성강도[운성]}점): ${해석.기본의미}. ${해석.성격특성} ${해석.인생국면}`;
}

/**
 * 전체 십이운성 종합 분석
 */
function analyze전체십이운성(
  년운성: 십이운성타입,
  월운성: 십이운성타입,
  일운성: 십이운성타입,
  시운성: 십이운성타입
): { 주요운성: 십이운성타입[]; 생애에너지: number; 종합해석: string } {
  const 운성들 = [년운성, 월운성, 일운성, 시운성];
  const 강도들 = 운성들.map(운성 => 십이운성강도[운성]);
  const 평균강도 = 강도들.reduce((a, b) => a + b, 0) / 4;

  // 주요 운성 추출 (강도 70 이상)
  const 주요운성 = 운성들.filter(운성 => 십이운성강도[운성] >= 70);

  // 종합 해석 생성
  let 종합해석 = '';

  if (평균강도 >= 70) {
    종합해석 = '전반적으로 강한 생명 에너지를 가지고 있습니다. 왕성한 활동력과 추진력으로 목표를 달성할 수 있는 사주입니다. ';
  } else if (평균강도 >= 50) {
    종합해석 = '적절한 생명 에너지를 보유하고 있습니다. 꾸준한 노력으로 안정적인 발전이 가능한 사주입니다. ';
  } else if (평균강도 >= 30) {
    종합해석 = '생명 에너지가 다소 약한 편입니다. 무리하지 않고 내실을 다지는 것이 중요합니다. ';
  } else {
    종합해석 = '생명 에너지가 약한 편입니다. 건강 관리와 휴식이 매우 중요하며, 급한 성과보다는 장기적 계획이 필요합니다. ';
  }

  // 특수 조합 분석
  if (주요운성.includes('제왕') && 주요운성.includes('건록')) {
    종합해석 += '제왕과 건록이 함께하여 강력한 추진력을 가지고 있습니다. 리더십을 발휘할 기회가 많습니다. ';
  }

  if (운성들.includes('장생') && 운성들.includes('태')) {
    종합해석 += '장생과 태가 있어 새로운 시작과 성장의 기운이 강합니다. ';
  }

  if (운성들.filter(운성 => ['병', '사', '묘', '절'].includes(운성)).length >= 2) {
    종합해석 += '약한 운성이 많아 건강 관리와 휴식에 특별히 신경 써야 합니다. 무리한 계획보다는 현실적 목표 설정이 중요합니다.';
  }

  return {
    주요운성,
    생애에너지: Math.round(평균강도),
    종합해석
  };
}

/**
 * 십이운성 종합 분석 함수
 */
export function analyze십이운성(사주: 사주정보): 십이운성결과 {
  const 일간 = 사주.day.gan;

  // 각 주별 십이운성 계산
  const 년운성 = calculate십이운성(일간, 사주.year.ji);
  const 월운성 = calculate십이운성(일간, 사주.month.ji);
  const 일운성 = calculate십이운성(일간, 사주.day.ji);
  const 시운성 = calculate십이운성(일간, 사주.hour.ji);

  // 전체 평가
  const 전체평가 = analyze전체십이운성(년운성, 월운성, 일운성, 시운성);

  return {
    년주십이운성: {
      운성: 년운성,
      강도: 십이운성강도[년운성],
      해석: get십이운성상세해석(년운성, '년주')
    },
    월주십이운성: {
      운성: 월운성,
      강도: 십이운성강도[월운성],
      해석: get십이운성상세해석(월운성, '월주')
    },
    일주십이운성: {
      운성: 일운성,
      강도: 십이운성강도[일운성],
      해석: get십이운성상세해석(일운성, '일주')
    },
    시주십이운성: {
      운성: 시운성,
      강도: 십이운성강도[시운성],
      해석: get십이운성상세해석(시운성, '시주')
    },
    전체평가
  };
}
