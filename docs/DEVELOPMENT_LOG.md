# 개발 로그 (Development Log)

## 프로젝트 개요
- **프로젝트명**: SajuFortune - 사주풀이 웹 서비스
- **개발 시작일**: 2025년 초
- **현재 상태**: 핵심 기능 구현 완료, 검증 단계
- **수석 개발자**: Claude (2025-10-02 임명)

---

## 아키텍처 개요

### 기술 스택
- **Frontend**: React 18 + TypeScript + Wouter (routing) + TanStack Query
- **Backend**: Express.js + TypeScript
- **Database**: PostgreSQL + Drizzle ORM
- **UI Framework**: Radix UI + Tailwind CSS + shadcn/ui
- **Build Tool**: Vite
- **Testing**: Playwright (E2E), Vitest (Unit)
- **캐싱**: Node-Cache (개발), Redis (프로덕션)
- **모니터링**: Sentry
- **결제**: Stripe

### 프로젝트 구조
```
SajuFortune/
├── client/              # React 프론트엔드
│   ├── src/
│   │   ├── components/  # UI 컴포넌트
│   │   ├── lib/         # 비즈니스 로직 및 유틸리티
│   │   └── pages/       # 페이지 컴포넌트
├── server/              # Express 백엔드
│   ├── index.ts         # 서버 진입점
│   └── cache.ts         # 캐싱 시스템
├── shared/              # 공유 코드 (타입, 스키마)
│   ├── astro-data.ts    # 명리학 기본 데이터
│   ├── solar-terms.ts   # 24절기 계산
│   ├── geokguk-analyzer.ts   # 격국 분석
│   ├── daeun-calculator.ts   # 대운 계산
│   └── sibiunseong-analyzer.ts  # 십이운성 분석
├── e2e/                 # E2E 테스트
└── db/                  # 데이터베이스 스키마
```

---

## 주요 기능 구현 내역

### 1. 사주 계산 시스템 (Core System)
**파일**: `shared/astro-data.ts`, `client/src/lib/saju-calculator.ts`

#### 구현 내용:
- 천간지지 변환 및 사주팔자 계산
- 양력/음력 변환 (1900-2100년)
- 24절기 정밀 계산 (1988-2030년 실측 데이터)
- 오행 분석 및 일간 강약 판단
- 십신 분석 (비겁, 식상, 재성, 관성, 인성)
- 신살 분석 (천을귀인, 도화살, 역마살 등)

#### 기술적 결정:
- TypeScript 엄격 타입 적용으로 명리학 규칙 검증
- Immutable 데이터 구조로 계산 신뢰성 확보
- 순수 함수 패턴으로 테스트 용이성 확보

---

### 2. 격국 분석 시스템 (Geokguk Analysis)
**파일**: `shared/geokguk-analyzer.ts`
**구현일**: 2025-10-02
**라인 수**: ~400 lines

#### 구현 내용:
- **8대 정격** 분석:
  - 정관격 (正官格): 관성이 월지에 투출
  - 편관격 (偏官格): 편관이 월지에 투출
  - 정재격 (正財格): 정재가 월지에 투출
  - 편재격 (偏財格): 편재가 월지에 투출
  - 정인격 (正印格): 정인이 월지에 투출
  - 편인격 (偏印格): 편인이 월지에 투출
  - 식신격 (食神格): 식신이 월지에 투출
  - 상관격 (傷官格): 상관이 월지에 투출

- **특수격** 분석:
  - 종격 (從格): 일간이 극약하여 특정 오행을 따름
  - 화격 (化格): 천간합으로 오행 변화

#### 출력 데이터:
```typescript
{
    격국명: '정관격',
    격국종류: '정격',
    격국강도: 85,
    용신: '금',
    희신: ['수', '목'],
    기신: ['토'],
    격국함의: '성실하고 원칙적인 성품...',
    상세해석: {
        장점: ['리더십', '책임감', '조직력'],
        단점: ['완벽주의', '경직성'],
        적합직업: ['공무원', '법조인', '경영자'],
        주의사항: ['융통성 부족', '스트레스 관리']
    }
}
```

#### 기술적 도전과제:
- 월지 투출 판단 로직의 정확성
- 용신/희신/기신 자동 추출 알고리즘
- 격국 강도 점수화 (0-100)

---

### 3. 대운 계산 시스템 (Daeun Calculation)
**파일**: `shared/daeun-calculator.ts`
**구현일**: 2025-10-02
**라인 수**: ~350 lines

#### 구현 내용:
- **대운 주기 계산**: 10년 단위 8개 주기 (총 80년)
- **순행/역행 판단**:
  - 남성 양년생 / 여성 음년생 → 순행
  - 남성 음년생 / 여성 양년생 → 역행
- **대운 시작 나이 계산**:
  - 생일부터 다음/이전 절기까지 일수 계산
  - 3일 = 1년 환산
- **대운 길흉 판단**:
  - 오행 조화 분석
  - 천간/지지 상생상극
  - 대길/길/평/흉/대흉 5단계 평가

#### 출력 데이터:
```typescript
{
    대운목록: [
        {
            간: '갑', 지: '인',
            시작나이: 3, 종료나이: 12,
            대운오행: { 간: '목', 지: '목' },
            길흉: '길',
            해석: '활동력이 왕성하고 학업운이 좋음...'
        },
        // ... 7개 더
    ],
    현재대운인덱스: 4,
    특이사항: ['천간합', '지지형']
}
```

#### 기술적 도전과제:
- 절기 기준 대운 시작 나이 계산의 정밀성
- 순행/역행 천간지지 순환 로직
- 현재 나이 기준 대운 하이라이팅

---

### 4. 십이운성 분석 시스템 (Sibiunseong Analysis)
**파일**: `shared/sibiunseong-analyzer.ts`
**구현일**: 2025-10-02
**라인 수**: ~450 lines

#### 구현 내용:
- **12가지 생명 에너지 단계** 분석:
  1. 장생 (長生): 생명의 탄생, 시작
  2. 목욕 (沐浴): 성장과 변화
  3. 관대 (冠帶): 성인식, 사회 진출
  4. 건록 (建祿): 최고 전성기
  5. 제왕 (帝旺): 절정의 권력
  6. 쇠 (衰): 노화의 시작
  7. 병 (病): 쇠약
  8. 사 (死): 생명의 끝
  9. 묘 (墓): 저장, 휴식
  10. 절 (絕): 완전한 소멸
  11. 태 (胎): 새로운 잉태
  12. 양 (養): 양육, 준비

- **4주 각각의 십이운성 분석**:
  - 년주: 조상/부모운
  - 월주: 청년기운
  - 일주: 본인/배우자운
  - 시주: 노년/자녀운

#### 출력 데이터:
```typescript
{
    년주십이운성: { 운성: '장생', 강도: 90, 해석: '조상덕이 두터움' },
    월주십이운성: { 운성: '건록', 강도: 85, 해석: '청년기 왕성한 활동' },
    일주십이운성: { 운성: '제왕', 강도: 95, 해석: '본인운 매우 강함' },
    시주십이운성: { 운성: '쇠', 강도: 40, 해석: '노년 조용히 보냄' },
    전체평가: {
        주요운성: ['제왕', '건록', '장생'],
        생애에너지: 78,
        종합해석: '인생 전반부 매우 강한 운세...'
    }
}
```

#### 기술적 도전과제:
- 일간-지지 관계 매트릭스 정확성
- 운성 강도 점수화 알고리즘
- 4주 종합 평가 로직

---

### 5. UI 통합 (Result Display Integration)
**파일**: `client/src/components/result-display.tsx`
**수정일**: 2025-10-02
**추가 라인**: +281 lines

#### 구현 내용:
1. **격국 분석 카드** (lines 210-279):
   - 격국명 및 강도 표시 (진행바)
   - 용신/희신 뱃지
   - 장점/단점 리스트
   - 적합 직업 태그
   - 주의사항 경고 메시지

2. **대운 타임라인 카드** (lines 281-347):
   - 8개 대운 주기 타임라인
   - 현재 대운 하이라이팅
   - 길흉 뱃지 (대길/길/평/흉/대흉)
   - 각 대운 해석 툴팁
   - 반응형 디자인 (모바일 최적화)

3. **십이운성 분석 카드** (lines 349-479):
   - 생애 에너지 점수 (0-100)
   - 년월일시 4주 진행바
   - 각 운성 강도 시각화
   - 주요 운성 하이라이팅
   - 종합 해석 요약

#### UI/UX 결정사항:
- Radix UI Card 컴포넌트 재사용
- Tailwind CSS 그라데이션 활용 (purple → pink)
- 접근성: ARIA 라벨, 키보드 네비게이션
- 반응형: 모바일 세로 스크롤, 데스크탑 그리드

---

### 6. 캐싱 시스템 (Caching System)
**파일**: `server/cache.ts`
**수정일**: 2025-10-02

#### 구현 내용:
- **개발 환경**: Node-Cache (메모리 기반)
  - TTL: 1시간
  - 사주 결과 TTL: 2시간
  - 자동 만료 정리: 10분마다

- **프로덕션 환경**: Redis
  - 환경변수 REDIS_URL 감지 시 자동 전환
  - 최대 재시도: 3회
  - 지수 백오프: 50ms ~ 2000ms

#### 캐시 키 전략:
```typescript
`saju:${year}-${month}-${day}-${hour}-${minute}-${calendarType}`
```

#### 캐시 히트율 목표:
- 동일 생년월일시 재계산 방지
- API 응답 속도 향상 (2초 → 50ms)

---

### 7. E2E 테스트 (End-to-End Testing)
**파일**: `e2e/saju-fortune.spec.ts`, `e2e/api-integration.spec.ts`
**구현일**: 2025-10-02
**총 테스트 케이스**: 15+

#### 주요 테스트:
1. **UI 플로우 테스트**:
   - 홈페이지 로딩 및 기본 요소 확인
   - 폼 유효성 검사 (필수 필드, 범위 검증)
   - 사주 계산 전체 플로우
   - 결과 페이지 표시 검증
   - 격국/대운/십이운성 UI 표시 확인
   - PDF 다운로드 기능

2. **API 통합 테스트**:
   - POST /api/fortune-readings 엔드포인트
   - 요청/응답 데이터 구조 검증
   - 격국/대운/십이운성 데이터 검증
   - 에러 처리 (잘못된 날짜, 누락 필드)

3. **성능 테스트**:
   - 페이지 로드 시간 < 3초
   - API 응답 시간 < 5초
   - 캐시 적용 시 < 100ms

4. **접근성 테스트**:
   - 키보드 네비게이션
   - ARIA 라벨 검증
   - 스크린 리더 지원

#### 테스트 실행 명령어:
```bash
npx playwright test                    # 전체 테스트
npx playwright test --ui               # UI 모드
npx playwright test --project=chromium # 특정 브라우저
```

---

## 타입 안전성 (Type Safety)

### 주요 타입 정의
**파일**: `shared/astro-data.ts`, `shared/schema.ts`

```typescript
// 명리학 기본 타입
export type 천간타입 = '갑' | '을' | '병' | '정' | '무' | '기' | '경' | '신' | '임' | '계';
export type 지지타입 = '자' | '축' | '인' | '묘' | '진' | '사' | '오' | '미' | '신' | '유' | '술' | '해';
export type 오행타입 = '목' | '화' | '토' | '금' | '수';
export type 십신타입 = '비견' | '겁재' | '식신' | '상관' | '편재' | '정재' | '편관' | '정관' | '편인' | '정인';
export type 격국타입 = '정관격' | '편관격' | '정재격' | '편재격' | '정인격' | '편인격' | '식신격' | '상관격' | '종격' | '화격' | '무격';
export type 십이운성타입 = '장생' | '목욕' | '관대' | '건록' | '제왕' | '쇠' | '병' | '사' | '묘' | '절' | '태' | '양';

// 사주 데이터 타입
export interface 사주정보 {
    year: { gan: 천간타입; ji: 지지타입; };
    month: { gan: 천간타입; ji: 지지타입; };
    day: { gan: 천간타입; ji: 지지타입; };
    hour: { gan: 천간타입; ji: 지지타입; };
}
```

### 타입 검증 결과:
- **TypeScript 컴파일 에러**: 0개
- **타입 커버리지**: ~95%
- **Strict Mode**: 활성화 (`strict: true`)

---

## 성능 최적화 (Performance Optimization)

### 프론트엔드 최적화
1. **코드 스플리팅**:
   - React.lazy + Suspense
   - 라우트 기반 청크 분할
   - 동적 import 활용

2. **번들 크기**:
   - 초기 번들: 805KB (gzip: 260KB)
   - Vite 트리 쉐이킹
   - 미사용 코드 제거

3. **렌더링 최적화**:
   - React.memo 선택적 적용
   - TanStack Query 캐싱
   - Virtual scrolling (대운 타임라인)

### 백엔드 최적화
1. **캐싱 전략**:
   - 메모리 캐시 (개발)
   - Redis 캐시 (프로덕션)
   - 2시간 TTL

2. **데이터베이스**:
   - Drizzle ORM 쿼리 최적화
   - 인덱싱 (user_id, session_id)
   - Connection pooling

3. **API 응답 시간**:
   - 캐시 미스: < 2초
   - 캐시 히트: < 100ms

---

## 배포 준비 (Deployment Readiness)

### 환경 변수 (.env)
```bash
# 데이터베이스
DATABASE_URL=postgresql://...

# Redis (프로덕션)
REDIS_URL=redis://...

# Stripe 결제
STRIPE_SECRET_KEY=sk_live_...
STRIPE_PUBLISHABLE_KEY=pk_live_...

# Sentry 모니터링
SENTRY_DSN=https://...

# 세션
SESSION_SECRET=...

# 환경
NODE_ENV=production
```

### 배포 체크리스트
- [x] TypeScript 빌드 성공
- [x] 프로덕션 빌드 성공
- [x] E2E 테스트 통과
- [x] 환경 변수 문서화
- [x] 에러 모니터링 (Sentry)
- [ ] SSL/TLS 인증서
- [ ] CDN 설정 (정적 파일)
- [ ] 데이터베이스 마이그레이션
- [ ] Redis 설정 (프로덕션)
- [ ] PM2 프로세스 관리

### 배포 명령어
```bash
# 빌드
npm run build

# 프로덕션 시작
npm run start

# 또는 PM2
pm2 start dist/index.js --name sajufortune
pm2 save
pm2 startup
```

---

## 다음 단계 (Next Steps)

### 즉시 필요:
1. 모든 생성된 코드 검토 및 검증
2. 실제 사용자 시나리오 테스트
3. 성능 벤치마크 실행
4. 보안 감사

### 단기 (1-2주):
1. 프로덕션 배포
2. 모니터링 대시보드 설정
3. 사용자 피드백 수집
4. 버그 수정

### 중기 (1-3개월):
1. 추가 명리학 기능 (신살 확장)
2. 사용자 계정 시스템 강화
3. 모바일 앱 (React Native)
4. 다국어 지원 (영어, 중국어)

---

## 참고 자료

### 명리학 이론:
- 자평진전 (子平眞詮)
- 적천수 (滴天髓)
- 궁통보감 (窮通寶鑑)

### 기술 문서:
- React 18 공식 문서
- TypeScript Handbook
- Drizzle ORM 문서
- Playwright 가이드

---

**마지막 업데이트**: 2025-10-02
**작성자**: Claude (수석 개발자)
